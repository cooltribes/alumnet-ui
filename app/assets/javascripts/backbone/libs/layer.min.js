/*! layer-websdk - v2.0.4 - 2016-10-03 */ !function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.layer=a()}}(function(){var a;return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";b.exports={Root:a("./src/root"),Client:a("./src/client"),ClientAuthenticator:a("./src/client-authenticator"),Syncable:a("./src/syncable"),Conversation:a("./src/conversation"),Message:a("./src/message"),Announcement:a("./src/announcement"),MessagePart:a("./src/message-part"),Query:a("./src/query"),QueryBuilder:a("./src/query-builder"),xhr:a("./src/xhr"),LayerError:a("./src/layer-error"),LayerEvent:a("./src/layer-event"),Content:a("./src/content"),SyncManager:a("./src/sync-manager"),SyncEvent:a("./src/sync-event").SyncEvent,XHRSyncEvent:a("./src/sync-event").XHRSyncEvent,WebsocketSyncEvent:a("./src/sync-event").WebsocketSyncEvent,Websockets:{SocketManager:a("./src/websockets/socket-manager"),RequestManager:a("./src/websockets/request-manager"),ChangeManager:a("./src/websockets/change-manager")},OnlineStateManager:a("./src/online-state-manager"),DbManager:a("./src/db-manager"),Constants:a("./src/const"),Util:a("./src/client-utils"),TypingIndicators:a("./src/typing-indicators/typing-indicators")},b.exports.TypingIndicators.TypingListener=a("./src/typing-indicators/typing-listener"),b.exports.TypingIndicators.TypingPublisher=a("./src/typing-indicators/typing-publisher")},{"./src/announcement":7,"./src/client":11,"./src/client-authenticator":8,"./src/client-utils":10,"./src/const":12,"./src/content":13,"./src/conversation":14,"./src/db-manager":15,"./src/layer-error":16,"./src/layer-event":17,"./src/message":20,"./src/message-part":19,"./src/online-state-manager":21,"./src/query":23,"./src/query-builder":22,"./src/root":24,"./src/sync-event":25,"./src/sync-manager":26,"./src/syncable":27,"./src/typing-indicators/typing-indicators":29,"./src/typing-indicators/typing-listener":30,"./src/typing-indicators/typing-publisher":31,"./src/websockets/change-manager":32,"./src/websockets/request-manager":33,"./src/websockets/socket-manager":34,"./src/xhr":35}],2:[function(b,c,d){!function(){function b(){return{keys:Object.keys||function(a){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError("keys() called on a non-object");var b,c=[];for(b in a)a.hasOwnProperty(b)&&(c[c.length]=b);return c},uniqueId:function(a){var b=++j+"";return a?a+b:b},has:function(a,b){return h.call(a,b)},each:function(a,b,c){if(null!=a)if(g&&a.forEach===g)a.forEach(b,c);else if(a.length===+a.length)for(var d=0,e=a.length;d<e;d++)b.call(c,a[d],d,a);else for(var f in a)this.has(a,f)&&b.call(c,a[f],f,a)},once:function(a){var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}}}}var e,f=this,g=Array.prototype.forEach,h=Object.prototype.hasOwnProperty,i=Array.prototype.slice,j=0,k=b();e={on:function(a,b,c){if(!m(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!m(this,"once",a,[b,c])||!b)return this;var d=this,e=k.once(function(){d.off(a,e),b.apply(this,arguments)});return e._callback=b,this.on(a,e,c)},off:function(a,b,c){var d,e,f,g,h,i,j,l;if(!this._events||!m(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events={},this;for(g=a?[a]:k.keys(this._events),h=0,i=g.length;h<i;h++)if(a=g[h],f=this._events[a]){if(this._events[a]=d=[],b||c)for(j=0,l=f.length;j<l;j++)e=f[j],(b&&b!==e.callback&&b!==e.callback._callback||c&&c!==e.context)&&d.push(e);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=i.call(arguments,1);if(!m(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&n(c,b),d&&n(d,arguments),this},stopListening:function(a,b,c){var d=this._listeners;if(!d)return this;var e=!b&&!c;"object"==typeof b&&(c=this),a&&((d={})[a._listenerId]=a);for(var f in d)d[f].off(b,c,this),e&&delete this._listeners[f];return this}};var l=/\s+/,m=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(l.test(c)){for(var f=c.split(l),g=0,h=f.length;g<h;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},n=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},o={listenTo:"on",listenToOnce:"once"};k.each(o,function(a,b){e[b]=function(b,c,d){var e=this._listeners||(this._listeners={}),f=b._listenerId||(b._listenerId=k.uniqueId("l"));return e[f]=b,"object"==typeof c&&(d=this),b[a](c,d,this),this}}),e.bind=e.on,e.unbind=e.off,e.mixin=function(a){var b=["on","once","off","trigger","stopListening","listenTo","listenToOnce","bind","unbind"];return k.each(b,function(b){a[b]=this[b]},this),a},"undefined"!=typeof d?("undefined"!=typeof c&&c.exports&&(d=c.exports=e),d.BackboneEvents=e):"function"==typeof a&&"object"==typeof a.amd?a(function(){return e}):f.BackboneEvents=e}(this)},{}],3:[function(a,b,c){},{}],4:[function(a,b,c){!function(){function a(a){return this.camelCase=a.camelCase,this.propertyNameMap=a.propertyNameMap,this.changeCallbacks=a.changeCallbacks,this.abortCallbacks=a.abortCallbacks,this.getObjectCallback=a.getObjectCallback,this.createObjectCallback=a.createObjectCallback,this.doesObjectMatchIdCallback=a.doesObjectMatchIdCallback||function(a,b){return b.id==a},this.returnIds=a.returnIds,this}function c(a,b,c){this.changeCallbacks&&c&&this.changeCallbacks[c]&&Object.keys(a).forEach(function(d){this.changeCallbacks[c].all?this.changeCallbacks[c].all(b,b[d],a[d].before,a[d].paths):this.changeCallbacks[c][d]&&this.changeCallbacks[c][d](b,b[d],a[d].before,a[d].paths)},this)}function d(a,b,c,d){var e=b.object,f=String.fromCharCode(145);a=a.replace(/\\\./g,f),a=a.replace(/\\(.)/g,"$1");var h=a.split(/\./),i=new RegExp(f,"g");if(h=h.map(function(a){return a.replace(i,".")}),this.camelCase&&(h[0]=h[0].replace(/[-_]./g,function(a){return a[1].toUpperCase()})),this.propertyNameMap){var j=this.propertyNameMap[b.type];h[0]=j&&j[h[0]]||h[0]}g.apply(this,[{baseName:h[0],fullPath:a,object:b.object,options:b,changes:c,operation:d}]);for(var k=e,l=0;l<h.length-1;l++){var m=h[l];if(m in k){if(k=k[m],null===k||"object"!=typeof k)throw new Error("Can not access property '"+a+"'")}else k[m]={},k=k[m]}return{pointer:k,lastName:h[h.length-1],baseName:h[0],fullPath:a,abortHandler:this.abortCallbacks&&this.abortCallbacks[b.type]&&(this.abortCallbacks[b.type].all||this.abortCallbacks[b.type][h[0]])}}function e(a,b){if(a.id){if(!this.getObjectCallback)throw new Error("Must provide getObjectCallback in constructor to use ids");var c=this.getObjectCallback(a.id);return!c&&a.value&&(c=this.createObjectCallback?this.createObjectCallback(a.id,a.value):a.value),c?c:this.returnIds?a.id:null}return a.value}function f(a){if(Array.isArray(a))return a.map(function(a){return f(a)});if(a&&"object"==typeof a){var b=Object.keys(a).filter(function(a){return 0!==a.indexOf("_")}),c={};return b.forEach(function(b){c[b]=f(a[b])}),c}return a}function g(a){if(!a.changes[a.baseName]){var b=a.object[a.baseName];("set"===a.operation||"delete"===a.operation)&&"id"in a.operation&&b&&(b=b.id);var c=a.changes[a.baseName]={paths:[]};c.before=b&&"object"==typeof b?f(b):b}var d=a.changes[a.baseName].paths;d.indexOf(a.fullPath)===-1&&d.push(a.fullPath)}function h(a,b,c,d,e){a.abortHandler&&a.abortHandler(a.fullPath,"set",b)||(a.pointer[a.lastName]=b)}function i(a,b,c,d,e){a.abortHandler&&a.abortHandler(a.fullPath,"delete",b)||delete a.pointer[a.lastName]}function j(a,b,c,d,e){if(!a.abortHandler||!a.abortHandler(a.fullPath,"add",b)){var f;if(f=a.lastName in a.pointer?a.pointer[a.lastName]:a.pointer[a.lastName]=[],!Array.isArray(f))throw new Error("The add operation requires an array or new structure to add to.");if(Array.isArray(b))throw new Error("The add operation will not add arrays to sets.");if(c.id){for(var g=0;g<f.length;g++)if(this.doesObjectMatchIdCallback(c.id,f[g]))return;f.push(b)}else{if(b&&"object"==typeof b)throw new Error("The add operation will not add objects to sets.");f.indexOf(b)===-1&&f.push(b)}}}function k(a,b,c,d,e){if(!a.abortHandler||!a.abortHandler(a.fullPath,"remove",b)){var f;if(f=a.lastName in a.pointer?a.pointer[a.lastName]:a.pointer[a.lastName]=[],!Array.isArray(f))throw new Error("The remove operation requires an array or new structure to remove from.");if(c.id){for(var g=0;g<f.length;g++)if(this.doesObjectMatchIdCallback(c.id,f[g])){f.splice(g,1);break}}else{if(Array.isArray(b))throw new Error("The remove operation will not remove arrays from sets.");if(b&&"object"==typeof b)throw new Error("The remove operation will not remove objects from sets.");var h=f.indexOf(b);h!==-1&&f.splice(h,1)}}}var l={set:h,delete:i,add:j,remove:k};"undefined"!=typeof b?b.exports=a:window.LayerPatchParser=a,a.prototype.parse=function(a){var b={};a.operations.forEach(function(c){var f=d.apply(this,[c.property,a,b,c]);l[c.operation].call(this,f,e.apply(this,[c,a]),c,a,b)},this),c.apply(this,[b,a.object,a.type])}}()},{}],5:[function(a,b,c){(function(a){var c;if(a.crypto&&crypto.getRandomValues){var d=new Uint8Array(16);c=function(){return crypto.getRandomValues(d),d}}if(!c){var e=new Array(16);c=function(){for(var a,b=0;b<16;b++)0===(3&b)&&(a=4294967296*Math.random()),e[b]=a>>>((3&b)<<3)&255;return e}}b.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],6:[function(a,b,c){function d(a,b,c){var d=b&&c||0,e=0;for(b=b||[],a.toLowerCase().replace(/[0-9a-f]{2}/g,function(a){e<16&&(b[d+e++]=j[a])});e<16;)b[d+e++]=0;return b}function e(a,b){var c=b||0,d=i;return d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+"-"+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]+d[a[c++]]}function f(a,b,c){var d=b&&c||0,f=b||[];a=a||{};var g=void 0!==a.clockseq?a.clockseq:n,h=void 0!==a.msecs?a.msecs:(new Date).getTime(),i=void 0!==a.nsecs?a.nsecs:p+1,j=h-o+(i-p)/1e4;if(j<0&&void 0===a.clockseq&&(g=g+1&16383),(j<0||h>o)&&void 0===a.nsecs&&(i=0),i>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");o=h,p=i,n=g,h+=122192928e5;var k=(1e4*(268435455&h)+i)%4294967296;f[d++]=k>>>24&255,f[d++]=k>>>16&255,f[d++]=k>>>8&255,f[d++]=255&k;var l=h/4294967296*1e4&268435455;f[d++]=l>>>8&255,f[d++]=255&l,f[d++]=l>>>24&15|16,f[d++]=l>>>16&255,f[d++]=g>>>8|128,f[d++]=255&g;for(var q=a.node||m,r=0;r<6;r++)f[d+r]=q[r];return b?b:e(f)}function g(a,b,c){var d=b&&c||0;"string"==typeof a&&(b="binary"==a?new Array(16):null,a=null),a=a||{};var f=a.random||(a.rng||h)();if(f[6]=15&f[6]|64,f[8]=63&f[8]|128,b)for(var g=0;g<16;g++)b[d+g]=f[g];return b||e(f)}for(var h=a("./rng"),i=[],j={},k=0;k<256;k++)i[k]=(k+256).toString(16).substr(1),j[i[k]]=k;var l=h(),m=[1|l[0],l[1],l[2],l[3],l[4],l[5]],n=16383&(l[6]<<8|l[7]),o=0,p=0,q=g;q.v1=f,q.v4=g,q.parse=d,q.unparse=e,b.exports=q},{"./rng":5}],7:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./message"),i=a("./syncable"),j=a("./root"),k=a("./layer-error"),l=function(a){function b(){return d(this,b),e(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return f(b,a),g(b,[{key:"send",value:function(){}},{key:"getConversation",value:function(){}},{key:"_loaded",value:function(a){this.getClient()._addMessage(this)}},{key:"delete",value:function(){if(this.isDestroyed)throw new Error(k.dictionary.isDestroyed);var a=this.id,b=this.getClient();this._xhr({url:"",method:"DELETE"},function(c){c.success||c.data&&"not_found"===c.data.id||i.load(a,b)}),this._deleted(),this.destroy()}}],[{key:"_createFromServer",value:function(a,c){var d=a.fromWebsocket;return new b({fromServer:a,clientId:c.appId,_notify:d&&a.is_unread})}}]),b}(h);l.prefixUUID="layer:///announcements/",l.inObjectIgnore=h.inObjectIgnore,l.bubbleEventParent="getClient",l._supportedEvents=[].concat(h._supportedEvents),j.initClass.apply(l,[l,"Announcement"]),i.subclasses.push(l),b.exports=l},{"./layer-error":16,"./message":20,"./root":24,"./syncable":27}],8:[function(a,b,c){(function(c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=a("./xhr"),j=a("./root"),k=a("./websockets/socket-manager"),l=a("./websockets/change-manager"),m=a("./websockets/request-manager"),n=a("./layer-error"),o=a("./online-state-manager"),p=a("./sync-manager"),q=a("./db-manager"),r=a("./sync-event"),s=r.XHRSyncEvent,t=r.WebsocketSyncEvent,u=a("./const"),v=u.ACCEPT,w=u.LOCALSTORAGE_KEYS,x=a("./logger"),y=a("./client-utils"),z=3,A=function(a){function b(a){if(d(this,b),!a.appId)throw new Error(n.dictionary.appIdMissing);return e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a))}return f(b,a),h(b,[{key:"_initComponents",value:function(){this.socketManager=new k({client:this}),this.socketChangeManager=new l({client:this,socketManager:this.socketManager}),this.socketRequestManager=new m({client:this,socketManager:this.socketManager}),this.onlineManager=new o({socketManager:this.socketManager,testUrl:this.url+"/nonces?connection-test",connected:this._handleOnlineChange.bind(this),disconnected:this._handleOnlineChange.bind(this)}),this.syncManager=new p({onlineManager:this.onlineManager,socketManager:this.socketManager,requestManager:this.socketRequestManager,client:this})}},{key:"_destroyComponents",value:function(){this.syncManager.destroy(),this.onlineManager.destroy(),this.socketManager.destroy(),this.socketChangeManager.destroy(),this.socketRequestManager.destroy(),this.dbManager&&this.dbManager.destroy()}},{key:"_isPersistedSessionsDisabled",value:function(){return!c.localStorage||this.persistenceFeatures&&!this.persistenceFeatures.sessionToken}},{key:"_restoreLastSession",value:function(){if(!this._isPersistedSessionsDisabled())try{var a=c.localStorage[w.SESSIONDATA+this.appId];if(!a)return;var b=JSON.parse(a);b.expires<Date.now()?c.localStorage.removeItem(w.SESSIONDATA+this.appId):this.sessionToken=b.sessionToken}catch(a){}}},{key:"_restoreLastUser",value:function(){try{var a=c.localStorage[w.SESSIONDATA+this.appId];if(!a)return null;var b=JSON.parse(a).user;return b}catch(a){return null}}},{key:"_hasUserIdChanged",value:function(a){try{var b=c.localStorage[w.SESSIONDATA+this.appId];return!b||JSON.parse(b).user.userId!==a}catch(a){return!0}}},{key:"connect",value:function(){var a=this,b=arguments.length<=0||void 0===arguments[0]?"":arguments[0],c=void 0;return this.isConnected=!1,this.user=null,this.onlineManager.start(),this.isTrustedDevice&&b&&!this._isPersistedSessionsDisabled()&&!this._hasUserIdChanged(b)||this._clearStoredData(),this.isTrustedDevice&&b&&(this._restoreLastSession(b),c=this._restoreLastUser(),c&&(this.user=c)),this.user||(this.user={userId:b}),this.sessionToken&&this.user.userId?this._sessionTokenRestored():this.xhr({url:"/nonces",method:"POST",sync:!1},function(b){return a._connectionResponse(b)}),this}},{key:"connectWithSession",value:function(a,b){var c=this,d=void 0;if(this.user=null,!a||!b)throw new Error(n.dictionary.sessionAndUserRequired);return(!this.isTrustedDevice||this._isPersistedSessionsDisabled()||this._hasUserIdChanged(a))&&this._clearStoredData(),this.isTrustedDevice&&(d=this._restoreLastUser(),d&&(this.user=d)),this.onlineManager.start(),this.user||(this.user={userId:a}),this.isConnected=!0,setTimeout(function(){return c._authComplete({session_token:b},!1)},1),this}},{key:"_connectionResponse",value:function(a){a.success?this._connectionComplete(a.data):this._connectionError(a.data)}},{key:"_connectionComplete",value:function(a){this.isConnected=!0,this.trigger("connected"),this._authenticate(a.nonce)}},{key:"_connectionError",value:function(a){this.trigger("connected-error",{error:a})}},{key:"_authenticate",value:function(a){a&&this.trigger("challenge",{nonce:a,callback:this.answerAuthenticationChallenge.bind(this)})}},{key:"answerAuthenticationChallenge",value:function(a){var b=this;if(!a)throw new Error(n.dictionary.identityTokenMissing);var c=y.decode(a.split(".")[1]),d=JSON.parse(c);if(this.user.userId&&this.user.userId!==d.prn)throw new Error(n.dictionary.invalidUserIdChange);this.user.userId=d.prn,d.display_name&&(this.user.displayName=d.display_name),d.avatar_url&&(this.user.avatarUrl=d.avatar_url),this.xhr({url:"/sessions",method:"POST",sync:!1,data:{identity_token:a,app_id:this.appId}},function(c){return b._authResponse(c,a)})}},{key:"_authResponse",value:function(a,b){a.success?this._authComplete(a.data,!1):this._authError(a.data,b)}},{key:"_authComplete",value:function(a,b){if(!a||!a.session_token)throw new Error(n.dictionary.sessionTokenMissing);if(this.sessionToken=a.session_token,!this._isPersistedSessionsDisabled()&&!b)try{c.localStorage[w.SESSIONDATA+this.appId]=JSON.stringify({sessionToken:this.sessionToken||"",user:this.user,expires:Date.now()+2592e6})}catch(a){}this._clientAuthenticated()}},{key:"_authError",value:function(a,b){this.trigger("authenticated-error",{error:a})}},{key:"_sessionTokenRestored",value:function(){this.isConnected=!0,this.trigger("connected"),this._clientAuthenticated()}},{key:"_clientAuthenticated",value:function(){var a=this;if(this.isAuthenticated=!0,this.trigger("authenticated"),this.isTrustedDevice||(this.isPersistenceEnabled=!1),!this.persistenceFeatures||!this.isPersistenceEnabled){var b=void 0;b=this.persistenceFeatures&&"sessionToken"in this.persistenceFeatures?Boolean(this.persistenceFeatures.sessionToken):this.isTrustedDevice,this.persistenceFeatures={conversations:this.isPersistenceEnabled,messages:this.isPersistenceEnabled,syncQueue:this.isPersistenceEnabled,sessionToken:b}}this.dbManager||(this.dbManager=new q({client:this,tables:this.persistenceFeatures})),this.isPersistenceEnabled?this.dbManager.onOpen(function(){return a._clientReady()}):this._clientReady()}},{key:"_clientReady",value:function(){this.isReady||(this.isReady=!0,this.trigger("ready"))}},{key:"logout",value:function(a){var b=1,c=0;return this.isAuthenticated&&(b++,this.xhr({method:"DELETE",url:"/sessions/"+escape(this.sessionToken),sync:!1},function(){c++,c===b&&a&&a()})),this._clearStoredData(function(){c++,c===b&&a&&a()}),this._resetSession(),this}},{key:"_clearStoredData",value:function(a){c.localStorage&&localStorage.removeItem(w.SESSIONDATA+this.appId),this.dbManager?this.dbManager.deleteTables(a):a&&a()}},{key:"_resetSession",value:function(){this.isReady=!1,this.sessionToken&&(this.sessionToken="",c.localStorage&&localStorage.removeItem(w.SESSIONDATA+this.appId)),this.isConnected=!1,this.isAuthenticated=!1,this.trigger("deauthenticated"),this.onlineManager.stop()}},{key:"registerIOSPushToken",value:function(a,b){this.xhr({url:"push_tokens",method:"POST",sync:!1,data:{token:a.token,type:"apns",device_id:a.deviceId,ios_version:a.iosVersion,apns_bundle_id:a.bundleId}},function(a){return b(a.data)})}},{key:"registerAndroidPushToken",value:function(a,b){this.xhr({url:"push_tokens",method:"POST",sync:!1,data:{token:a.token,type:"gcm",device_id:a.deviceId,gcm_sender_id:a.senderId}},function(a){return b(a.data)})}},{key:"unregisterPushToken",value:function(a,b){this.xhr({url:"push_tokens/"+a,method:"DELETE"},function(a){return b(a.data)})}},{key:"__adjustAppId",value:function(){if(this.isConnected)throw new Error(n.dictionary.cantChangeIfConnected)}},{key:"sendSocketRequest",value:function(a,b){if(a.sync){var c=a.sync.target,d=a.sync.depends;c&&!d&&(d=[c]),this.syncManager.request(new t({data:a.body,operation:a.method,target:c,depends:d,callback:b}))}else"function"==typeof a.data&&(a.data=a.data()),this.socketRequestManager.sendRequest(a,b)}},{key:"_handleOnlineChange",value:function(a){if(this.isAuthenticated){var c=a.offlineDuration,d="connected"===a.eventName,e={isOnline:d};d&&(e.reset=c>b.ResetAfterOfflineDuration),this.trigger("online",e)}}},{key:"xhr",value:function(a,b){return a.sync&&a.sync.target||(a.url=this._xhrFixRelativeUrls(a.url||"")),a.withCredentials=!0,a.method||(a.method="GET"),a.headers||(a.headers={}),this._xhrFixHeaders(a.headers),this._xhrFixAuth(a.headers),a.sync===!1?this._nonsyncXhr(a,b,0):this._syncXhr(a,b),this}},{key:"_syncXhr",value:function(a,b){var c=this;a.sync||(a.sync={});var d=function(a){c._xhrResult(a,b)},e=a.sync.target,f=a.sync.depends;e&&!f&&(f=[e]),this.syncManager.request(new s({url:a.url,data:a.data,method:a.method,operation:a.sync.operation||a.method,headers:a.headers,callback:d,target:e,depends:f}))}},{key:"_nonsyncXhr",value:function(a,b,c){var d=this;i(a,function(e){[502,503,504].indexOf(e.status)!==-1&&c<z?setTimeout(function(){return d._nonsyncXhr(a,b,c+1)},1e3):d._xhrResult(e,b)})}},{key:"_xhrFixAuth",value:function(a){this.sessionToken&&!a.Authorization&&(a.authorization='Layer session-token="'+this.sessionToken+'"')}},{key:"_xhrFixRelativeUrls",value:function(a){var b=a;return a.indexOf("https://")===-1&&(b="/"===a[0]?this.url+a:this.url+"/"+a),b}},{key:"_xhrFixHeaders",value:function(a){var b=Object.keys(a);b.forEach(function(b){b!==b.toLowerCase()&&(a[b.toLowerCase()]=a[b],delete a[b])}),a.accept||(a.accept=v),a["content-type"]||(a["content-type"]="application/json")}},{key:"_xhrResult",value:function(a,b){this.isDestroyed||(a.success||(a.data&&"object"===g(a.data)&&this._generateError(a),401===a.status&&this.isAuthenticated&&(x.warn("SESSION EXPIRED!"),this.isAuthenticated=!1,c.localStorage&&localStorage.removeItem(w.SESSIONDATA+this.appId),this.trigger("deauthenticated"),this._authenticate(a.data.getNonce()))),b&&b(a))}},{key:"_generateError",value:function(a){a.data=new n(a.data),a.data.httpStatus||(a.data.httpStatus=a.status),a.data.log()}}]),b}(j);A.prototype.isAuthenticated=!1,A.prototype.isConnected=!1,A.prototype.isReady=!1,A.prototype.appId="",A.prototype.user=null,A.prototype.sessionToken="",A.prototype.url="https://api.layer.com",A.prototype.websocketUrl="wss://websockets.layer.com",A.prototype.socketManager=null,A.prototype.socketRequestManager=null,A.prototype.socketChangeManager=null,A.prototype.syncManager=null,A.prototype.onlineManager=null,A.prototype.isTrustedDevice=!1,A.prototype.isPersistenceEnabled=!1,A.prototype.persistenceFeatures=null,A.prototype.dbManager=null,Object.defineProperty(A.prototype,"isOnline",{enumerable:!0,get:function(){return this.onlineManager&&this.onlineManager.isOnline}}),Object.defineProperty(A.prototype,"logLevel",{enumerable:!1,get:function(){return x.level},set:function(a){x.level=a}}),Object.defineProperty(A.prototype,"userId",{enumerable:!0,get:function(){return this.user?this.user.userId:""},set:function(){}}),A.ResetAfterOfflineDuration=108e6,A._supportedEvents=["ready","connected","connected-error","authenticated","authenticated-error","deauthenticated","challenge","session-terminated","online"].concat(j._supportedEvents),j.initClass.apply(A,[A,"ClientAuthenticator"]),b.exports=A}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./client-utils":10,"./const":12,"./db-manager":15,"./layer-error":16,"./logger":18,"./online-state-manager":21,"./root":24,"./sync-event":25,"./sync-manager":26,"./websockets/change-manager":32,"./websockets/request-manager":33,"./websockets/socket-manager":34,"./xhr":35}],9:[function(a,b,c){"use strict";function d(a){var b=a.appId;h[b]&&!h[b].isDestroyed&&h[b].destroy(),h[b]=a}function e(a){h[a.appId]&&delete h[a.appId]}function f(a){return h[a]||null}function g(){return Object.keys(h).map(function(a){return h[a]})}var h={};b.exports={get:f,getAll:g,register:d,unregister:e}},{}],10:[function(a,b,c){"use strict";function d(a){a.client.once("destroy",function(){return j=null}),j=new f({camelCase:!0,getObjectCallback:function(b){return a.client._getObject(b)},createObjectCallback:function(b,c){return a.client._createObject(c)},propertyNameMap:{Conversation:{unreadMessageCount:"unreadCount"}},changeCallbacks:{Message:{all:function(a,b,c,d){a._handlePatchEvent(b,c,d)}},Conversation:{all:function(a,b,c,d){a._handlePatchEvent(b,c,d)}}}})}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},f=a("layer-patch"),g=a("uuid"),h="undefined"==typeof window?a("atob"):window.atob,i="undefined"==typeof window?a("filereader"):FileReader;c.generateUUID=g.v4,c.typeFromID=function(a){var b=a.match(/layer:\/\/\/(.*?)\//);return b?b[1]:""},c.isEmpty=function(a){return"[object Object]"===Object.prototype.toString.apply(a)&&0===Object.keys(a).length},c.sortBy=function(a,b,c){return c=c?-1:1,a.sort(function(a,d){var e=b(a),f=b(d);return void 0===e&&void 0===f?0:void 0===e&&void 0!==f?1:void 0!==e&&void 0===f?-1:e>f?1*c:e<f?-1*c:0})},c.clone=function(a){return JSON.parse(JSON.stringify(a))},c.defer=function(a){return setTimeout(a,0)},c.decode=function(a){var b=a.replace("-","+").replace("_","/");switch(b.length%4){case 0:break;case 2:b+="==";break;case 3:b+="=";break;default:throw new Error("Illegal base64url string!")}return h(b)},c.getExponentialBackoffSeconds=function(a,b){var c=Math.pow(2,b)/10,d=Math.random();return b<2?d/=4:b<6&&(d/=2),c>=a&&(c=a),c+d},c.isBlob=function(a){return"undefined"!=typeof Blob&&a instanceof Blob},c.blobToBase64=function(a,b){var c=new i;c.readAsDataURL(a),c.onloadend=function(){return b(c.result.replace(/^.*?,/,""))}},c.utoa=function(a){return btoa(unescape(encodeURIComponent(a)))},c.atou=function(a){return decodeURIComponent(escape(h(a)))},c.base64ToBlob=function(a,b){try{var c=512,d=h(a),e=[],f=void 0;for(f=0;f<d.length;f+=c){var g=void 0,i=d.slice(f,f+c),j=new Array(i.length);for(g=0;g<i.length;g++)j[g]=i.charCodeAt(g);var k=new Uint8Array(j);e.push(k)}var l=new Blob(e,{type:b});return l}catch(a){}return null},c.fetchTextFromFile=function(a,b){if("string"==typeof a)return b(a);var c=new i;c.addEventListener("loadend",function(){b(c.result)}),c.readAsText(a)};var j=void 0;c.layerParse=function(a){j||d(a),j.parse(a)},c.doesObjectMatch=function(a,b){if(!a&&b||a&&!b)return!1;var d=Object.keys(a).sort(),f=Object.keys(b).sort();if(d.length!==f.length)return!1;for(var g=0;g<d.length;g++){var h=d[g],i=f[g],j=a[h],k=b[i];if(h!==i)return!1;if(j&&"object"===("undefined"==typeof j?"undefined":e(j))){if(Array.isArray(j))throw new Error("Array comparison not handled yet");if(!c.doesObjectMatch(j,k))return!1}else if(j!==k)return!1}return!0},c.includes=function(a,b){return a.indexOf(b)!==-1}},{atob:3,filereader:3,"layer-patch":4,uuid:6}],11:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./client-authenticator"),j=a("./conversation"),k=a("./query"),l=a("./layer-error").dictionary,m=a("./syncable"),n=a("./message"),o=a("./announcement"),p=a("./typing-indicators/typing-indicator-listener"),q=a("./client-utils"),r=a("./root"),s=a("./client-registry"),t=a("./logger"),Client=function(b){function Client(a){d(this,Client);var b=e(this,(Client.__proto__||Object.getPrototypeOf(Client)).call(this,a));return s.register(b),b._conversationsHash={},b._messagesHash={},b._queriesHash={},b._scheduleCheckAndPurgeCacheItems=[],b._initComponents(),b.on("online",b._connectionRestored.bind(b)),b}return f(Client,b),g(Client,[{key:"_initComponents",value:function(){var a=this;h(Client.prototype.__proto__||Object.getPrototypeOf(Client.prototype),"_initComponents",this).call(this),this._typingIndicators=new p({clientId:this.appId}),Object.keys(Client.plugins).forEach(function(b){a[b]=new Client.plugins[b](a)})}},{key:"_cleanup",value:function(){var a=this;this.isDestroyed||(this._inCleanup=!0,Object.keys(this._conversationsHash).forEach(function(b){var c=a._conversationsHash[b];c&&!c.isDestroyed&&c.destroy()}),this._conversationsHash=null,Object.keys(this._messagesHash).forEach(function(b){var c=a._messagesHash[b];c&&!c.isDestroyed&&c.destroy()}),this._messagesHash=null,Object.keys(this._queriesHash).forEach(function(b){a._queriesHash[b].destroy()}),this._queriesHash=null,this.socketManager&&this.socketManager.close())}},{key:"destroy",value:function(){var a=this;Object.keys(Client.plugins).forEach(function(b){a[b]&&(a[b].destroy(),delete a[b])}),this._cleanup(),this._destroyComponents(),s.unregister(this),h(Client.prototype.__proto__||Object.getPrototypeOf(Client.prototype),"destroy",this).call(this),this._inCleanup=!1}},{key:"__adjustAppId",value:function(){if(this.appId)throw new Error(l.appIdImmutable)}},{key:"getConversation",value:function(a,b){if("string"!=typeof a)throw new Error(l.idParamRequired);
return this._conversationsHash[a]?this._conversationsHash[a]:b?j.load(a,this):null}},{key:"_addConversation",value:function(a){var b=a.id;this._conversationsHash[b]||(this._conversationsHash[b]=a,a.clientId!==this.appId&&(a.clientId=this.appId),this._triggerAsync("conversations:add",{conversations:[a]}),this._scheduleCheckAndPurgeCache(a))}},{key:"_removeConversation",value:function(a){var b=this;a.off(null,null,this),this._conversationsHash[a.id]&&(delete this._conversationsHash[a.id],this._triggerAsync("conversations:remove",{conversations:[a]})),Object.keys(this._messagesHash).forEach(function(c){b._messagesHash[c].conversationId===a.id&&b._messagesHash[c].destroy()})}},{key:"_updateConversationId",value:function(a,b){var c=this;this._conversationsHash[b]&&(this._conversationsHash[a.id]=a,delete this._conversationsHash[b],Object.keys(this._messagesHash).filter(function(a){return c._messagesHash[a].conversationId===b}).forEach(function(b){return c._messagesHash[b].conversationId=a.id}))}},{key:"getMessage",value:function(a,b){if("string"!=typeof a)throw new Error(l.idParamRequired);return this._messagesHash[a]?this._messagesHash[a]:b?m.load(a,this):null}},{key:"getMessagePart",value:function(a){if("string"!=typeof a)throw new Error(l.idParamRequired);var b=a.replace(/\/parts.*$/,""),c=this.getMessage(b);return c?c.getPartById(a):null}},{key:"_addMessage",value:function(a){if(!this._messagesHash[a.id]){this._messagesHash[a.id]=a,this._triggerAsync("messages:add",{messages:[a]}),a._notify&&(this._triggerAsync("messages:notify",{message:a}),a._notify=!1);var b=a.getConversation(!1);if(b&&(!b.lastMessage||b.lastMessage.position<a.position)){var c=b.lastMessage;b.lastMessage=a,c&&this._scheduleCheckAndPurgeCache(c)}else this._scheduleCheckAndPurgeCache(a)}}},{key:"_removeMessage",value:function(a){var b="string"==typeof a?a:a.id;if(a=this._messagesHash[b],a&&(delete this._messagesHash[b],!this._inCleanup)){this._triggerAsync("messages:remove",{messages:[a]});var c=a.getConversation(!1);c&&c.lastMessage===a&&(c.lastMessage=null)}}},{key:"_purgeMessagesByPosition",value:function(a,b){var c=this;Object.keys(this._messagesHash).forEach(function(d){var e=c._messagesHash[d];e.conversationId===a&&e.position<=b&&e.destroy()})}},{key:"_getObject",value:function(a){switch(q.typeFromID(a)){case"messages":case"announcements":return this.getMessage(a);case"conversations":return this.getConversation(a);case"queries":return this.getQuery(a)}return null}},{key:"_createObject",value:function(a){var b=this._getObject(a.id);if(b)return b._populateFromServer(a),b;switch(q.typeFromID(a.id)){case"messages":return n._createFromServer(a,this);case"announcements":return o._createFromServer(a,this);case"conversations":return j._createFromServer(a,this)}return null}},{key:"_fixIdentities",value:function(a){return a}},{key:"_processDelayedTriggers",value:function(){if(!this.isDestroyed){var a=this._delayedTriggers.filter(function(a){return"conversations:add"===a[0]}),b=this._delayedTriggers.filter(function(a){return"conversations:remove"===a[0]});this._foldEvents(a,"conversations",this),this._foldEvents(b,"conversations",this);var c=this._delayedTriggers.filter(function(a){return"messages:add"===a[0]}),d=this._delayedTriggers.filter(function(a){return"messages:remove"===a[0]});this._foldEvents(c,"messages",this),this._foldEvents(d,"messages",this),h(Client.prototype.__proto__||Object.getPrototypeOf(Client.prototype),"_processDelayedTriggers",this).call(this)}}},{key:"trigger",value:function(a,b){this._triggerLogger(a,b),h(Client.prototype.__proto__||Object.getPrototypeOf(Client.prototype),"trigger",this).call(this,a,b)}},{key:"_triggerLogger",value:function(a,b){var c=["conversations:add","conversations:remove","conversations:change","messages:add","messages:remove","messages:change","challenge","ready"];if(c.indexOf(a)!==-1){if(b&&b.isChange)t.info("Client Event: "+a+" "+b.changes.map(function(a){return a.property}).join(", "));else{var d="";b&&(b.message&&(d=b.message.id),b.messages&&(d=b.messages.length+" messages"),b.conversation&&(d=b.conversation.id),b.conversations&&(d=b.conversations.length+" conversations")),t.info("Client Event: "+a+" "+d)}b&&t.debug(b)}else t.debug(a,b)}},{key:"findCachedConversation",value:function(a,b){for(var c=b?a.bind(b):a,d=Object.keys(this._conversationsHash),e=d.length,f=0;f<e;f++){var g=d[f],h=this._conversationsHash[g];if(c(h,f))return h}return null}},{key:"_resetSession",value:function(){return this._cleanup(),this._conversationsHash={},this._messagesHash={},this._queriesHash={},h(Client.prototype.__proto__||Object.getPrototypeOf(Client.prototype),"_resetSession",this).call(this)}},{key:"createConversation",value:function(a){return"distinct"in a||(a.distinct=!0),a.client=this,j.create(a)}},{key:"getQuery",value:function(a){if("string"!=typeof a)throw new Error(l.idParamRequired);return this._queriesHash[a]||null}},{key:"createQuery",value:function(a){var b=void 0;return"function"==typeof a.build?b=new k(this,a):(a.client=this,b=new k(a)),this._addQuery(b),b}},{key:"_addQuery",value:function(a){this._queriesHash[a.id]=a}},{key:"_removeQuery",value:function(a){var b=this;if(a){if(delete this._queriesHash[a.id],!this._inCleanup){var c=a.data.map(function(a){return b._getObject(a.id)}).filter(function(a){return a});this._checkAndPurgeCache(c)}this.off(null,null,a)}}},{key:"_checkAndPurgeCache",value:function(a){var b=this;a.forEach(function(a){a.isDestroyed||b._isCachedObject(a)||(a instanceof r==!1&&(a=b._getObject(a.id)),a&&a.destroy())})}},{key:"_scheduleCheckAndPurgeCache",value:function(a){var b=this;a.isSaved()&&(this._scheduleCheckAndPurgeCacheAt<Date.now()&&(this._scheduleCheckAndPurgeCacheAt=Date.now()+Client.CACHE_PURGE_INTERVAL,setTimeout(function(){return b._runScheduledCheckAndPurgeCache()},Client.CACHE_PURGE_INTERVAL)),this._scheduleCheckAndPurgeCacheItems.push(a))}},{key:"_runScheduledCheckAndPurgeCache",value:function(){var a=this._scheduleCheckAndPurgeCacheItems;this._scheduleCheckAndPurgeCacheItems=[],this._checkAndPurgeCache(a),this._scheduleCheckAndPurgeCacheAt=0}},{key:"_isCachedObject",value:function(a){for(var b=Object.keys(this._queriesHash),c=0;c<b.length;c++){var d=this._queriesHash[b[c]];if(d._getItem(a.id))return!0}return!1}},{key:"_connectionRestored",value:function(a){var b=this;a.reset&&(t.debug("Client Connection Restored; Resetting all Queries"),this.dbManager.deleteTables(function(){Object.keys(b._queriesHash).forEach(function(a){var c=b._queriesHash[a];c&&c.reset()})}))}},{key:"_removeObject",value:function(a){a&&a.destroy()}},{key:"createTypingListener",value:function(b){var c=a("./typing-indicators/typing-listener");return new c({clientId:this.appId,input:b})}},{key:"createTypingPublisher",value:function(){var b=a("./typing-indicators/typing-publisher");return new b({clientId:this.appId})}}],[{key:"getClient",value:function(a){return s.get(a)}},{key:"destroyAllClients",value:function(){s.getAll().forEach(function(a){return a.destroy()})}},{key:"registerPlugin",value:function(a,b){Client.plugins[a]=b}}]),Client}(i);Client.prototype._conversationsHash=null,Client.prototype._messagesHash=null,Client.prototype._queriesHash=null,Client.prototype._scheduleCheckAndPurgeCacheItems=null,Client.prototype._scheduleCheckAndPurgeCacheAt=0,Client.CACHE_PURGE_INTERVAL=6e5,Client._ignoredEvents=["conversations:loaded","conversations:loaded-error"],Client._supportedEvents=["conversations:add","conversations:remove","conversations:sent","conversations:sent-error","conversations:change","conversations:loaded","messages:notify","messages:add","messages:remove","messages:sent","messages:sending","messages:sent-error","messages:change","messages:loaded","conversations:delete","messages:delete","typing-indicator-change"].concat(i._supportedEvents),Client.plugins={},r.initClass.apply(Client,[Client,"Client"]),b.exports=Client},{"./announcement":7,"./client-authenticator":8,"./client-registry":9,"./client-utils":10,"./conversation":14,"./layer-error":16,"./logger":18,"./message":20,"./query":23,"./root":24,"./syncable":27,"./typing-indicators/typing-indicator-listener":28,"./typing-indicators/typing-listener":30,"./typing-indicators/typing-publisher":31}],12:[function(a,b,c){"use strict";b.exports={SYNC_STATE:{NEW:"NEW",SAVING:"SAVING",SYNCING:"SYNCING",SYNCED:"SYNCED",LOADING:"LOADING"},RECIPIENT_STATE:{NONE:"NONE",SOME:"SOME",ALL:"ALL"},RECEIPT_STATE:{SENT:"sent",DELIVERED:"delivered",READ:"read",PENDING:"pending"},LOCALSTORAGE_KEYS:{SESSIONDATA:"layer-session-data-"},ACCEPT:"application/vnd.layer+json; version=1.0",WEBSOCKET_PROTOCOL:"layer-1.0",LOG:{DEBUG:4,INFO:3,WARN:2,ERROR:1,NONE:0},DELETION_MODE:{ALL:"all_participants",MY_DEVICES:"my_devices"}}},{}],13:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./root"),i=a("./xhr"),j=function(a){function b(a){return d(this,b),"string"==typeof a&&(a={id:a}),e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a))}return f(b,a),g(b,[{key:"loadContent",value:function(a,b){i({url:this.downloadUrl,responseType:"arraybuffer"},function(c){if(c.success)if("undefined"!=typeof Blob){var d=new Blob([c.data],{type:a});b(null,d)}else b(null,c.data);else b(c.data,null)})}},{key:"refreshContent",value:function(a,b){var c=this;a.xhr({url:this.refreshUrl,method:"GET",sync:!1},function(a){var d=a.data;c.expiration=new Date(d.expiration),c.downloadUrl=d.download_url,b&&b(c.downloadUrl)})}},{key:"isExpired",value:function(){var a=6e5;return this.expiration.getTime()-a<Date.now()}}],[{key:"_createFromServer",value:function(a){return new b({id:a.id,downloadUrl:a.download_url,expiration:new Date(a.expiration),refreshUrl:a.refresh_url})}}]),b}(h);j.prototype.id="",j.prototype.blob=null,j.prototype.downloadUrl="",j.prototype.refreshUrl="",j.prototype.size=0,j.prototype.expiration=null,h.initClass.apply(j,[j,"Content"]),b.exports=j},{"./root":24,"./xhr":35}],14:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},j=a("./syncable"),k=a("./message"),l=a("./layer-error"),m=a("./client-utils"),n=a("./const"),o=a("./root"),p=a("./layer-event"),q=function(a){function b(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];d(this,b),a.participants||(a.participants=[]),a.metadata||(a.metadata={}),a.fromServer&&(a.id=a.fromServer.id),a.client&&(a.clientId=a.client.appId);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));c.isInitializing=!0;var f=c.getClient();return a&&a.fromServer?c._populateFromServer(a.fromServer):(c.participants=f._fixIdentities(c.participants),c.participants.indexOf(f.user.userId)===-1&&c.participants.push(f.user.userId)),c.createdAt||(c.createdAt=new Date),f._addConversation(c),c.isInitializing=!1,c}return f(b,a),h(b,[{key:"destroy",value:function(){this.lastMessage=null,this.clientId&&this.getClient()._removeConversation(this),i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"destroy",this).call(this),this.participants=null,this.metadata=null}},{key:"send",value:function(a){var b=this,c=this.getClient();if(!c)throw new Error(l.dictionary.clientMissing);var d=Boolean(this._sendDistinctEvent);if(this._sendDistinctEvent&&this._handleLocalDistinctConversation(),a){var e=void 0;this.lastMessage?(e=this.lastMessage.position+Date.now()-this.lastMessage.sentAt.getTime(),e===this.lastMessage.position&&e++):e=0,a.position=e,this.lastMessage=a}if(d||this.syncState!==n.SYNC_STATE.NEW)return this;if(this.participants.indexOf(c.user.userId)===-1&&this.participants.push(c.user.userId),1===this.participants.length)throw new Error(l.dictionary.moreParticipantsRequired);return this.createdAt=new Date,this._setSyncing(),c.sendSocketRequest({method:"POST",body:{},sync:{depends:this.id,target:this.id}},function(a){return b._createResult(a)}),this}},{key:"_handleLocalDistinctConversation",value:function(){var a=this._sendDistinctEvent;return this._sendDistinctEvent=null,this._triggerAsync("conversations:sent",a),this}},{key:"_getSendData",value:function(a){var b=m.isEmpty(this.metadata);return{method:"Conversation.create",data:{participants:this.participants,distinct:this.distinct,metadata:b?null:this.metadata,id:this.id}}}},{key:"_createResult",value:function(a){var c=a.success,d=a.data;this.isDestroyed||(c?this._createSuccess(d):"conflict"===d.id?(this._populateFromServer(d.data),this._triggerAsync("conversations:sent",{result:b.FOUND_WITHOUT_REQUESTED_METADATA})):(this.trigger("conversations:sent-error",{error:d}),this.destroy()))}},{key:"_createSuccess",value:function(a){this._populateFromServer(a),this.distinct?this._triggerAsync("conversations:sent",{result:this.lastMessage?b.FOUND:b.CREATED}):this._triggerAsync("conversations:sent",{result:b.CREATED})}},{key:"_populateFromServer",value:function(a){var b=this.getClient();this._disableEvents=this.syncState===n.SYNC_STATE.NEW,this._setSynced();var c=this.id;this.id=a.id,c!==this.id&&(b._updateConversationId(this,c),this._triggerAsync("conversations:change",{oldValue:c,newValue:this.id,property:"id"})),this.url=a.url,this.participants=b._fixIdentities(a.participants),this.distinct=a.distinct,this.createdAt=new Date(a.created_at),this.metadata=a.metadata,this.unreadCount=a.unread_message_count,this.isCurrentParticipant=this.participants.indexOf(b.user.userId)!==-1,b._addConversation(this),"string"==typeof a.last_message?this.lastMessage=b.getMessage(a.last_message):a.last_message?this.lastMessage=b._createObject(a.last_message):this.lastMessage=null,this._disableEvents=!1}},{key:"addParticipants",value:function(a){var b=this,c=this.getClient(),d=c._fixIdentities(a),e=d.filter(function(a){return b.participants.indexOf(a)===-1});return this._patchParticipants({add:e,remove:[]}),this}},{key:"removeParticipants",value:function(a){var b={};this.participants.forEach(function(a){return b[a]=!0});var c=this.getClient(),d=c._fixIdentities(a),e=d.filter(function(a){return b[a]});if(0===e.length)return this;if(e.length===this.participants.length)throw new Error(l.dictionary.moreParticipantsRequired);return this._patchParticipants({add:[],remove:e}),this}},{key:"replaceParticipants",value:function(a){if(!a||!a.length)throw new Error(l.dictionary.moreParticipantsRequired);var b=this.getClient(),c=b._fixIdentities(a),d=this._getParticipantChange(c,this.participants);return this._patchParticipants(d),this}},{key:"_patchParticipants",value:function(a){var b=this;this._applyParticipantChange(a),this.isCurrentParticipant=this.participants.indexOf(this.getClient().user.userId)!==-1;var c=[];a.remove.forEach(function(a){c.push({operation:"remove",property:"participants",value:a})}),a.add.forEach(function(a){c.push({operation:"add",property:"participants",value:a})}),this._xhr({url:"",method:"PATCH",data:JSON.stringify(c),headers:{"content-type":"application/vnd.layer-patch+json"}},function(a){a.success||b._load()})}},{key:"_applyParticipantChange",value:function(a){var b=[].concat(this.participants);a.add.forEach(function(a){b.indexOf(a)===-1&&b.push(a)}),a.remove.forEach(function(a){var c=b.indexOf(a);c!==-1&&b.splice(c,1)}),this.participants=b}},{key:"leave",value:function(){if(this.isDestroyed)throw new Error(l.dictionary.isDestroyed);this._delete("mode="+n.DELETION_MODE.MY_DEVICES+"&leave=true")}},{key:"delete",value:function(a){if(this.isDestroyed)throw new Error(l.dictionary.isDestroyed);var b=void 0;switch(a){case n.DELETION_MODE.ALL:case!0:b="mode="+n.DELETION_MODE.ALL;break;case n.DELETION_MODE.MY_DEVICES:b="mode="+n.DELETION_MODE.MY_DEVICES+"&leave=false";break;default:throw new Error(l.dictionary.deletionModeUnsupported)}this._delete(b)}},{key:"_delete",value:function(a){var c=this.id,d=this.getClient();this._xhr({method:"DELETE",url:"?"+a},function(a){a.success||a.data&&"not_found"===a.data.id||b.load(c,d)}),this._deleted(),this.destroy()}},{key:"_handleWebsocketDelete",value:function(a){a.mode===n.DELETION_MODE.MY_DEVICES&&a.from_position?this.getClient()._purgeMessagesByPosition(this.id,a.from_position):i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"_handleWebsocketDelete",this).call(this)}},{key:"createMessage",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b="string"==typeof a?{parts:[{body:a,mimeType:"text/plain"}]}:a;return b.clientId=this.clientId,b.conversationId=this.id,new k(b)}},{key:"_handlePatchEvent",value:function(a,b,c){this._inLayerParser=!1;try{var d=this._disableEvents;if(this._disableEvents=!1,0===c[0].indexOf("metadata"))this.__updateMetadata(a,b,c);else if("participants"===c[0]){this.getClient();this.__updateParticipants(a,b)}this._disableEvents=d}catch(a){}this._inLayerParser=!0}},{key:"_getParticipantChange",value:function(a,b){var c={};return c.add=a.filter(function(a){return b.indexOf(a)===-1}),c.remove=b.filter(function(b){return a.indexOf(b)===-1}),c}},{key:"setMetadataProperties",value:function(a){var b=this,c=[];return Object.keys(a).forEach(function(b){var d=b;b&&("metadata"!==b&&0!==b.indexOf("metadata.")&&(d="metadata."+b),c.push({operation:"set",property:d,value:a[b]}))}),this._inLayerParser=!0,m.layerParse({object:this,type:"Conversation",operations:c,client:this.getClient()}),this._inLayerParser=!1,this._xhr({url:"",method:"PATCH",data:JSON.stringify(c),headers:{"content-type":"application/vnd.layer-patch+json"}},function(a){a.success||b.isDestroyed||b._load()}),this}},{key:"deleteMetadataProperties",value:function(a){var b=this,c=[];return a.forEach(function(a){"metadata"!==a&&0!==a.indexOf("metadata.")&&(a="metadata."+a),c.push({operation:"delete",property:a})},this),this._inLayerParser=!0,m.layerParse({object:this,type:"Conversation",operations:c,client:this.getClient()}),this._inLayerParser=!1,this._xhr({url:"",method:"PATCH",data:JSON.stringify(c),headers:{"content-type":"application/vnd.layer-patch+json"}},function(a){a.success||b._load()}),this}},{key:"_getUrl",value:function(a){return this.url+(a||"")}},{key:"_loaded",value:function(a){this.getClient()._addConversation(this)}},{key:"on",value:function(a,c,d){var e="conversations:loaded"===a||a&&"object"===("undefined"==typeof a?"undefined":g(a))&&a["conversations:loaded"];return e&&!this.isLoading&&!function(){var b="conversations:loaded"===a?c:a["conversations:loaded"];m.defer(function(){return b.apply(d)})}(),i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"on",this).call(this,a,c,d),this}},{key:"__adjustUnreadCount",value:function(a){if(a<0)return 0}},{key:"__updateUnreadCount",value:function(a,b){var c=this;this._inLayerParser?(void 0===this._oldUnreadCount&&(this._oldUnreadCount=b),this._updateUnreadCountTimeout&&clearTimeout(this._updateUnreadCountTimeout),this._updateUnreadCountTimeout=setTimeout(function(){return c._updateUnreadCountEvent()},1e3)):this._updateUnreadCountEvent()}},{key:"_updateUnreadCountEvent",value:function(){if(!this.isDestroyed){var a=this._oldUnreadCount,b=this.__unreadCount;this._oldUnreadCount=void 0,b!==a&&this._triggerAsync("conversations:change",{newValue:b,oldValue:a,property:"unreadCount"})}}},{key:"__updateLastMessage",value:function(a,b){a&&b&&a.id===b.id||this._triggerAsync("conversations:change",{property:"lastMessage",newValue:a,oldValue:b})}},{key:"__updateParticipants",value:function(a,b){if(!this._inLayerParser){var c=this._getParticipantChange(a,b);(c.add.length||c.remove.length)&&(c.property="participants",c.oldValue=b,c.newValue=a,this._triggerAsync("conversations:change",c))}}},{key:"__updateMetadata",value:function(a,b,c){this._inLayerParser||JSON.stringify(a)!==JSON.stringify(b)&&this._triggerAsync("conversations:change",{property:"metadata",newValue:a,oldValue:b,paths:c})}},{key:"toObject",value:function(){return this._toObject||(this._toObject=i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"toObject",this).call(this),this._toObject.metadata=m.clone(this.metadata)),this._toObject}},{key:"_triggerAsync",value:function(a,c){this._clearObject(),i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"_triggerAsync",this).call(this,a,c)}},{key:"trigger",value:function(a,c){this._clearObject(),i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"trigger",this).call(this,a,c)}}],[{key:"_createFromServer",value:function(a,c){return new b({client:c,fromServer:a,_fromDB:a._fromDB})}},{key:"create",value:function(a){if(!a.client)throw new Error(l.dictionary.clientMissing);var c={distinct:a.distinct,participants:a.client._fixIdentities(a.participants),metadata:a.metadata,client:a.client};if(c.distinct){var d=this._createDistinct(c);if(d)return d}return new b(c)}},{key:"_createDistinct",value:function(a){a.participants.indexOf(a.client.user.userId)===-1&&a.participants.push(a.client.user.userId);var c={};a.participants.forEach(function(a){c[a]=a});var d=a.client.findCachedConversation(function(b){if(b.distinct&&b.participants.length===a.participants.length){for(var d=0;d<b.participants.length;d++)if(!c[b.participants[d]])return!1;return!0}});if(d)return d._sendDistinctEvent=new p({target:d,result:!a.metadata||m.doesObjectMatch(a.metadata,d.metadata)?b.FOUND:b.FOUND_WITHOUT_REQUESTED_METADATA},"conversations:sent"),d}},{key:"_loadResourceForPatch",value:function(a){return!0}}]),b}(j);q.prototype.participants=null,q.prototype.createdAt=null,q.prototype.unreadCount=0,q.prototype.distinct=!0,q.prototype.metadata=null,q.prototype.isCurrentParticipant=!0,q.prototype.lastMessage=null,q.prototype._toObject=null,q.eventPrefix="conversations",q.prototype._sendDistinctEvent=null,q.prefixUUID="layer:///conversations/",q.bubbleEventParent="getClient",q.CREATED="Created",q.FOUND="Found",q.FOUND_WITHOUT_REQUESTED_METADATA="FoundMismatch",q._supportedEvents=["conversations:sent","conversations:sent-error","conversations:loaded","conversations:loaded-error","conversations:delete","conversations:change"].concat(j._supportedEvents),o.initClass.apply(q,[q,"Conversation"]),j.subclasses.push(q),b.exports=q},{"./client-utils":10,"./const":12,"./layer-error":16,"./layer-event":17,"./message":20,"./root":24,"./syncable":27}],15:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function g(a){return a?a.toISOString():null}var h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=a("./root"),j=a("./logger"),k=a("./sync-event"),l=a("./const"),m=a("./client-utils"),n=1,o=9007199254740991,p=l.SYNC_STATE.NEW,q=[{name:"conversations",indexes:{created_at:["created_at"],last_message_sent:["last_message_sent"]}},{name:"messages",indexes:{conversation:["conversation","position"]}},{name:"syncQueue",indexes:{}}],r=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return window.indexedDB?c.client.constructor._supportedEvents.indexOf("conversations:add")!==-1&&(c.client.on("conversations:add",function(a){return c.writeConversations(a.conversations,!1)}),c.client.on("conversations:change",function(a){return c.writeConversations([a.target],!0)}),c.client.on("conversations:delete",function(a){return c.deleteObjects("conversations",[a.target])}),c.client.on("messages:add",function(a){return c.writeMessages(a.messages,!1)}),c.client.on("messages:change",function(a){return c.writeMessages([a.target],!0)}),c.client.on("messages:delete",function(a){return c.deleteObjects("messages",[a.target])})):a.tables={},c.client.syncManager.on("sync:add",function(a){return c.writeSyncEvents([a.request],!1)}),c.client.syncManager.on("sync:abort sync:error",function(a){return c.deleteObjects("syncQueue",[a.request])}),a.tables.conversations&&a.tables.messages||(a.tables.syncQueue=!1),q.forEach(function(b){c["_permission_"+b.name]=Boolean(a.tables[b.name])}),c._open(!1),c}return f(b,a),h(b,[{key:"_getDbName",value:function(){return"LayerWebSDK_"+this.client.appId+"_"+this.client.user.userId.replace(/[^a-zA-Z0-9]/g,"")}},{key:"_open",value:function(a){var b=this;this.db&&(this.db.close(),this.db=null);var c=q.filter(function(a){return b["_permission_"+a.name]});if(0===c.length)return this._isOpenError=!0,void this.trigger("error",{error:"Persistence is disabled by application"});var d=(this.client,window.indexedDB.open(this._getDbName(),n));try{d.onerror=function(c){a?(b._isOpenError=!0,j.warn("Database Unable to Open (common cause: private browsing window)",c.target.error),b.trigger("error",{error:c})):b.deleteTables(function(){return b._open(!0)})},d.onupgradeneeded=function(a){return b._onUpgradeNeeded(a)},d.onsuccess=function(a){b.db=a.target.result,b.isOpen=!0,b.trigger("open"),b.db.onversionchange=function(){b.db&&b.db.close(),b.isOpen=!1},b.db.onerror=function(a){return j.error("db-manager Error: ",a)}}}catch(a){this._isOpenError=!0,j.error("Database Unable to Open: ",a),this.trigger("error",{error:a})}}},{key:"onOpen",value:function(a){this.isOpen||this._isOpenError?a():this.once("open error",a)}},{key:"_onUpgradeNeeded",value:function(a){var b=this,c=a.target.result,d=!1,e=function(){d||(d=!0,b.db=c,b.isOpen=!0,b.trigger("open"))},f=Array.prototype.slice.call(c.objectStoreNames);q.forEach(function(a){try{f.indexOf(a.name)!==-1&&c.deleteObjectStore(a.name)}catch(a){}try{!function(){var b=c.createObjectStore(a.name,{keyPath:"id"});Object.keys(a.indexes).forEach(function(c){return b.createIndex(c,a.indexes[c],{unique:!1})}),b.transaction.oncomplete=e}()}catch(b){j.error("Failed to create object store "+a.name,b)}})}},{key:"_getConversationData",value:function(a){return a.filter(function(a){return a._fromDB?(a._fromDB=!1,!1):!a.isLoading&&a.syncState!==p}).map(function(a){var b={id:a.id,url:a.url,participants:a.participants,distinct:a.distinct,created_at:g(a.createdAt),metadata:a.metadata,unread_message_count:a.unreadCount,last_message:a.lastMessage?a.lastMessage.id:"",last_message_sent:g(a.lastMessage?a.lastMessage.sentAt:a.createdAt),sync_state:a.syncState};return b})}},{key:"writeConversations",value:function(a,b,c){this._writeObjects("conversations",this._getConversationData(a.filter(function(a){return!a.isDestroyed})),b,c)}},{key:"_getMessageData",value:function(a,c){var d=a.filter(function(a){return a._fromDB?(a._fromDB=!1,!1):a.syncState!==l.SYNC_STATE.LOADING}).map(function(a){return{id:a.id,url:a.url,parts:a.parts.map(function(a){var c=m.isBlob(a.body)&&a.body.size>b.MaxPartSize?null:a.body;return{body:c,id:a.id,encoding:a.encoding,mime_type:a.mimeType,content:a._content?{id:a._content.id,download_url:a._content.downloadUrl,expiration:a._content.expiration,refresh_url:a._content.refreshUrl,size:a._content.size}:null}}),position:a.position,sender:{name:a.sender.name,user_id:a.sender.userId,display_name:a.sender.displayName,avatar_url:a.sender.avatarUrl},recipient_status:a.recipientStatus,sent_at:g(a.sentAt),received_at:g(a.receivedAt),conversation:"layer:///announcements/"===a.constructor.prefixUUID?"announcement":a.conversationId,sync_state:a.syncState,is_unread:a.isUnread}}),e=0,f=[];d.forEach(function(a){a.parts.forEach(function(a){m.isBlob(a.body)&&f.push(a)})}),0===f.length?c(d):f.forEach(function(a){m.blobToBase64(a.body,function(b){a.body=b,a.useBlob=!0,e++,e===f.length&&c(d)})})}},{key:"writeMessages",value:function(a,b,c){var d=this;this._getMessageData(a.filter(function(a){return!a.isDestroyed}),function(a){return d._writeObjects("messages",a,b,c)})}},{key:"_getSyncEventData",value:function(a){return a.filter(function(a){return!a.fromDB||(a.fromDB=!1,!1)}).map(function(a){var b={id:a.id,target:a.target,depends:a.depends,isWebsocket:a instanceof k.WebsocketSyncEvent,operation:a.operation,data:a.data,url:a.url||"",headers:a.headers||null,method:a.method||null,created_at:a.createdAt};return b})}},{key:"writeSyncEvents",value:function(a,b,c){this._writeObjects("syncQueue",this._getSyncEventData(a),b,c)}},{key:"_writeObjects",value:function(a,b,c,d){function e(){h++,h===g&&d&&d()}var f=this;if(!this["_permission_"+a]||this._isOpenError)return d?d():null;if(!b.length)return void(d&&d());var g=1,h=0;this.onOpen(function(){var d=f.db.transaction([a],"readwrite"),h=d.objectStore(a);d.oncomplete=d.onerror=e;var i=function(b){if(!c){g++;var d=this.db.transaction([a],"readwrite"),f=d.objectStore(a);d.oncomplete=d.onerror=e,f.put(b)}}.bind(f);b.forEach(function(a){try{var b=c?h.put(a):h.add(a);b.onerror=function(){return i(a)}}catch(b){i(a)}})})}},{key:"loadConversations",value:function(a,b,c,d){var e=this;try{var f=void 0,h=null,i=b?this.client.getConversation(b):null;"last_message"===a?(f="last_message_sent",i&&(h=window.IDBKeyRange.upperBound([g(i.lastMessage?i.lastMessage.sentAt:i.createdAt)]))):(f="created_at",i&&(h=window.IDBKeyRange.upperBound([g(i.createdAt)]))),this._loadByIndex("conversations",f,h,Boolean(b),c,function(a){var b=a.map(function(a){return a.last_message}).filter(function(a){return a&&!e.client.getMessage(a)});e.getObjects("messages",b,function(b){e._loadConversationsResult(a,b,d)})})}catch(a){}}},{key:"_loadConversationsResult",value:function(a,b,c){var d=this;b.forEach(function(a){return d._createMessage(a)});var e=a.map(function(a){return d._createConversation(a)||d.client.getConversation(a.id)}).filter(function(a){return a});c&&c(e)}},{key:"loadMessages",value:function(a,b,c,d){var e=this;try{var f=b?this.client.getMessage(b):null,g=window.IDBKeyRange.bound([a,0],[a,f?f.position:o]);this._loadByIndex("messages","conversation",g,Boolean(b),c,function(a){e._loadMessagesResult(a,d)})}catch(a){}
}},{key:"loadAnnouncements",value:function(a,b,c){var d=this;try{var e=a?this.client.getMessage(a):null,f=window.IDBKeyRange.bound(["announcement",0],["announcement",e?e.position:o]);this._loadByIndex("messages","conversation",f,Boolean(a),b,function(a){d._loadMessagesResult(a,c)})}catch(a){}}},{key:"_blobifyPart",value:function(a){a.useBlob&&(a.body=m.base64ToBlob(a.body),delete a.useBlob,a.encoding=null)}},{key:"_loadMessagesResult",value:function(a,b){var c=this;a.forEach(function(a){return a.parts.forEach(function(a){return c._blobifyPart(a)})});var d=a.map(function(a){return c._createMessage(a)||c.client.getMessage(a.id)}).filter(function(a){return a});b&&b(d)}},{key:"_createConversation",value:function(a){if(!this.client.getConversation(a.id)){a._fromDB=!0;var b=this.client._createObject(a);return b.syncState=a.sync_state,b}}},{key:"_createMessage",value:function(a){if(!this.client.getMessage(a.id)){a._fromDB=!0,a.conversation={id:a.conversation};var b=this.client._createObject(a);return b.syncState=a.sync_state,b}}},{key:"loadSyncQueue",value:function(a){var b=this;this._loadAll("syncQueue",function(c){return b._loadSyncEventRelatedData(c,a)})}},{key:"_loadSyncEventRelatedData",value:function(a,b){var c=this,d=a.filter(function(a){return"DELETE"!==a.operation&&a.target&&a.target.match(/messages/)}).map(function(a){return a.target}),e=a.filter(function(a){return"DELETE"!==a.operation&&a.target&&a.target.match(/conversations/)}).map(function(a){return a.target}),f=0,g=2;this.getObjects("messages",d,function(d){d.forEach(function(a){return c._createMessage(a)}),f++,f===g&&c._loadSyncEventResults(a,b)}),this.getObjects("conversations",e,function(d){d.forEach(function(a){return c._createConversation(a)}),f++,f===g&&c._loadSyncEventResults(a,b)})}},{key:"_loadSyncEventResults",value:function(a,b){var c=this,d=a.filter(function(a){var b=Boolean(a.target&&c.client._getObject(a.target));return"DELETE"===a.operation||b}).map(function(a){return a.isWebsocket?new k.WebsocketSyncEvent({target:a.target,depends:a.depends,operation:a.operation,id:a.id,data:a.data,fromDB:!0,createdAt:a.created_at}):new k.XHRSyncEvent({target:a.target,depends:a.depends,operation:a.operation,id:a.id,data:a.data,method:a.method,headers:a.headers,url:a.url,fromDB:!0,createdAt:a.created_at})});m.sortBy(d,function(a){return a.createdAt}),b(d)}},{key:"_loadAll",value:function(a,b){var c=this;return!this["_permission_"+a]||this._isOpenError?b([]):void this.onOpen(function(){var d=[];c.db.transaction([a],"readonly").objectStore(a).openCursor().onsuccess=function(a){var e=a.target.result;e?(d.push(e.value),e.continue()):c.isDestroyed||b(d)}})}},{key:"_loadByIndex",value:function(a,b,c,d,e,f){var g=this;if(!this["_permission_"+a]||this._isOpenError)return f([]);var h=d;this.onOpen(function(){var d=[];g.db.transaction([a],"readonly").objectStore(a).index(b).openCursor(c,"prev").onsuccess=function(a){var b=a.target.result;b?(h?h=!1:d.push(b.value),e&&d.length>=e?f(d):b.continue()):g.isDestroyed||f(d)}})}},{key:"deleteObjects",value:function(a,b,c){var d=this;return!this["_permission_"+a]||this._isOpenError?c?c():null:void this.onOpen(function(){var e=d.db.transaction([a],"readwrite"),f=e.objectStore(a);e.oncomplete=c,b.forEach(function(a){return f.delete(a.id)})})}},{key:"getObjects",value:function(a,b,c){var d=this;if(!this["_permission_"+a]||this._isOpenError)return c([]);for(var e=[],f=b.sort(),g=f.length-1;g>0;g--)f[g]===f[g-1]&&f.splice(g,1);var h=0;this.onOpen(function(){d.db.transaction([a],"readonly").objectStore(a).openCursor().onsuccess=function(a){var b=a.target.result;if(!b)return void c(e);for(var g=b.key;g>f[h];)h++;g===f[h]&&(e.push(b.value),h++),h===f.length?d.isDestroyed||c(e):b.continue(f[h])}})}},{key:"getObject",value:function(a,b,c){var d=this;return!this["_permission_"+a]||this._isOpenError?c():void this.onOpen(function(){d.db.transaction([a],"readonly").objectStore(a).openCursor(window.IDBKeyRange.only(b)).onsuccess=function(b){var e=b.target.result;if(!e)return c(null);switch(a){case"messages":return e.value.conversation={id:e.value.conversation},e.value.parts.forEach(function(a){return d._blobifyPart(a)}),c(e.value);case"conversations":return e.value.last_message&&!d.client.getMessage(e.value.last_message)?d.getObject("messages",e.value.last_message,function(a){e.value.last_message=a,c(e.value)}):c(e.value)}}})}},{key:"claimSyncEvent",value:function(a,b){var c=this;return!this._permission_syncQueue||this._isOpenError?b(!0):void this.onOpen(function(){var d=c.db.transaction(["syncQueue"],"readwrite"),e=d.objectStore("syncQueue");e.get(a.id).onsuccess=function(a){return b(Boolean(a.target.result))},e.delete(a.id)})}},{key:"deleteTables",value:function(){var a=arguments.length<=0||void 0===arguments[0]?function(){}:arguments[0];try{var b=window.indexedDB.deleteDatabase(this._getDbName());b.onsuccess=b.onerror=a,delete this.db}catch(b){j.error("Failed to delete table",b),a(b)}}}]),b}(i);r.prototype.client=null,r.prototype.isOpen=!1,r.prototype._isOpenError=!1,r.prototype._permission_messages=!1,r.prototype._permission_conversations=!1,r.prototype._permission_syncQueue=!1,r.prototype.db=null,r.MaxPartSize=25e4,r._supportedEvents=["open","error"],i.initClass.apply(r,[r,"DbManager"]),b.exports=r},{"./client-utils":10,"./const":12,"./logger":18,"./root":24,"./sync-event":25}],16:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},f=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),g=a("./logger"),h=function(){function a(b){var c=this;d(this,a),b instanceof a?b={errType:b.errType,httpStatus:b.httpStatus,message:b.message,code:b.code,url:b.url,data:b.data}:b&&"object"===("undefined"==typeof b?"undefined":e(b))?b.errType=b.id:b={message:b},Object.keys(b).forEach(function(a){return c[a]=b[a]}),this.data||(this.data={})}return f(a,[{key:"getNonce",value:function(){return this.data&&this.data.nonce?this.data.nonce:""}},{key:"toString",value:function(){return this.code+" ("+this.id+"): "+this.message+"; (see "+this.url+")"}},{key:"log",value:function(){g.error("Layer-Error: "+this.toString())}}]),a}();h.prototype.errType="",h.prototype.code=0,h.prototype.url="",h.prototype.message="",h.prototype.httpStatus=0,h.prototype.request=null,h.prototype.data=null,h.prototype.xhr=null,h.dictionary={appIdMissing:"Property missing: appId is required",identityTokenMissing:"Identity Token missing: answerAuthenticationChallenge requires an identity token",sessionTokenMissing:"Session Token missing: _authComplete requires a {session_token: value} input",clientMissing:"Property missing: client is required",conversationMissing:"Property missing: conversation is required",partsMissing:"Property missing: parts is required",moreParticipantsRequired:"Conversation needs participants other than the current user",isDestroyed:"Object is destroyed",urlRequired:"Object needs a url property",invalidUrl:"URL is invalid",invalidId:"Identifier is invalid",idParamRequired:"The ID Parameter is required",wrongClass:"Parameter class error; should be: ",inProgress:"Operation already in progress",cantChangeIfConnected:"You can not change value after connecting",cantChangeUserId:"You can not change the userId property",alreadySent:"Already sent or sending",contentRequired:"MessagePart requires rich content for this call",alreadyDestroyed:"This object has already been destroyed",deletionModeUnsupported:"Call to deletion was made with an unsupported deletion mode",sessionAndUserRequired:"connectWithSession requires both a userId and a sessionToken",invalidUserIdChange:"The prn field in the Identity Token must match the requested UserID",predicateNotSupported:"The predicate is not supported for this value of model",invalidPredicate:"The predicate does not match the expected format",appIdImmutable:"The appId property cannot be changed"},b.exports=h},{"./logger":18}],17:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=function(){function a(b,c){var e=this;d(this,a);var f=this;c.match(/:change$/)?(this.changes=[{}],f=this.changes[0],this.isChange=!0):this.isChange=!1,Object.keys(b).forEach(function(a){f!==e&&"target"===a?e.target=b.target:f[a]=b[a]}),this.eventName=c}return e(a,[{key:"hasProperty",value:function(a){return!!this.isChange&&Boolean(this.changes.filter(function(b){return b.property===a}).length)}},{key:"getChangesFor",value:function(a){return this.isChange?this.changes.filter(function(b){return b.property===a}):[]}},{key:"_mergeChanges",value:function(a){this.changes=this.changes.concat(a.changes)}}]),a}();f.prototype.isChange=!1,f.prototype.changes=null,f.prototype.target=null,f.prototype.eventName="",b.exports=f},{}],18:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},f=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),g=a("./const").LOG,h=g.DEBUG,i=g.INFO,j=g.WARN,k=g.ERROR,l=g.NONE,m=a("./client-utils"),n=(m.isEmpty,Boolean(console.assert&&console.assert.toString().match(/assert/))),o="color: #888; font-weight: bold;",p="color: black",q=function(){function a(){d(this,a)}return f(a,[{key:"log",value:function(a,b,c,d){"object"===("undefined"==typeof a?"undefined":e(a))&&(b=a,a="");var f=(new Date).toLocaleTimeString();b?n?console.log("%cLayer%c "+c+"%c ["+f+"]: "+a,o,"color: "+d,p,b):console.log("Layer "+c+" ["+f+"]: "+a,b):n?console.log("%cLayer%c "+c+"%c ["+f+"]: "+a,o,"color: "+d,p):console.log("Layer "+c+" ["+f+"]: "+a)}},{key:"debug",value:function(a,b){this.level>=h&&this.log(a,b,"DEBUG","#888")}},{key:"info",value:function(a,b){this.level>=i&&this.log(a,b,"INFO","black")}},{key:"warn",value:function(a,b){this.level>=j&&this.log(a,b,"WARN","orange")}},{key:"error",value:function(a,b){this.level>=k&&this.log(a,b,"ERROR","red")}}]),a}();q.prototype.level="undefined"==typeof jasmine?k:l;var r=new q;b.exports=r},{"./client-utils":10,"./const":12}],19:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./root"),j=a("./content"),k=a("./xhr"),l=a("./client-registry"),m=a("./layer-error"),n=a("./client-utils"),o=a("./logger"),p=function(a){function b(a){d(this,b);var c=a;if("string"==typeof a)c={body:a},(arguments.length<=1?0:arguments.length-1)>0?c.mimeType=arguments.length<=1?void 0:arguments[1]:c.mimeType="text/plain";else if(n.isBlob(a)||n.isBlob(a.body)){var f=a instanceof Blob?a:a.body,g=n.isBlob(a.body)?a.mimeType:f.type;c={mimeType:g,body:f,size:f.size,hasContent:!0}}var h=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,c));!h.size&&h.body&&(h.size=h.body.length),"base64"===a.encoding&&(h.body=n.base64ToBlob(h.body));var i=n.isBlob(h.body),j=h.isTextualMimeType();return j||(!i&&h.body&&(h.body=new Blob([h.body],{type:h.mimeType})),h.body&&(h.url=URL.createObjectURL(h.body))),h}return f(b,a),g(b,[{key:"destroy",value:function(){this.__url&&(URL.revokeObjectURL(this.__url),this.__url=null),this.body=null,h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"destroy",this).call(this)}},{key:"_getClient",value:function(){return l.get(this.clientId)}},{key:"_getMessage",value:function(){return this._getClient().getMessage(this.id.replace(/\/parts.*$/,""))}},{key:"fetchContent",value:function(a){var b=this;if(this._content&&!this.isFiring){this.isFiring=!0;var c="image/jpeg+preview"===this.mimeType?"image/jpeg":this.mimeType;this._content.loadContent(c,function(c,d){return b._fetchContentCallback(c,d,a)})}return this}},{key:"_fetchContentCallback",value:function(a,b,c){var d=this;a?this.trigger("content-loaded-error",a):(this.isFiring=!1,this.isTextualMimeType()?n.fetchTextFromFile(b,function(a){return d._fetchContentComplete(a,c)}):(this.url=URL.createObjectURL(b),this._fetchContentComplete(b,c)))}},{key:"_fetchContentComplete",value:function(a,b){var c=this._getMessage();this.body=a,this.trigger("content-loaded"),c._triggerAsync("messages:change",{oldValue:c.parts,newValue:c.parts,property:"parts"}),b&&b(this.body)}},{key:"fetchStream",value:function(a){var b=this;if(!this._content)throw new Error(m.dictionary.contentRequired);return this._content.isExpired()?this._content.refreshContent(this._getClient(),function(c){return b._fetchStreamComplete(c,a)}):this._fetchStreamComplete(this._content.downloadUrl,a),this}},{key:"_fetchStreamComplete",value:function(a,b){var c=this._getMessage();this.trigger("url-loaded"),c._triggerAsync("messages:change",{oldValue:c.parts,newValue:c.parts,property:"parts"}),b&&b(a)}},{key:"_send",value:function(a){this._content?this._sendWithContent():this.size>2048?this._generateContentAndSend(a):n.isBlob(this.body)?this._sendBlob(a):this._sendBody()}},{key:"_sendBody",value:function(){if("string"!=typeof this.body){var a="MessagePart.body must be a string in order to send it";throw o.error(a,{mimeType:this.mimeType,body:this.body}),new Error(a)}var b={mime_type:this.mimeType,body:this.body};this.trigger("parts:send",b)}},{key:"_sendWithContent",value:function(){this.trigger("parts:send",{mime_type:this.mimeType,content:{size:this.size,id:this._content.id}})}},{key:"_sendBlob",value:function(a){var b=this;n.blobToBase64(this.body,function(c){if(c.length<2048){var d=c.substring(c.indexOf(",")+1),e={body:d,mime_type:b.mimeType};e.encoding="base64",b.trigger("parts:send",e)}else b._generateContentAndSend(a)})}},{key:"_generateContentAndSend",value:function(a){var b=this;this.hasContent=!0;var c=void 0;c=n.isBlob(this.body)?this.body:n.base64ToBlob(n.utoa(this.body),this.mimeType),a.xhr({url:"/content",method:"POST",headers:{"Upload-Content-Type":this.mimeType,"Upload-Content-Length":c.size,"Upload-Origin":"undefined"!=typeof location?location.origin:""},sync:{}},function(d){b._processContentResponse(d.data,c,a)})}},{key:"_processContentResponse",value:function(a,b,c){var d=this;this._content=new j(a.id),this.hasContent=!0,k({url:a.upload_url,method:"PUT",data:b,headers:{"Upload-Content-Length":this.size,"Upload-Content-Type":this.mimeType}},function(b){return d._processContentUploadResponse(b,a,c)})}},{key:"_processContentUploadResponse",value:function(a,b,c){a.success?this.trigger("parts:send",{mime_type:this.mimeType,content:{size:this.size,id:this._content.id}}):c.onlineManager.isOnline?o.error("We don't yet handle this!"):c.onlineManager.once("connected",this._processContentResponse.bind(this,b,c),this)}},{key:"getText",value:function(){return this.isTextualMimeType()?this.body:""}},{key:"_populateFromServer",value:function(a){a.content&&this._content&&(this._content.downloadUrl=a.content.download_url,this._content.expiration=new Date(a.content.expiration))}},{key:"isTextualMimeType",value:function(){var a=0;for(a=0;a<b.TextualMimeTypes.length;a++){var c=b.TextualMimeTypes[a];if("string"==typeof c){if(c===this.mimeType)return!0}else if(c instanceof RegExp&&this.mimeType.match(c))return!0}return!1}}],[{key:"_createFromServer",value:function(a){var c=a.content?j._createFromServer(a.content):null;return"base64"===a.encoding&&(a.body=n.base64ToBlob(a.body,a.mimeType)),new b({id:a.id,mimeType:a.mime_type,body:a.body||"",_content:c,hasContent:Boolean(c),size:a.size||0})}}]),b}(i);p.prototype.clientId="",p.prototype.id="",p.prototype.body=null,p.prototype._content=null,p.prototype.hasContent=!1,Object.defineProperty(p.prototype,"url",{enumerable:!0,get:function(){return this.__url?this.__url:this._content?this._content.isExpired()?"":this._content.downloadUrl:""},set:function(a){this.__url=a}}),p.prototype.mimeType="text/plain",p.prototype.size=0,p.TextualMimeTypes=[/^text\/.+$/,/^application\/json(\+.+)?$/],p._supportedEvents=["parts:send","content-loaded","url-loaded","content-loaded-error"].concat(i._supportedEvents),i.initClass.apply(p,[p,"MessagePart"]),b.exports=p},{"./client-registry":9,"./client-utils":10,"./content":13,"./layer-error":16,"./logger":18,"./root":24,"./xhr":35}],20:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},j=a("./root"),k=a("./syncable"),l=a("./message-part"),m=a("./layer-error"),n=a("./const"),o=a("./client-utils"),p=a("./client-registry"),q=function(a){function b(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(d(this,b),a.fromServer?a.id=a.fromServer.id:"isUnread"in a?a.isRead=!a.isUnread&&!a.is_unread:a.isRead=!0,a.client&&(a.clientId=a.client.appId),!a.clientId)throw new Error("clientId property required to create a Message");a.conversation&&(a.conversationId=a.conversation.id);var c=a.parts;a.parts=null;var f=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));f.parts=c;var g=f.getClient();if(f.isInitializing=!0,a&&a.fromServer?f._populateFromServer(a.fromServer):(g&&(f.sender=g.user),f.sentAt=new Date),f.parts||(f.parts=[]),f._disableEvents=!0,a.fromServer?f.__updateRecipientStatus(f.recipientStatus):f.recipientStatus={},f._disableEvents=!1,f.isInitializing=!1,a&&a.fromServer){g._addMessage(f);var h=f.recipientStatus[g.user.userId];h&&h!==n.RECEIPT_STATE.READ&&h!==n.RECEIPT_STATE.DELIVERED&&o.defer(function(){return f._sendReceipt("delivery")})}return f}return f(b,a),h(b,[{key:"getConversation",value:function(a){return this.conversationId?p.get(this.clientId).getConversation(this.conversationId,a):null}},{key:"__adjustParts",value:function(a){var b=this;return"string"==typeof a?[new l({body:a,mimeType:"text/plain",clientId:this.clientId})]:Array.isArray(a)?a.map(function(a){var c=void 0;return c=a instanceof l?a:new l(a),c.clientId=b.clientId,c}):a&&"object"===("undefined"==typeof a?"undefined":g(a))?(a.clientId=this.clientId,[new l(a)]):void 0}},{key:"addPart",value:function(a){return a&&(a.clientId=this.clientId,"object"===("undefined"==typeof a?"undefined":g(a))?this.parts.push(new l(a)):a instanceof l&&this.parts.push(a)),this}},{key:"__getRecipientStatus",value:function(a){var b=this,c=this[a]||{},d=this.getClient();return d&&!function(){var a=d.user.userId,e=b.getConversation(!1);e&&e.participants.forEach(function(b){c[b]||(c[b]=b===a?n.RECEIPT_STATE.READ:n.RECEIPT_STATE.PENDING)})}(),c}},{key:"__updateRecipientStatus",value:function(a,b){var c=this.getConversation(!1),d=this.getClient();if(c&&!o.doesObjectMatch(a,b)){var e=d.user.userId,f=this.sender.userId===e,g=a[e]===n.RECEIPT_STATE.READ;try{var h=c.participants.length-1;this.__isRead||!f&&!g||(this.__isRead=!0);var i=this._getReceiptStatus(a,e),j=i.readCount,k=i.deliveredCount;this._setReceiptStatus(j,k,h)}catch(a){}if(!this.isInitializing&&b){var l=g&&b[e]!==n.RECEIPT_STATE.READ;(l||f)&&this._triggerAsync("messages:change",{oldValue:b,newValue:a,property:"recipientStatus"})}}}},{key:"_getReceiptStatus",value:function(a,b){var c=0,d=0;return Object.keys(a).filter(function(a){return a!==b}).forEach(function(b){a[b]===n.RECEIPT_STATE.READ?(c++,d++):a[b]===n.RECEIPT_STATE.DELIVERED&&d++}),{readCount:c,deliveredCount:d}}},{key:"_setReceiptStatus",value:function(a,b,c){a===c?this.readStatus=n.RECIPIENT_STATE.ALL:a>0?this.readStatus=n.RECIPIENT_STATE.SOME:this.readStatus=n.RECIPIENT_STATE.NONE,b===c?this.deliveryStatus=n.RECIPIENT_STATE.ALL:b>0?this.deliveryStatus=n.RECIPIENT_STATE.SOME:this.deliveryStatus=n.RECIPIENT_STATE.NONE}},{key:"__updateIsRead",value:function(a){if(a){this._inPopulateFromServer||this._sendReceipt(n.RECEIPT_STATE.READ),this._triggerMessageRead();var b=this.getConversation(!1);b&&b.unreadCount--}}},{key:"_triggerMessageRead",value:function(){var a=this.isRead;this._triggerAsync("messages:change",{property:"isRead",oldValue:!a,newValue:a}),this._triggerAsync("messages:change",{property:"isUnread",oldValue:a,newValue:!a})}},{key:"sendReceipt",value:function(){var a=arguments.length<=0||void 0===arguments[0]?n.RECEIPT_STATE.READ:arguments[0];if(a===n.RECEIPT_STATE.READ){if(this.isRead)return this;this.__isRead=!0,this._triggerMessageRead();var b=this.getConversation(!1);b&&b.unreadCount--}return this._sendReceipt(a),this}},{key:"_sendReceipt",value:function(a){var b=this,c=this.getConversation(!1);c&&0===c.participants.length||(this._setSyncing(),this._xhr({url:"/receipts",method:"POST",data:{type:a},sync:{operation:"RECEIPT"}},function(){return b._setSynced()}))}},{key:"send",value:function(a){var b=this,c=this.getClient();if(!c)throw new Error(m.dictionary.clientMissing);var d=this.getConversation(!0);if(!d)throw new Error(m.dictionary.conversationMissing);if(this.syncState!==n.SYNC_STATE.NEW)throw new Error(m.dictionary.alreadySent);if(d.isLoading)return d.once("conversations:loaded",function(){return b.send(a)}),this;if(!this.parts||!this.parts.length)throw new Error(m.dictionary.partsMissing);return this._setSyncing(),d.send(this),this._readAllBlobs(function(){c._addMessage(b),b.trigger("messages:sending");var d={parts:new Array(b.parts.length),id:b.id};a&&(d.notification=a),b._preparePartsForSending(d)}),this}},{key:"_readAllBlobs",value:function(a){var b=0,c=this.parts.filter(function(a){return o.isBlob(a.body)&&a.isTextualMimeType()});c.forEach(function(d){o.fetchTextFromFile(d.body,function(e){d.body=e,b++,b===c.length&&a()})}),c.length||a()}},{key:"_preparePartsForSending",value:function(a){var b=this,c=this.getClient(),d=0;this.parts.forEach(function(e,f){e.once("parts:send",function(c){a.parts[f]={mime_type:c.mime_type},c.content&&(a.parts[f].content=c.content),c.body&&(a.parts[f].body=c.body),c.encoding&&(a.parts[f].encoding=c.encoding),d++,d===b.parts.length&&b._send(a)},b),e._send(c)})}},{key:"_send",value:function(a){var b=this,c=this.getClient(),d=this.getConversation(!1);this.sentAt=new Date,c.sendSocketRequest({method:"POST",body:{method:"Message.create",object_id:d.id,data:a},sync:{depends:[this.conversationId,this.id],target:this.id}},function(a,c){return b._sendResult(a,c)})}},{key:"_getSendData",value:function(a){return a.object_id=this.conversationId,a}},{key:"_sendResult",value:function(a){var b=a.success,c=a.data;this.isDestroyed||(b?(this._populateFromServer(c),this._triggerAsync("messages:sent")):(this.trigger("messages:sent-error",{error:c}),this.destroy()),this._setSynced())}},{key:"on",value:function(a,c,d){var e="messages:loaded"===a||a&&"object"===("undefined"==typeof a?"undefined":g(a))&&a["messages:loaded"];return e&&!this.isLoading&&!function(){var b="messages:loaded"===a?c:a["messages:loaded"];o.defer(function(){return b.apply(d)})}(),i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"on",this).call(this,a,c,d),this}},{key:"delete",value:function(a){if(this.isDestroyed)throw new Error(m.dictionary.isDestroyed);var c=void 0;switch(a){case n.DELETION_MODE.ALL:case!0:c="mode=all_participants";break;case n.DELETION_MODE.MY_DEVICES:c="mode=my_devices";break;default:throw new Error(m.dictionary.deletionModeUnsupported)}var d=this.id,e=this.getClient();this._xhr({url:"?"+c,method:"DELETE"},function(a){a.success||a.data&&"not_found"===a.data.id||b.load(d,e)}),this._deleted(),this.destroy()}},{key:"destroy",value:function(){var a=this.getClient();a&&a._removeMessage(this),this.parts.forEach(function(a){return a.destroy()}),this.__parts=null,i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"destroy",this).call(this)}},{key:"_populateFromServer",value:function(a){var b=this;this._inPopulateFromServer=!0;this.getClient();this.id=a.id,this.url=a.url;var c=this.position;this.position=a.position,this.parts&&this.parts.forEach(function(a,c){a.id||(a.id=b.id+"/parts/"+c)}),this.parts=a.parts.map(function(a){var c=b.getPartById(a.id);return c?(c._populateFromServer(a),c):l._createFromServer(a)}),this.recipientStatus=a.recipient_status||{},this.isRead=!a.is_unread,this.sentAt=new Date(a.sent_at),this.receivedAt=a.received_at?new Date(a.received_at):void 0,this.sender={name:a.sender.name,userId:a.sender.user_id,displayName:a.sender.display_name,avatarUrl:a.sender.avatar_url},this._setSynced(),c&&c!==this.position&&this._triggerAsync("messages:change",{oldValue:c,newValue:this.position,property:"position"}),this._inPopulateFromServer=!1}},{key:"getPartById",value:function(a){var b=this.parts?this.parts.filter(function(b){return b.id===a})[0]:null;return b||null}},{key:"_handlePatchEvent",value:function(a,b,c){this._inLayerParser=!1,0===c[0].indexOf("recipient_status")&&this.__updateRecipientStatus(this.recipientStatus,b),this._inLayerParser=!0}},{key:"_getUrl",value:function(a){return this.url+(a||"")}},{key:"_setupSyncObject",value:function(a){return a!==!1&&(a=i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"_setupSyncObject",this).call(this,a),a.depends?a.depends.indexOf(this.id)===-1&&a.depends.push(this.conversationId):a.depends=[this.conversationId]),a}},{key:"getText",value:function(){var a=arguments.length<=0||void 0===arguments[0]?". ":arguments[0],b=this.parts.filter(function(a){return"text/plain"===a.mimeType}).map(function(a){return a.body});return b=b.filter(function(a){return a}),b.join(a)}},{key:"toObject",value:function(){return this._toObject||(this._toObject=i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"toObject",this).call(this),this._toObject.recipientStatus=o.clone(this.recipientStatus)),this._toObject}},{key:"_triggerAsync",value:function(a,c){this._clearObject(),i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"_triggerAsync",this).call(this,a,c)}},{key:"trigger",value:function(a,c){this._clearObject(),i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"trigger",this).call(this,a,c)}},{key:"_loaded",value:function(a){this.conversationId=a.conversation.id,this.getClient()._addMessage(this)}}],[{key:"_createFromServer",value:function(a,c){var d=a.fromWebsocket;return new b({conversationId:a.conversation.id,fromServer:a,clientId:c.appId,_fromDB:a._fromDB,_notify:d&&a.is_unread&&a.sender.user_id!==c.user.userId})}},{key:"_loadResourceForPatch",value:function(a){return!1}}]),b}(k);q.prototype.clientId="",q.prototype.conversationId="",q.prototype.parts=null,q.prototype.sentAt=null,q.prototype.receivedAt=null,q.prototype.sender=null,q.prototype.position=0,q.prototype._notify=!1,q.prototype.recipientStatus=null,q.prototype.isRead=!1,Object.defineProperty(q.prototype,"isUnread",{enumerable:!0,get:function(){return!this.isRead}}),q.prototype.readStatus=n.RECIPIENT_STATE.NONE,q.prototype.deliveryStatus=n.RECIPIENT_STATE.NONE,q.prototype._toObject=null,q.prototype._inPopulateFromServer=!1,q.eventPrefix="messages",q.eventPrefix="messages",q.prefixUUID="layer:///messages/",q.inObjectIgnore=k.inObjectIgnore,q.bubbleEventParent="getClient",q.imageTypes=["image/gif","image/png","image/jpeg","image/jpg"],q._supportedEvents=["messages:loaded","messages:loaded-error","messages:delete","messages:sending","messages:sent","messages:sent-error","messages:change"].concat(k._supportedEvents),j.initClass.apply(q,[q,"Message"]),k.subclasses.push(q),b.exports=q},{"./client-registry":9,"./client-utils":10,"./const":12,"./layer-error":16,"./message-part":19,"./root":24,"./syncable":27}],21:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./root"),j=a("./xhr"),k=a("./logger"),l=a("./client-utils"),m=a("./const"),n=m.ACCEPT,o=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return j.addConnectionListener(function(a){return c._connectionListener(a)}),c.socketManager.on("message",function(){return c._connectionListener({status:"connection:success"})},c),"undefined"!=typeof window&&(window.addEventListener("online",c._handleOnlineEvent.bind(c)),window.addEventListener("offline",c._handleOnlineEvent.bind(c))),c}return f(b,a),g(b,[{key:"start",value:function(){k.info("OnlineStateManager: start"),this.isClientReady=!0,this.isOnline=!0,this.checkOnlineStatus()}},{key:"stop",value:function(){k.info("OnlineStateManager: stop"),this.isClientReady=!1,this._clearCheck(),
this._changeToOffline()}},{key:"_scheduleNextOnlineCheck",value:function(){if(k.debug("OnlineStateManager: skip schedule"),!this.isDestroyed&&this.isClientReady)if(this._clearCheck(),this.isOnline)k.debug("OnlineStateManager: Scheduled onlineExpired"),this.onlineCheckId=setTimeout(this._onlineExpired.bind(this),this.pingFrequency);else{k.info("OnlineStateManager: Scheduled checkOnlineStatus");var a=l.getExponentialBackoffSeconds(this.maxOfflineWait,Math.min(10,this.offlineCounter++));this.onlineCheckId=setTimeout(this.checkOnlineStatus.bind(this),Math.floor(1e3*a))}}},{key:"_clearCheck",value:function(){this.onlineCheckId&&(clearTimeout(this.onlineCheckId),this.onlineCheckId=0)}},{key:"_handleOnlineEvent",value:function(a){this.offlineCounter=0,this.checkOnlineStatus()}},{key:"_onlineExpired",value:function(){this._clearCheck(),this._changeToOffline(),this._scheduleNextOnlineCheck()}},{key:"checkOnlineStatus",value:function(a){var b=this;this._clearCheck(),k.info("OnlineStateManager: Firing XHR for online check"),this._lastCheckOnlineStatus=new Date,j({url:this.testUrl,method:"POST",headers:{accept:n}},function(){a&&a(b.isOnline)})}},{key:"_changeToOffline",value:function(){this.isOnline&&(this.isOnline=!1,this.trigger("disconnected"),k.info("OnlineStateManager: Connection lost"))}},{key:"_connectionListener",value:function(a){if("connection:success"===a.status){var b=this.lastMessageTime;this.lastMessageTime=new Date,this.isOnline||(this.isOnline=!0,this.offlineCounter=0,this.trigger("connected",{offlineDuration:b?Date.now()-b:0}),void 0===this.connectedCounter&&(this.connectedCounter=0),this.connectedCounter++,k.info("OnlineStateManager: Connected restored"))}else this._changeToOffline();this._scheduleNextOnlineCheck()}},{key:"destroy",value:function(){this._clearCheck(),this.socketManager=null,h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"destroy",this).call(this)}}]),b}(i);o.prototype.isClientReady=!1,o.prototype.testUrl="",o.prototype.socketManager=null,o.prototype.offlineCounter=0,o.prototype.maxOfflineWait=300,o.prototype.minBackoffWait=100,o.prototype.lastMessageTime=null,o.prototype._lastCheckOnlineStatus=null,o.prototype.isOnline=!1,o.prototype.onlineCheckId=0,o.prototype.pingFrequency=1e5,o._supportedEvents=["connected","disconnected"].concat(i._supportedEvents),i.initClass.apply(o,[o,"OnlineStateManager"]),b.exports=o},{"./client-utils":10,"./const":12,"./logger":18,"./root":24,"./xhr":35}],22:[function(a,b,c){"use strict";function d(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function g(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=a("./query"),j=(a("./layer-error"),function(){function a(b){g(this,a),b?this._query={model:b.model,returnType:b.returnType,dataType:b.dataType,paginationWindow:b.paginationWindow}:this._query={model:i.Message,returnType:"object",dataType:"object",paginationWindow:i.prototype.paginationWindow},this._conversationIdSet=!1}return h(a,[{key:"forConversation",value:function(a){return a?(this._query.predicate="conversation.id = '"+a+"'",this._conversationIdSet=!0):(this._query.predicate="",this._conversationIdSet=!1),this}},{key:"paginationWindow",value:function(a){return this._query.paginationWindow=a,this}},{key:"build",value:function(){return this._query}}]),a}()),k=function(a){function b(a){g(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c._query.model=i.Announcement,c}return f(b,a),h(b,[{key:"build",value:function(){return this._query}}]),b}(j),l=function(){function a(b){g(this,a),b?this._query={model:b.model,returnType:b.returnType,dataType:b.dataType,paginationWindow:b.paginationWindow,sortBy:b.sortBy}:this._query={model:i.Conversation,returnType:"object",dataType:"object",paginationWindow:i.prototype.paginationWindow,sortBy:null}}return h(a,[{key:"paginationWindow",value:function(a){return this._query.paginationWindow=a,this}},{key:"sortBy",value:function(a){var b=!(arguments.length<=1||void 0===arguments[1])&&arguments[1];return this._query.sortBy=[d({},a,b?"asc":"desc")],this}},{key:"build",value:function(){return this._query}}]),a}(),m={messages:function(){return new j},announcements:function(){return new k},conversations:function(){return new l},fromQueryObject:function(a){switch(a.model){case i.Message:return new j(a);case i.Announcement:return new k(a);case i.Conversation:return new l(a);default:return null}}};b.exports=m},{"./layer-error":16,"./query":23}],23:[function(a,b,c){"use strict";function d(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function g(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},j=a("./root"),k=a("./layer-error"),l=a("./client-utils"),m=a("./logger"),n=a("./const"),o=n.SYNC_STATE,p="Conversation",q="Message",r="Announcement",s=new RegExp(/^conversation.id\s*=\s*['"]((layer:\/\/\/conversations\/)?.{8}-.{4}-.{4}-.{4}-.{12})['"]$/),t=function(a){function b(){e(this,b);for(var a=void 0,c=arguments.length,d=Array(c),g=0;g<c;g++)d[g]=arguments[g];2===d.length?(a=d[1].build(),a.client=d[0]):a=d[0];var h=f(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));if(h.predicate=h._fixPredicate(a.predicate||""),"paginationWindow"in a){var i=a.paginationWindow;h.paginationWindow=Math.min(h._getMaxPageSize(),a.paginationWindow),a.paginationWindow!==i&&m.warn("paginationWindow value "+i+" in Query constructor excedes Query.MaxPageSize of "+h._getMaxPageSize())}if(h.data=[],h._initialPaginationWindow=h.paginationWindow,!h.client)throw new Error(k.dictionary.clientMissing);return h.client.on("all",h._handleChangeEvents,h),h.client.isReady?h._run():h.client.once("ready",function(){return h._run()},h),h}return g(b,a),h(b,[{key:"destroy",value:function(){this.data=[],this._triggerChange({type:"data",target:this.client,query:this,isChange:!1,data:[]}),this.client.off(null,null,this),this.client._removeQuery(this),this.data=null,i(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"destroy",this).call(this)}},{key:"_getMaxPageSize",value:function(){return b.MaxPageSize}},{key:"update",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=void 0,c=void 0,d="function"==typeof a.build?a.build():a;if("paginationWindow"in d&&this.paginationWindow!==d.paginationWindow&&(this.paginationWindow=Math.min(this._getMaxPageSize()+this.size,d.paginationWindow),this.paginationWindow<d.paginationWindow&&m.warn("paginationWindow value "+d.paginationWindow+" in Query.update() increases size greater than Query.MaxPageSize of "+this._getMaxPageSize()),b=!0),"model"in d&&this.model!==d.model&&(this.model=d.model,c=!0),"predicate"in d){var e=this._fixPredicate(d.predicate||"");this.predicate!==e&&(this.predicate=e,c=!0)}return"sortBy"in d&&JSON.stringify(this.sortBy)!==JSON.stringify(d.sortBy)&&(this.sortBy=d.sortBy,c=!0),c&&this._reset(),(c||b)&&this._run(),this}},{key:"_fixPredicate",value:function(a){if(""===a)return"";if(this.model===b.Message){var c=a.match(s)?a.replace(s,"$1"):null;if(!c)throw new Error(k.dictionary.invalidPredicate);return 0!==c.indexOf("layer:///conversations/")&&(c="layer:///conversations/"+c),"conversation.id = '"+c+"'"}throw new Error(k.dictionary.predicateNotSupported)}},{key:"_reset",value:function(){this.totalSize=0;var a=this.data;this.data=[],this.client._checkAndPurgeCache(a),this.isFiring=!1,this._predicate=null,this._nextDBFromId="",this._nextServerFromId="",this._isServerSyncing=!1,this.pagedToEnd=!1,this.paginationWindow=this._initialPaginationWindow,this._triggerChange({data:[],type:"reset"})}},{key:"reset",value:function(){this._reset(),this._run()}},{key:"_run",value:function(){var a=Math.min(this.paginationWindow-this.size,this._getMaxPageSize());if(a<0){var b=this.data.slice(this.paginationWindow);this.data=this.data.slice(0,this.paginationWindow),this.client._checkAndPurgeCache(b),this.pagedToEnd=!1,this._triggerAsync("change",{data:[]})}else if(0===a||this.pagedToEnd);else switch(this.model){case p:this._runConversation(a);break;case q:this.predicate&&this._runMessage(a);break;case r:this._runAnnouncement(a)}}},{key:"_runConversation",value:function(a){var b=this,c=this._getSortField();this.client.dbManager.loadConversations(c,this._nextDBFromId,a,function(a){a.length&&b._appendResults({data:a},!0)});var d="conversations?sort_by="+c+"&page_size="+a+(this._nextServerFromId?"&from_id="+this._nextServerFromId:"");d!==this._firingRequest&&(this.isFiring=!0,this._firingRequest=d,this.client.xhr({url:this._firingRequest,method:"GET",sync:!1},function(c){return b._processRunResults(c,b._firingRequest,a)}))}},{key:"_getSortField",value:function(){return this.model===q||this.model===r?"position":this.sortBy&&this.sortBy[0]&&this.sortBy[0]["lastMessage.sentAt"]?"last_message":"created_at"}},{key:"_getConversationPredicateIds",value:function(){if(this.predicate.match(s)){var a=this.predicate.replace(s,"$1"),b=(this._predicate||a).replace(/^layer:\/\/\/conversations\//,"");if(b)return{uuid:b,id:a}}}},{key:"_runMessage",value:function(a){var b=this,c=this._getConversationPredicateIds();c?!function(){var d="layer:///conversations/"+c.uuid;b._predicate||(b._predicate=c.id);var e=b.client.getConversation(d);b.client.dbManager.loadMessages(d,b._nextDBFromId,a,function(a){a.length&&b._appendResults({data:a},!0)});var f="conversations/"+c.uuid+"/messages?page_size="+a+(b._nextServerFromId?"&from_id="+b._nextServerFromId:"");e&&!e.isSaved()||f===b._firingRequest||(b.isFiring=!0,b._firingRequest=f,b.client.xhr({url:f,method:"GET",sync:!1},function(c){return b._processRunResults(c,f,a)})),0===b.data.length&&e&&e.lastMessage&&(b.data=[b._getData(e.lastMessage)],b._triggerChange({type:"data",data:[b._getData(e.lastMessage)],query:b,target:b.client}))}():this.predicate.match(/['"]/)||m.error("This query may need to quote its value")}},{key:"_runAnnouncement",value:function(a){var b=this;this.client.dbManager.loadAnnouncements(this._nextDBFromId,a,function(a){a.length&&b._appendResults({data:a},!0)});var c="announcements?page_size="+a+(this._nextServerFromId?"&from_id="+this._nextServerFromId:"");c!==this._firingRequest&&(this.isFiring=!0,this._firingRequest=c,this.client.xhr({url:c,method:"GET",sync:!1},function(d){return b._processRunResults(d,c,a)}))}},{key:"_processRunResults",value:function(a,b,c){var d=this;if(b===this._firingRequest&&!this.isDestroyed){var e="true"===a.xhr.getResponseHeader("Layer-Conversation-Is-Syncing");this.isFiring=e,this._firingRequest="",a.success?e?(this._isServerSyncing||(this._isServerSyncing=!0,this.trigger("server-syncing-state",{syncing:!0})),setTimeout(function(){return d._run()},1500)):(this._appendResults(a,!1),this.totalSize=Number(a.xhr.getResponseHeader("Layer-Count")),a.data.length<c&&(this.pagedToEnd=!0),this._isServerSyncing&&(this._isServerSyncing=!1,this.trigger("server-syncing-state",{syncing:!1}))):this.trigger("error",{error:a.data})}}},{key:"_appendResults",value:function(a,c){var d=this;a.data.forEach(function(a){a instanceof j||d.client._createObject(a)});var e=a.data.filter(function(a){return d._getIndex(a.id)===-1}),f=a.data.length;f&&(c?this._nextDBFromId=a.data[f-1].id:this._nextServerFromId=a.data[f-1].id),this.dataType===b.ObjectDataType&&(this.data=[].concat(this.data));var g=this.data;e.forEach(function(a){var b=void 0,c=d.client._getObject(a.id);switch(d.model){case q:case r:b=d._getInsertMessageIndex(c,g);break;case p:b=d._getInsertConversationIndex(c,g)}g.splice(b,0,d._getData(c))}),this._triggerChange({type:"data",data:e.map(function(a){return d._getData(d.client._getObject(a.id))}),query:this,target:this.client})}},{key:"_getData",value:function(a){return this.dataType===b.ObjectDataType?a.toObject():a}},{key:"_getInstance",value:function(a){return a instanceof j?a:this.client._getObject(a.id)}},{key:"_getItem",value:function(a){switch(l.typeFromID(a)){case"announcements":if(this.model===r){var b=this._getIndex(a);return b===-1?null:this.data[b]}break;case"messages":if(this.model===q){var c=this._getIndex(a);return c===-1?null:this.data[c]}if(this.model===p){for(var d=0;d<this.data.length;d++){var e=this.data[d];if(e.lastMessage&&e.lastMessage.id===a)return e.lastMessage}return null}break;case"conversations":if(this.model===p){var f=this._getIndex(a);return f===-1?null:this.data[f]}}}},{key:"_getIndex",value:function(a){for(var b=0;b<this.data.length;b++)if(this.data[b].id===a)return b;return-1}},{key:"_handleChangeEvents",value:function(a,b){switch(this.model){case p:this._handleConversationEvents(b);break;case q:case r:this._handleMessageEvents(b)}}},{key:"_handleConversationEvents",value:function(a){switch(a.eventName){case"conversations:change":this._handleConversationChangeEvent(a);break;case"conversations:add":this._handleConversationAddEvent(a);break;case"conversations:remove":this._handleConversationRemoveEvent(a)}}},{key:"_handleConversationChangeEvent",value:function(a){var c=this._getIndex(a.target.id);if(this.dataType===b.ObjectDataType){var e=a.getChangesFor("id");e.length&&(c=this._getIndex(e[0].oldValue))}if(c!==-1){var f=this._getSortField(),g=a.hasProperty("lastMessage")&&"last_message"===f;if(this.dataType===b.ObjectDataType)if(g){var h=this._getInsertConversationIndex(a.target,this.data);this.data.splice(c,1),this.data.splice(h,0,this._getData(a.target)),this.data=this.data.concat([])}else this.data=[].concat(d(this.data.slice(0,c)),[a.target.toObject()],d(this.data.slice(c+1)));else if(g){var i=this._getInsertConversationIndex(a.target,this.data);i!==c&&(this.data.splice(c,1),this.data.splice(i,0,a.target))}this._triggerChange({type:"property",target:this._getData(a.target),query:this,isChange:!0,changes:a.changes})}}},{key:"_getInsertConversationIndex",value:function(a,b){if(!a.isSaved())return 0;var c=this._getSortField(),d=void 0;if("created_at"===c){for(d=0;d<b.length;d++){var e=b[d];if(e.syncState!==o.NEW&&e.syncState!==o.SAVING&&a.createdAt>=e.createdAt)break}return d}var f=a.lastMessage?a.lastMessage.sentAt:a.createdAt;for(d=0;d<b.length;d++){var g=b[d];if(g.syncState!==o.NEW&&g.syncState!==o.SAVING){var h=g.lastMessage?g.lastMessage.sentAt:g.createdAt;if(f>=h)break}}return d}},{key:"_getInsertMessageIndex",value:function(a,b){var c=void 0;for(c=0;c<b.length&&!(a.position>b[c].position);c++);return c}},{key:"_handleConversationAddEvent",value:function(a){var c=this,d=a.conversations.filter(function(a){return c._getIndex(a.id)===-1});d.length&&!function(){var a=c.data;d.forEach(function(b){var d=c._getInsertConversationIndex(b,a);a.splice(d,0,c._getData(b))}),c.dataType===b.ObjectDataType&&(c.data=[].concat(a)),c.totalSize+=d.length,d.forEach(function(a){var b=c._getData(a);c._triggerChange({type:"insert",index:c.data.indexOf(b),target:b,query:c})})}()}},{key:"_handleConversationRemoveEvent",value:function(a){var c=this,e=[];a.conversations.forEach(function(a){var f=c._getIndex(a.id);f!==-1&&(a.id===c._nextDBFromId&&(c._nextDBFromId=c._updateNextFromId(f)),a.id===c._nextServerFromId&&(c._nextServerFromId=c._updateNextFromId(f)),e.push({data:a,index:f}),c.dataType===b.ObjectDataType?c.data=[].concat(d(c.data.slice(0,f)),d(c.data.slice(f+1))):c.data.splice(f,1))}),this.totalSize-=e.length,e.forEach(function(a){c._triggerChange({type:"remove",index:a.index,target:c._getData(a.data),query:c})})}},{key:"_handleMessageEvents",value:function(a){switch(a.eventName){case"conversations:change":this.model===q&&this._handleMessageConvIdChangeEvent(a);break;case"messages:change":case"messages:read":this._handleMessageChangeEvent(a);break;case"messages:add":this._handleMessageAddEvent(a);break;case"messages:remove":this._handleMessageRemoveEvent(a)}}},{key:"_handleMessageConvIdChangeEvent",value:function(a){var b=a.getChangesFor("id");b.length&&this._predicate===b[0].oldValue&&(this._predicate=b[0].newValue,this.predicate="conversation.id = '"+this._predicate+"'",this._run())}},{key:"_handleMessagePositionChange",value:function(a,b){if(b===-1)return!1;var c=[].concat(d(this.data.slice(0,b)),d(this.data.slice(b+1))),e=this._getInsertMessageIndex(a.target,c);return e!==b&&(c.splice(e,0,this._getData(a.target)),this.data=c,this._triggerChange({type:"property",target:this._getData(a.target),query:this,isChange:!0,changes:a.changes}),!0)}},{key:"_handleMessageChangeEvent",value:function(a){var c=this._getIndex(a.target.id),e=a.getChangesFor("position");if(e.length&&this._handleMessagePositionChange(a,c)){if(e.length===a.changes.length)return;c=this._getIndex(a.target.id)}c!==-1&&(this.dataType===b.ObjectDataType&&(this.data=[].concat(d(this.data.slice(0,c)),[a.target.toObject()],d(this.data.slice(c+1)))),this._triggerChange({type:"property",target:this._getData(a.target),query:this,isChange:!0,changes:a.changes}))}},{key:"_handleMessageAddEvent",value:function(a){var c=this,d=a.messages.filter(function(a){var b=l.typeFromID(a.id);return"messages"===b&&c.model===q||"announcements"===b&&c.model===r}).filter(function(a){var b=l.typeFromID(a.id);return"announcements"===b||a.conversationId===c._predicate}).filter(function(a){return c._getIndex(a.id)===-1}).map(function(a){return c._getData(a)});d.length&&!function(){var a=c.data=c.dataType===b.ObjectDataType?[].concat(c.data):c.data;d.forEach(function(b){var d=c._getInsertMessageIndex(b,a);a.splice(d,0,b)}),c.totalSize+=d.length,d.forEach(function(a){c._triggerChange({type:"insert",index:c.data.indexOf(a),target:a,query:c})})}()}},{key:"_handleMessageRemoveEvent",value:function(a){var c=this,e=[];a.messages.forEach(function(a){var f=c._getIndex(a.id);f!==-1&&(a.id===c._nextDBFromId&&(c._nextDBFromId=c._updateNextFromId(f)),a.id===c._nextServerFromId&&(c._nextServerFromId=c._updateNextFromId(f)),e.push({data:a,index:f}),c.dataType===b.ObjectDataType?c.data=[].concat(d(c.data.slice(0,f)),d(c.data.slice(f+1))):c.data.splice(f,1))}),this.totalSize-=e.length,e.forEach(function(a){c._triggerChange({type:"remove",target:c._getData(a.data),index:a.index,query:c})})}},{key:"_updateNextFromId",value:function(a){return a>0?this.data[a-1].id:""}},{key:"_triggerChange",value:function(a){this.trigger("change",a),this.trigger("change:"+a.type,a)}},{key:"toString",value:function(){return this.id}}]),b}(j);t.prefixUUID="layer:///queries/",t.Conversation=p,t.Message=q,t.Announcement=r,t.ObjectDataType="object",t.InstanceDataType="instance",t.MaxPageSize=100,Object.defineProperty(t.prototype,"size",{enumerable:!0,get:function(){return this.data?this.data.length:0}}),t.prototype.totalSize=0,t.prototype.client=null,t.prototype.data=null,t.prototype.model="",t.prototype.returnType="object",t.prototype.dataType=t.InstanceDataType,t.prototype.paginationWindow=100,t.prototype.sortBy=null,t.prototype._initialPaginationWindow=100,t.prototype.predicate=null,t.prototype.isFiring=!1,t.prototype.pagedToEnd=!1,t.prototype._firingRequest="",t.prototype._isServerSyncing=!1,t.prototype._nextServerFromId="",t.prototype._nextDBFromId="",t._supportedEvents=["change","change:data","change:reset","change:property","change:insert","change:remove","error","server-syncing-state"].concat(j._supportedEvents),j.initClass.apply(t,[t,"Query"]),b.exports=t},{"./client-utils":10,"./const":12,"./layer-error":16,"./logger":18,"./root":24}],24:[function(a,b,c){"use strict";function d(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function g(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function h(){}function i(a,b){var c="__"+b,d=b.substring(0,1).toUpperCase()+b.substring(1),e=a.prototype["__adjust"+d]||a.prototype["__update"+d]||a.prototype["__get"+d];e&&(a.prototype[c]=a.prototype[b],Object.defineProperty(a.prototype,b,{enumerable:!0,get:function(){return this["__get"+d]?this["__get"+d](c):this[c]},set:function(a){if(!this.isDestroyed){var b=this[c];if(a!==b){if(this["__adjust"+d]){var e=this["__adjust"+d](a);void 0!==e&&(a=e)}this[c]=a}a!==b&&!this.isInitializing&&this["__update"+d]&&this["__update"+d](a,b)}}}))}function j(a,b){a.name||(a.name=b),a._supportedEvents||(a._supportedEvents=u._supportedEvents),a._ignoredEvents||(a._ignoredEvents=u._ignoredEvents);var c=Object.keys(a.prototype).filter(function(b){return a.prototype.hasOwnProperty(b)&&!u.prototype.hasOwnProperty(b)&&"function"!=typeof a.prototype[b]});c.forEach(function(b){return i(a,b)})}var k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},l=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),m=a("./client-utils"),n=a("./layer-event"),o=a("./layer-error"),p=a("backbone-events-standalone/backbone-events-standalone"),q=a("./logger");h.prototype=p;var r=new h;"function"==typeof postMessage&&addEventListener("message",function(a){"layer-delayed-event"===a.data.type&&r.trigger(a.data.internalId+"-delayed-event")});var s={},t=/\s+/,u=function(a){function b(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];e(this,b);var c=f(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));c._subscriptions=[],c._delayedTriggers=[],c._lastDelayedTrigger=Date.now(),c._events={};var d=c.constructor.name;s[d]||(s[d]=0),c.internalId=d+s[d]++,r.on(c.internalId+"-delayed-event",c._processDelayedTriggers,c),c.id||a.id||!c.constructor.prefixUUID||(c.id=c.constructor.prefixUUID+m.generateUUID());var g=void 0;for(g in a)c.constructor._supportedEvents.indexOf(g)!==-1?c.on(g,a[g]):g in c&&"function"!=typeof c[g]&&(c[g]=a[g]);return c.isInitializing=!1,c}return g(b,a),l(b,[{key:"destroy",value:function(){var a=this;if(this.isDestroyed)throw new Error(o.dictionary.alreadyDestroyed);this.trigger("destroy"),r.off(this.internalId+"-delayed-event",null,this),this.off(),this._subscriptions.forEach(function(b){return b.off(null,null,a)}),this._subscriptions=null,this._delayedTriggers=null,this.isDestroyed=!0}},{key:"toObject",value:function(){var a=this,c=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];this.__inToObject=!0;var d={};try{var e=[];for(var f in this.constructor.prototype)f in b.prototype||e.push(f);e.forEach(function(e){var f=a[e];0!==e.indexOf("_")&&"function"!=typeof f&&(Array.isArray(f)?(d[e]=[],f.forEach(function(a){a instanceof b?c?delete d[e]:a.__inToObject||d[e].push(a.toObject()):d[e].push(a)})):f instanceof b?f.__inToObject||c||(d[e]=f.toObject()):f instanceof Date?d[e]=new Date(f):d[e]=f)})}catch(a){}return this.__inToObject=!1,d}},{key:"_warnForEvent",value:function(a){if(!m.includes(this.constructor._supportedEvents,a))throw new Error("Event "+a+" not defined for "+this.toString())}},{key:"_prepareOn",value:function(a,c,d){var e=this;if(d instanceof b){if(d.isDestroyed)throw new Error(o.dictionary.isDestroyed);d._subscriptions.push(this)}if("string"==typeof a&&"all"!==a)if(t.test(a)){var f=a.split(t);f.forEach(function(a){return e._warnForEvent(a)})}else this._warnForEvent(a);else a&&"object"===("undefined"==typeof a?"undefined":k(a))&&Object.keys(a).forEach(function(a){return e._warnForEvent(a)})}},{key:"on",value:function(a,b,c){return this._prepareOn(a,b,c),p.on.apply(this,[a,b,c]),this}},{key:"once",value:function(a,b,c){return this._prepareOn(a,b,c),p.once.apply(this,[a,b,c]),this}},{key:"trigger",value:function(){return this._disableEvents?this:this._trigger.apply(this,arguments)}},{key:"_trigger",value:function(){if(!m.includes(this.constructor._supportedEvents,arguments.length<=0?void 0:arguments[0]))return void(m.includes(this.constructor._ignoredEvents,arguments.length<=0?void 0:arguments[0])||q.error(this.toString()+" ignored "+(arguments.length<=0?void 0:arguments[0])));var a=this._getTriggerArgs.apply(this,arguments);p.trigger.apply(this,a);var b=this.constructor.bubbleEventParent;if(b){var c,e=this[b];e="function"==typeof e?e.apply(this):e,e&&(c=e).trigger.apply(c,d(a))}}},{key:"_getTriggerArgs",value:function(){for(var a=this,b=arguments.length,c=Array(b),d=0;d<b;d++)c[d]=arguments[d];var e=Array.prototype.slice.call(c);return c[1]?!function(){var b={target:a};e[1]instanceof n||("object"===k(e[1])?Object.keys(e[1]).forEach(function(a){b[a]=e[1][a]}):b.data=e[1],e[1]=new n(b,e[0]))}():e[1]=new n({target:this},e[0]),e}},{key:"_triggerAsync",value:function(){var a=this,b=this._getTriggerArgs.apply(this,arguments);this._delayedTriggers.push(b);var c=1===this._delayedTriggers.length||this._delayedTriggers.length&&this._lastDelayedTrigger+500<Date.now();c&&(this._lastDelayedTrigger=Date.now(),"function"==typeof postMessage&&"undefined"==typeof jasmine?window.postMessage({type:"layer-delayed-event",internalId:this.internalId},"*"):setTimeout(function(){return a._processDelayedTriggers()},0))}},{key:"_foldEvents",value:function(a,b,c){var d=this,e=a.length?a[0][1]:null,f=e?e[b]:null;a.forEach(function(a,c){c>0&&(f.push(a[1][b][0]),d._delayedTriggers.splice(d._delayedTriggers.indexOf(a),1))}),a.length&&c&&(a[0][1].target=c)}},{key:"_foldChangeEvents",value:function(){var a=this,b=this._delayedTriggers.filter(function(a){return a[1].isChange});b.forEach(function(c,d){d>0&&(b[0][1]._mergeChanges(c[1]),a._delayedTriggers.splice(a._delayedTriggers.indexOf(c),1))})}},{key:"_processDelayedTriggers",value:function(){this.isDestroyed||(this._foldChangeEvents(),this._delayedTriggers.forEach(function(a){this.trigger.apply(this,d(a))},this),this._delayedTriggers=[])}},{key:"toString",value:function(){return this.internalId}}],[{key:"isValidId",value:function(a){return 0===a.indexOf(this.prefixUUID)}}]),b}(h);u.prototype.isDestroyed=!1,u.prototype.internalId="",u.prototype.isInitializing=!0,u.prototype._subscriptions=null,u.prototype._disableEvents=!1,u._supportedEvents=["destroy","all"],u._ignoredEvents=[],b.exports=u,b.exports.initClass=j},{"./client-utils":10,"./layer-error":16,"./layer-event":17,"./logger":18,"backbone-events-standalone/backbone-events-standalone":2}],25:[function(a,b,c){"use strict";function d(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function e(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function f(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./client-utils"),i=function(){function a(b){f(this,a);var c=void 0;for(c in b)c in this&&(this[c]=b[c]);this.depends||(this.depends=[]),this.id||(this.id="layer:///syncevents/"+h.generateUUID()),this.createdAt||(this.createdAt=Date.now())}return g(a,[{key:"destroy",value:function(){this.target=null,this.depends=null,this.callback=null,this.data=null}},{key:"_updateData",value:function(a){if(this.target){var b=a._getObject(this.target);b&&"POST"===this.operation&&b._getSendData&&(this.data=b._getSendData(this.data))}}},{key:"toObject",value:function(){return{data:this.data}}}]),a}();i.prototype.operation="",i.prototype.fromDB=!1,i.prototype.createdAt=0,Object.defineProperty(i.prototype,"isFiring",{enumerable:!0,set:function(a){this.__isFiring=a,a&&(this.__firedAt=Date.now())},get:function(){return Boolean(this.__isFiring&&Date.now()-this.__firedAt<i.FIRING_EXPIRATION)}}),Object.defineProperty(i.prototype,"_isValidating",{enumerable:!0,set:function(a){this.__isValidating=a,a&&(this.__validatedAt=Date.now())},get:function(){return Boolean(this.__isValidating&&Date.now()-this.__validatedAt<i.VALIDATION_EXPIRATION)}}),i.prototype.id="",i.prototype.success=null,i.prototype.callback=null,i.prototype.retryCount=0,i.prototype.target=null,i.prototype.depends=null,i.prototype.data=null,i.FIRING_EXPIRATION=15e3,i.VALIDATION_EXPIRATION=500;var j=function(a){function b(){return f(this,b),d(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return e(b,a),g(b,[{key:"_getRequestData",value:function(a){return this._updateUrl(a),this._updateData(a),{url:this.url,method:this.method,headers:this.headers,data:this.data}}},{key:"_updateUrl",value:function(a){if(this.target){var b=a._getObject(this.target);b&&!this.url.match(/^http(s)\:\/\//)&&(this.url=b._getUrl(this.url))}}},{key:"toObject",value:function(){return{data:this.data,url:this.url,method:this.method}}},{key:"_getCreateId",value:function(){return"POST"===this.operation&&this.data?this.data.id:""}}]),b}(i);j.prototype.timeout=15e3,j.prototype.url="",j.prototype.returnToOnlineCount=0,j.prototype.headers=null,j.prototype.method="GET";var k=function(a){function b(){return f(this,b),d(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return e(b,a),g(b,[{key:"_getRequestData",value:function(a){return this._updateData(a),this.data}},{key:"toObject",value:function(){return this.data}},{key:"_getCreateId",value:function(){return"POST"===this.operation&&this.data.data?this.data.data.id:""}}]),b}(i);b.exports={SyncEvent:i,XHRSyncEvent:j,WebsocketSyncEvent:k}},{"./client-utils":10}],26:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./root"),j=a("./sync-event"),k=j.WebsocketSyncEvent,l=a("./xhr"),m=a("./logger"),n=a("./client-utils"),o=4,p=function(a){function b(a){d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.client=a.client,c.client&&c.client.on("ready",function(){c._processNextRequest(),c._loadPersistedQueue()},c),c.queue=[],c.receiptQueue=[],c.onlineManager.on("disconnected",c._onlineStateChange,c),c.socketManager.on("connected disconnected",c._onlineStateChange,c),c}return f(b,a),g(b,[{key:"isOnline",value:function(){return this.onlineManager.isOnline}},{key:"_onlineStateChange",value:function(a){var b=this;"connected"===a.eventName?(this.queue.length&&this.queue[0].returnToOnlineCount++,setTimeout(function(){return b._processNextRequest()},100)):"disconnected"===a.eventName&&(this.queue.length&&(this.queue[0].isFiring=!1),this.receiptQueue.length&&this.receiptQueue.forEach(function(a){a.isFiring=!1}))}},{key:"request",value:function(a){"PATCH"===a.operation&&this._findUnfiredCreate(a)?m.info("Sync Manager Request PATCH "+a.target+" request ignored; create request still enqueued",a.toObject()):(m.info("Sync Manager Request "+a.operation+" on target "+a.target,a.toObject()),"RECEIPT"===a.operation?this.receiptQueue.push(a):this.queue.push(a),this.trigger("sync:add",{request:a,target:a.target})),"DELETE"===a.operation&&this._purgeOnDelete(a),this._processNextRequest(a)}},{key:"_processNextRequest",value:function(a){var b=this;this.queue.length&&!this.queue[0].isFiring&&(a?this.client.dbManager.writeSyncEvents([a],!1,function(){return b._processNextStandardRequest()}):this._processNextStandardRequest()),this.receiptQueue.length&&this._processNextReceiptRequest()}},{key:"_findUnfiredCreate",value:function(a){return Boolean(this.queue.filter(function(b){return b.target===a.target&&"POST"===b.operation&&!b.isFiring}).length)}},{key:"_processNextStandardRequest",value:function(){var a=this;if(!this.isDestroyed&&this.client.isAuthenticated){var b=this.queue[0];this.isOnline()&&b&&!b.isFiring&&!b._isValidating&&(b._isValidating=!0,this._validateRequest(b,function(c){return b._isValidating=!1,c?void a._fireRequest(b):(a._removeRequest(b,!1),a._processNextStandardRequest())}))}}},{key:"_processNextReceiptRequest",value:function(){var a=this,b=0;this.receiptQueue.forEach(function(c){a.isOnline()&&c&&(c.isFiring||c._isValidating?b++:b<o&&(b++,c._isValidating=!0,a._validateRequest(c,function(b){if(c._isValidating=!1,b)a._fireRequest(c);else{var d=a.receiptQueue.indexOf(c);d!==-1&&a.receiptQueue.splice(d,1)}})))})}},{key:"_fireRequest",value:function(a){a instanceof k?this._fireRequestWebsocket(a):this._fireRequestXHR(a)}},{key:"_fireRequestXHR",value:function(a){var b=this;a.isFiring=!0,a.headers||(a.headers={}),a.headers.authorization='Layer session-token="'+this.client.sessionToken+'"',m.debug("Sync Manager XHR Request Firing "+a.operation+" "+a.target,a.toObject()),l(a._getRequestData(this.client),function(c){return b._xhrResult(c,a)})}},{key:"_fireRequestWebsocket",value:function(a){var b=this;this.socketManager&&this.socketManager._isOpen()?(m.debug("Sync Manager Websocket Request Firing "+a.operation+" on target "+a.target,a.toObject()),a.isFiring=!0,this.requestManager.sendRequest(a._getRequestData(this.client),function(c){return b._xhrResult(c,a)})):m.debug("Sync Manager Websocket Request skipped; socket closed")}},{key:"_validateRequest",value:function(a,b){this.client.dbManager.claimSyncEvent(a,function(a){return b(a)})}},{key:"_handleDeduplicationErrors",value:function(a){a.data&&"id_in_use"===a.data.id&&a.data.data&&a.data.data.id===a.request._getCreateId()&&(a.success=!0,a.data=a.data.data)}},{key:"_xhrResult",value:function(a,b){this.isDestroyed||(a.request=b,b.isFiring=!1,this._handleDeduplicationErrors(a),a.success?this._xhrSuccess(a):this._xhrError(a))}},{key:"_getErrorState",value:function(a,c,d){var e=a.data?a.data.id:"";return d?"not_found"===e?"notFound":"id_in_use"===e?"invalidId":408===a.status||"request_timeout"===e?c.retryCount>=b.MAX_RETRIES?"tooManyFailuresWhileOnline":"validateOnlineAndRetry":[502,503,504].indexOf(a.status)!==-1?c.retryCount>=b.MAX_RETRIES?"tooManyFailuresWhileOnline":"serverUnavailable":"authentication_required"===e&&a.data.data&&a.data.data.nonce?"reauthorize":"serverRejectedRequest":c.returnToOnlineCount>=b.MAX_RETRIES_BEFORE_CORS_ERROR?"CORS":"offline"}},{key:"_xhrError",value:function(a){var b=a.request;m.warn("Sync Manager "+(b instanceof k?"Websocket":"XHR")+" "+(b.operation+" Request on target "+b.target+" has Failed"),b.toObject());var c=this._getErrorState(a,b,this.isOnline());switch(m.warn("Sync Manager Error State: "+c),c){case"tooManyFailuresWhileOnline":this._xhrHandleServerError(a,"Sync Manager Server Unavailable Too Long; removing request",!1);break;case"notFound":this._xhrHandleServerError(a,"Resource not found; presumably deleted",!1);break;case"invalidId":this._xhrHandleServerError(a,"ID was not unique; request failed",!1);break;case"validateOnlineAndRetry":this._xhrValidateIsOnline(b);break;case"serverUnavailable":this._xhrHandleServerUnavailableError(b);break;case"reauthorize":b.callback&&b.callback(a);break;case"serverRejectedRequest":this._xhrHandleServerError(a,"Sync Manager Server Rejects Request; removing request",!0);break;case"CORS":this._xhrHandleServerError(a,"Sync Manager Server detects CORS-like errors; removing request",!1);break;case"offline":this._xhrHandleConnectionError()}this.queue.indexOf(b)===-1&&this.receiptQueue.indexOf(b)===-1||this.client.dbManager.writeSyncEvents([b],!1)}},{key:"_xhrHandleServerUnavailableError",value:function(a){var c=b.MAX_UNAVAILABLE_RETRY_WAIT,d=n.getExponentialBackoffSeconds(c,Math.min(15,a.retryCount++));m.warn("Sync Manager Server Unavailable; retry count "+a.retryCount+"; retrying in "+d+" seconds"),setTimeout(this._processNextRequest.bind(this),1e3*d)}},{key:"_xhrHandleServerError",value:function(a,b,c){a.request.callback&&a.request.callback(a),c?m.error(b+"\nREQUEST: "+JSON.stringify(a.request.toObject(),null,4)+"\nRESPONSE: "+JSON.stringify(a.data,null,4)):m.error(b,a),this.trigger("sync:error",{target:a.request.target,request:a.request,error:a.data}),a.request.success=!1,"POST"===a.request.operation&&this._purgeDependentRequests(a.request),this._removeRequest(a.request,!0),this._processNextRequest()}},{key:"_xhrHandleConnectionError",value:function(){}},{key:"_xhrValidateIsOnline",value:function(a){var b=this;m.debug("Sync Manager verifying online state"),this.onlineManager.checkOnlineStatus(function(c){return b._xhrValidateIsOnlineCallback(c,a)})}},{key:"_xhrValidateIsOnlineCallback",value:function(a,b){m.debug("Sync Manager online check result is "+a),a?(b.retryCount++,this._processNextRequest()):this._xhrHandleConnectionError()}},{key:"_xhrSuccess",value:function(a){var b=a.request;m.debug("Sync Manager "+(b instanceof k?"Websocket":"XHR")+" "+(b.operation+" Request on target "+b.target+" has Succeeded"),b.toObject()),a.data&&m.debug(a.data),b.success=!0,this._removeRequest(b,!0),b.callback&&b.callback(a),this._processNextRequest(),this.trigger("sync:success",{target:b.target,request:b,response:a.data})}},{key:"_removeRequest",value:function(a,b){var c="RECEIPT"===a.operation?this.receiptQueue:this.queue,d=c.indexOf(a);d!==-1&&c.splice(d,1),b&&this.client.dbManager.deleteObjects("syncQueue",[a])}},{key:"_purgeDependentRequests",value:function(a){this.queue=this.queue.filter(function(b){return b.depends.indexOf(a.target)===-1||b===a}),this.receiptQueue=this.receiptQueue.filter(function(b){return b.depends.indexOf(a.target)===-1||b===a})}},{key:"_purgeOnDelete",value:function(a){var b=this;this.queue.filter(function(b){return b.depends.indexOf(a.target)!==-1&&a!==b}).forEach(function(a){b.trigger("sync:abort",{target:a.target,request:a}),b._removeRequest(a,!0)})}},{key:"destroy",value:function(){this.queue.forEach(function(a){return a.destroy()}),this.queue=null,this.receiptQueue.forEach(function(a){return a.destroy()}),this.receiptQueue=null,h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"destroy",this).call(this)}},{key:"_loadPersistedQueue",value:function(){var a=this;this.client.dbManager.loadSyncQueue(function(b){b.length&&(a.queue=a.queue.concat(b),a._processNextRequest())})}}]),b}(i);p.prototype.socketManager=null,p.prototype.requestManager=null,p.prototype.onlineManager=null,p.prototype.queue=null,p.prototype.receiptQueue=null,p.prototype.client=null,p.MAX_UNAVAILABLE_RETRY_WAIT=900,p.MAX_RETRIES_BEFORE_CORS_ERROR=3,p.MAX_RETRIES=20,p._supportedEvents=["sync:error","sync:success","sync:add","sync:abort"].concat(i._supportedEvents),i.initClass(p),b.exports=p},{"./client-utils":10,"./logger":18,"./root":24,"./sync-event":25,"./xhr":35}],27:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./root"),j=a("./const"),k=j.SYNC_STATE,l=a("./layer-error"),m=a("./client-registry"),n=a("./const"),o=function(a){function b(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];d(this,b);var c=e(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));return c.localCreatedAt=new Date,c}return f(b,a),g(b,[{key:"getClient",value:function(){return m.get(this.clientId)}},{key:"_xhr",value:function(a,b){var c=this;a.url||(a.url=""),a.method||(a.method="GET");var d=this.getClient();if(this.isDestroyed)throw new Error(l.dictionary.isDestroyed);if(!d)throw new Error(l.dictionary.clientMissing);return this.constructor.enableOpsIfNew||"POST"===a.method||"GET"===a.method||this.syncState!==n.SYNC_STATE.NEW?(a.url.match(/^http(s):\/\//)||(a.url&&!a.url.match(/^(\/|\?)/)&&(a.url="/"+a.url),a.sync||(a.url=this.url+a.url)),a.sync=this._setupSyncObject(a.sync),"GET"!==a.method&&this._setSyncing(),d.xhr(a,function(d){d.success&&"GET"!==a.method&&!c.isDestroyed&&c._setSynced(),b&&b(d)}),this):this}},{key:"_setupSyncObject",value:function(a){return a!==!1&&(a||(a={}),a.target||(a.target=this.id)),a}},{key:"_handleWebsocketDelete",value:function(a){this._deleted(),this.destroy()}},{key:"_deleted",value:function(){this.trigger(this.constructor.eventPrefix+":delete")}},{key:"_load",value:function(){var a=this;this.syncState=k.LOADING,this._xhr({method:"GET",sync:!1},function(b){return a._loadResult(b)})}},{key:"_loadResult",value:function(a){var b=this,c=this.constructor.eventPrefix;a.success?(this._populateFromServer(a.data),this._loaded(a.data),this.trigger(c+":loaded")):(this.syncState=k.NEW,this._triggerAsync(c+":loaded-error",{error:a.data}),setTimeout(function(){return b.destroy()},100))}},{key:"_loaded",value:function(a){}},{key:"_setSyncing",value:function(){switch(this._clearObject(),this.syncState){case k.SYNCED:this.syncState=k.SYNCING;break;case k.NEW:this.syncState=k.SAVING}this._syncCounter++}},{key:"_setSynced",value:function(){this._clearObject(),this._syncCounter>0&&this._syncCounter--,this.syncState=0===this._syncCounter?k.SYNCED:k.SYNCING,this.isSending=!1}},{key:"_clearObject",value:function(){this._toObject=null}},{key:"toObject",value:function(){return this._toObject||(this._toObject=h(b.prototype.__proto__||Object.getPrototypeOf(b.prototype),"toObject",this).call(this),this._toObject.isNew=this.isNew(),this._toObject.isSaving=this.isSaving(),this._toObject.isSaved=this.isSaved(),this._toObject.isSynced=this.isSynced()),this._toObject}},{key:"isNew",value:function(){return this.syncState===k.NEW}},{key:"isSaving",value:function(){return this.syncState===k.SAVING}},{key:"isSaved",value:function(){return!(this.isNew()||this.isSaving())}},{key:"isSynced",value:function(){return this.syncState===k.SYNCED}}],[{key:"load",value:function(a,c){if(!(c&&c instanceof i))throw new Error(l.dictionary.clientMissing);var d={id:a,url:c.url+a.substring(8),clientId:c.appId},e=b.subclasses.filter(function(a){return 0===d.id.indexOf(a.prefixUUID)})[0],f=new e(d),g=e.eventPrefix;return g?c.dbManager.getObject(g,a,function(a){f.isDestroyed||(a?(f._populateFromServer(a),f.trigger(g+":loaded")):f._load())}):f._load(),f.syncState=k.LOADING,f}}]),b}(i);o.prototype.id="",o.prototype.url="",o.prototype.localCreatedAt=null,o.prototype.clientId="",o.prototype._fromDB=!1,o.prototype.syncState=k.NEW,o.prototype._syncCounter=0,o.eventPrefix="",o.enableOpsIfNew=!1,Object.defineProperty(o.prototype,"isLoading",{enumerable:!0,get:function(){return this.syncState===k.LOADING}}),o.subclasses=[],o._supportedEvents=[].concat(i._supportedEvents),o.inObjectIgnore=i.inObjectIgnore,b.exports=o},{"./client-registry":9,"./const":12,"./layer-error":16,"./root":24}],28:[function(a,b,c){"use strict";function d(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function g(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=a("../root"),j=a("../client-registry"),k=a("./typing-indicators"),l=k.STARTED,m=k.PAUSED,n=k.FINISHED,o=function(a){function b(a){e(this,b);var c=f(this,(b.__proto__||Object.getPrototypeOf(b)).call(this,a));c.state={},c._pollId=0;var d=c._getClient();return d.on("ready",function(){return c._clientReady()}),c}return g(b,a),h(b,[{key:"_clientReady",value:function(){var a=this._getClient();this.user=a.user;var b=a.socketManager;b.on("message",this._handleSocketEvent,this),this._startPolling()}},{key:"_isRelevantEvent",value:function(a){return"signal"===a.type&&"typing_indicator"===a.body.type&&a.body.data.user_id!==this.user.userId}},{key:"_handleSocketEvent",value:function(a){var b=a.data;if(this._isRelevantEvent(b)){var c=b.body.data.user_id,d=b.body.data.action,e=b.body.object.id,f=this.state[e];f||(f=this.state[e]={users:{},typing:[],paused:[]}),f.users[c]={startTime:Date.now(),state:d},f.users[c].state===n&&delete f.users[c],this._updateState(f,d,c),this.trigger("typing-indicator-change",{conversationId:e,typing:f.typing,paused:f.paused})}}},{key:"_updateState",value:function(a,b,c){var e=a.typing.indexOf(c);b!==l&&e!==-1&&(a.typing=[].concat(d(a.typing.slice(0,e)),d(a.typing.slice(e+1))));var f=a.paused.indexOf(c);b!==m&&f!==-1&&(a.paused=[].concat(d(a.paused.slice(0,f)),d(a.paused.slice(f+1)))),b===l&&e===-1?a.typing=[].concat(d(a.typing),[c]):b===m&&f===-1&&(a.paused=[].concat(d(a.paused),[c]))}},{key:"_startPolling",value:function(){var a=this;this._pollId||(this._pollId=setInterval(function(){return a._poll()},5e3))}},{key:"_poll",value:function(){var a=this,b=Object.keys(this.state);b.forEach(function(b){var c=a.state[b];Object.keys(c.users).forEach(function(d){Date.now()>=c.users[d].startTime+6e3&&(a._updateState(c,n,d),delete c.users[d],a.trigger("typing-indicator-change",{conversationId:b,typing:c.typing,paused:c.paused}))})})}},{key:"_getClient",value:function(){return j.get(this.clientId)}}]),b}(i);o.prototype._pollId=0,o.prototype.clientId="",o.bubbleEventParent="_getClient",o._supportedEvents=["typing-indicator-change"].concat(i._supportedEvents),i.initClass.apply(o,[o,"TypingIndicatorListener"]),b.exports=o},{"../client-registry":9,"../root":24,"./typing-indicators":29}],29:[function(a,b,c){"use strict";b.exports={STARTED:"started",PAUSED:"paused",FINISHED:"finished"}},{}],30:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("./typing-publisher"),g=a("./typing-indicators"),h=g.STARTED,i=(g.PAUSED,g.FINISHED),j=function(){function a(b){d(this,a),this.clientId=b.clientId,this.conversation=b.conversation,this.publisher=new f({clientId:this.clientId,conversation:this.conversation}),this.intervalId=0,this.lastKeyId=0,this._handleKeyPress=this._handleKeyPress.bind(this),this._handleKeyDown=this._handleKeyDown.bind(this),this.setInput(b.input)}return e(a,[{key:"destroy",value:function(){this._removeInput(this.input),this.publisher.destroy()}},{key:"setInput",value:function(a){a!==this.input&&(this._removeInput(this.input),this.input=a,this.input.addEventListener("keypress",this._handleKeyPress),this.input.addEventListener("keydown",this._handleKeyDown))}},{key:"_removeInput",value:function(a){a&&(a.removeEventListener("keypress",this._handleKeyPress),a.removeEventListener("keydown",this._handleKeyDown),this.input=null)}},{key:"setConversation",value:function(a){a!==this.conversation&&(this.conversation=a,this.publisher.setConversation(a))}},{key:"_handleKeyPress",value:function(a){var b=this;this.lastKeyId&&window.clearTimeout(this.lastKeyId),this.lastKeyId=window.setTimeout(function(){b.lastKeyId=0;var a=!Boolean(b.input.value);b.send(a?i:h)},50)}},{key:"_handleKeyDown",value:function(a){[8,46,13].indexOf(a.keyCode)!==-1&&this._handleKeyPress()}},{key:"send",value:function(a){this.publisher.setState(a)}}]),a}();b.exports=j},{"./typing-indicators":29,"./typing-publisher":31}],31:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=2500,g=a("./typing-indicators"),h=g.STARTED,i=g.PAUSED,j=g.FINISHED,k=a("../client-registry"),l=function(){function a(b){d(this,a),this.clientId=b.clientId,b.conversation&&(this.conversation=this._getClient().getConversation(b.conversation.id)),this.state=j,this._lastMessageTime=0}return e(a,[{key:"setConversation",value:function(a){this.setState(j),this.conversation=a?this._getClient().getConversation(a.id):null,this.state=j}},{key:"setState",value:function(a){if(this._pauseLoopId&&(clearInterval(this._pauseLoopId),this._pauseLoopId=0),this.conversation){if(this.state!==a)this.state=a,this._send(a);else{if(a===j)return;Date.now()>this._lastMessageTime+f?this._send(a):this._scheduleNextMessage(a)}this.state!==j&&this._startPauseLoop()}}},{key:"_startPauseLoop",value:function(){var a=this;this._pauseLoopId||(this._pauseLoopId=window.setInterval(function(){a.state===i?a.setState(j):a.state===h&&a.setState(i)},f))}},{key:"_scheduleNextMessage",value:function(a){var b=this;this._scheduleId&&clearTimeout(this._scheduleId);var c=f-Math.min(Date.now()-this._lastMessageTime,f);this._scheduleId=setTimeout(function(){b._scheduleId=0,b.state===a&&b._send(a)},c)}},{key:"_send",value:function(a){if(this.conversation.isSaved()){this._lastMessageTime=Date.now();var b=this._getClient().socketManager;b.sendSignal({type:"typing_indicator",object:{id:this.conversation.id},data:{action:a}})}}},{key:"_getClient",value:function(){return k.get(this.clientId)}},{key:"destroy",value:function(){delete this.conversation,clearTimeout(this._scheduleId),clearInterval(this._pauseLoopId),this.isDestroyed=!0}}]),a}();b.exports=l},{"../client-registry":9,"./typing-indicators":29}],32:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("../client-utils"),g=a("../logger"),h=a("../message"),i=a("../conversation"),j=function(){function a(b){d(this,a),this.client=b.client,b.socketManager.on("message",this._handleChange,this)}return e(a,[{key:"_handleChange",value:function(a){if("change"===a.data.type){var b=a.data.body;switch(b.operation){case"create":g.info("Websocket Change Event: Create "+b.object.type+" "+b.object.id),g.debug(b.data),this._handleCreate(b);break;case"delete":g.info("Websocket Change Event: Delete "+b.object.type+" "+b.object.id),g.debug(b.data),this._handleDelete(b);break;case"patch":g.info("Websocket Change Event: Patch "+b.object.type+" "+b.object.id+": "+b.data.map(function(a){return a.property}).join(", ")),g.debug(b.data),this._handlePatch(b)}}}},{key:"_handleCreate",value:function(a){a.data.fromWebsocket=!0,this.client._createObject(a.data)}},{key:"_handleDelete",value:function(a){var b=this._getObject(a);b&&b._handleWebsocketDelete(a.data)}},{key:"_handlePatch",value:function(a){var b=this._getObject(a);if(b)try{b._inLayerParser=!0,f.layerParse({object:b,type:a.object.type,operations:a.data,client:this.client}),b._inLayerParser=!1}catch(b){g.error("websocket-manager: Failed to handle event",a.data)}else switch(f.typeFromID(a.object.id)){case"conversations":i._loadResourceForPatch(a.data)&&this.client.getConversation(a.object.id,!0);break;case"messages":h._loadResourceForPatch(a.data)&&this.client.getMessage(a.object.id,!0);break;case"announcements":}}},{key:"_getObject",value:function(a){return this.client._getObject(a.object.id)}},{key:"destroy",value:function(){this.client=null}}]),a}();j.prototype.client=null,b.exports=j},{"../client-utils":10,"../conversation":14,"../logger":18,"../message":20}],33:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("../client-utils"),g=a("../logger"),h=a("../layer-error"),i=15e3,j=function(){function a(b){d(this,a),this.client=b.client,this.socketManager=b.socketManager,this.socketManager.on({message:this._handleResponse,disconnected:this._reset},this),this._requestCallbacks={}}return e(a,[{key:"_reset",value:function(){this._requestCallbacks={}}},{key:"_handleResponse",value:function(a){if("response"===a.data.type){var b=a.data.body,c=b.request_id,d=b.success?b.data:new h(b.data);g.debug("Websocket response "+c+" "+(b.success?"Successful":"Failed")),c&&this._requestCallbacks[c]&&(this._requestCallbacks[c].callback({success:b.success,fullData:a.data,data:d}),delete this._requestCallbacks[c])}}},{key:"sendRequest",value:function(a,b){if(!this._isOpen())return b?b(new h({success:!1,data:{id:"not_connected",code:0,message:"WebSocket not connected"}})):void 0;var c=f.clone(a);c.request_id="r"+this._nextRequestId++,g.debug("Request "+c.request_id+" is sending"),b&&(this._requestCallbacks[c.request_id]={date:Date.now(),callback:b}),this.socketManager.send({type:"request",body:c}),this._scheduleCallbackCleanup()}},{key:"_scheduleCallbackCleanup",value:function(){this._callbackCleanupId||(this._callbackCleanupId=setTimeout(this._runCallbackCleanup.bind(this),i+50))}},{key:"_runCallbackCleanup",value:function(){var a=this;if(this._callbackCleanupId=0,!this.isDestroyed&&this._isOpen()){var b=0,c=Date.now();Object.keys(this._requestCallbacks).forEach(function(d){var e=a._requestCallbacks[d];if(e&&c<e.date+i)b++;else{if(c>a.socketManager._lastDataFromServerTimestamp+i)return a.socketManager._reconnect(!1),void a._scheduleCallbackCleanup();a._timeoutRequest(d)}}),b&&this._scheduleCallbackCleanup()}}},{key:"_timeoutRequest",value:function(a){try{g.warn("Websocket request timeout"),this._requestCallbacks[a].callback({success:!1,data:new h({id:"request_timeout",message:"The server is not responding. We know how much that sucks.",url:"https:/developer.layer.com/docs/websdk",code:0,status:408,httpStatus:408})})}catch(a){}delete this._requestCallbacks[a]}},{key:"_isOpen",value:function(){return this.socketManager._isOpen()}},{key:"destroy",value:function(){this.isDestroyed=!0,this._callbackCleanupId&&clearTimeout(this._callbackCleanupId),this._requestCallbacks=null}}]),a}();j.prototype._nextRequestId=1,j.prototype.client=null,j.prototype._requestCallbacks=null,j.prototype._callbackCleanupId=0,j.prototype.socketManager=null,b.exports=j},{"../client-utils":10,"../layer-error":16,"../logger":18}],34:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("../root"),j=a("../client-utils"),k=a("../logger"),l=a("../const"),m=l.WEBSOCKET_PROTOCOL,n=function(b){function c(a){d(this,c);var b=e(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,a));if(!b.client)throw new Error("SocketManager requires a client");return b._onMessage=b._onMessage.bind(b),b._onOpen=b._onOpen.bind(b),b._onSocketClose=b._onSocketClose.bind(b),b._onError=b._onError.bind(b),b.client.isAuthenticated&&b.client.onlineManager.isOnline&&b.connect(),b.client.on("online",b._onlineStateChange,b),b.client.on("authenticated",b.connect,b),b._lastTimestamp=Date.now(),b}return f(c,b),g(c,[{key:"_reset",value:function(){this._lastTimestamp=0,this._lastDataFromServerTimestamp=0,this._lastCounter=null,this._hasCounter=!1,this._inReplay=!1,this._needsReplayFrom=null}},{key:"_onlineStateChange",value:function(a){this.client.isAuthenticated&&(a.isOnline?this._reconnect(a.reset):this.close())}},{key:"_reconnect",value:function(a){this.close(),a&&this._reset(),this.connect()}},{key:"connect",value:function(b){if(!this.client.isDestroyed&&this.client.isOnline){this._closing=!1,this._lastCounter=-1;var c="undefined"==typeof WebSocket?a("websocket").w3cwebsocket:WebSocket,d=this.client.websocketUrl+"/?session_token="+this.client.sessionToken;this._socket=new c(d,m),"undefined"==typeof WebSocket?(this._socket.onmessage=this._onMessage,this._socket.onclose=this._onSocketClose,this._socket.onopen=this._onOpen,this._socket.onerror=this._onError):(this._socket.addEventListener("message",this._onMessage),this._socket.addEventListener("close",this._onSocketClose),this._socket.addEventListener("open",this._onOpen),this._socket.addEventListener("error",this._onError)),this._connectionFailedId=setTimeout(this._connectionFailed.bind(this),5e3)}}},{key:"_clearConnectionFailed",value:function(){this._connectionFailedId&&(clearTimeout(this._connectionFailedId),this._connectionFailedId=0)}},{key:"_connectionFailed",value:function(){this._connectionFailedId=0;var a="Websocket failed to connect to server";k.warn(a);try{this.isOpen=!1,this._removeSocketEvents(),this._socket&&(this._socket.close(),this._socket=null)}catch(a){}this._onError(new Error(a))}},{key:"_onOpen",value:function(){this._clearConnectionFailed(),this._isOpen()&&(this._lostConnectionCount=0,this.isOpen=!0,this.trigger("connected"),k.debug("Websocket Connected"),this._hasCounter?this.replayEvents(this._lastTimestamp,!0):this._reschedulePing())}},{key:"_isOpen",value:function(){return!!this._socket&&("undefined"==typeof WebSocket||this._socket&&this._socket.readyState===WebSocket.OPEN)}},{key:"_onError",value:function(a){this._closing||(this._clearConnectionFailed(),k.debug("Websocket Error causing websocket to close",a),this.isOpen?(this._onSocketClose(),this._socket.close(),this._socket=null):(this._removeSocketEvents(),this._lostConnectionCount++,this._scheduleReconnect()))}},{key:"sendSignal",value:function(a){this._isOpen()&&this._socket.send(JSON.stringify({type:"signal",body:a}))}},{key:"getCounter",value:function(a){k.debug("Websocket request: getCounter"),this.client.socketRequestManager.sendRequest({method:"Counter.read"},function(b){k.debug("Websocket response: getCounter "+b.data.counter),a&&(b.success?a(!0,b.data.counter,b.fullData.counter):a(!1))})}},{key:"replayEvents",value:function(a,b,c){var d=this;a&&(b&&(this._inReplay=!1),"number"==typeof a&&(a=new Date(a).toISOString()),this._inReplay||!this._isOpen()?this._needsReplayFrom||(k.debug("Websocket request: replayEvents updating _needsReplayFrom"),this._needsReplayFrom=a):(this._inReplay=!0,k.info("Websocket request: replayEvents"),this.client.socketRequestManager.sendRequest({method:"Event.replay",data:{from_timestamp:a}},function(b){return d._replayEventsComplete(a,c,b.success)})))}},{key:"_replayEventsComplete",value:function(a,b,c){if(this._inReplay=!1,c&&!this._needsReplayFrom)k.info("Websocket replay complete"),this.trigger("synced"),b&&b();else if(c&&this._needsReplayFrom){k.info("Websocket replay partially complete");var d=this._needsReplayFrom;this._needsReplayFrom=null,this.replayEvents(d)}else k.info("Websocket replay retry"),this.replayEvents(a)}},{key:"_onMessage",value:function(a){this._lostConnectionCount=0;try{var b=JSON.parse(a.data),c=this._lastCounter+1!==b.counter;
this._hasCounter=!0,this._lastCounter=b.counter,this._lastDataFromServerTimestamp=Date.now(),c?this.replayEvents(this._lastTimestamp):this._lastTimestamp=new Date(b.timestamp).getTime(),this.trigger("message",{data:b}),this._reschedulePing()}catch(b){k.error("Layer-Websocket: Failed to handle websocket message: "+b+"\n",a.data)}}},{key:"_reschedulePing",value:function(){this._nextPingId&&clearTimeout(this._nextPingId),this._nextPingId=setTimeout(this._ping.bind(this),this.pingFrequency)}},{key:"_ping",value:function(){k.debug("Websocket ping"),this._nextPingId=0,this._isOpen()&&this.getCounter(this._reschedulePing.bind(this))}},{key:"close",value:function(){k.debug("Websocket close requested"),this._closing=!0,this.isOpen=!1,this._socket&&(this._onSocketClose(),this._socket.close(),this._socket=null)}},{key:"send",value:function(a){this._socket.send(JSON.stringify(a))}},{key:"destroy",value:function(){this.close(),this._nextPingId&&clearTimeout(this._nextPingId),h(c.prototype.__proto__||Object.getPrototypeOf(c.prototype),"destroy",this).call(this)}},{key:"_onSocketClose",value:function(){k.debug("Websocket closed"),this.isOpen=!1,this._closing||this._scheduleReconnect(),this._removeSocketEvents(),this.trigger("disconnected")}},{key:"_removeSocketEvents",value:function(){"undefined"!=typeof WebSocket&&this._socket?(this._socket.removeEventListener("message",this._onMessage),this._socket.removeEventListener("close",this._onSocketClose),this._socket.removeEventListener("open",this._onOpen),this._socket.removeEventListener("error",this._onError)):this._socket&&(this._socket.onmessage=null,this._socket.onclose=null,this._socket.onopen=null,this._socket.onerror=null)}},{key:"_scheduleReconnect",value:function(){if(!this.isDestroyed&&this.client.isOnline){var a=(this.client.onlineManager.pingFrequency-1e3)/1e3,b=j.getExponentialBackoffSeconds(a,Math.min(15,this._lostConnectionCount));k.debug("Websocket Reconnect in "+b+" seconds"),this._reconnectId=setTimeout(this._validateSessionBeforeReconnect.bind(this),1e3*b)}}},{key:"_validateSessionBeforeReconnect",value:function(){var a=this;!this.isDestroyed&&this.client.isOnline&&this.client.xhr({url:"/",method:"GET",sync:!1},function(b){b.success&&a.connect()})}}]),c}(i);n.prototype.isOpen=!1,n.prototype._reconnectId=0,n.prototype._connectionFailedId=0,n.prototype._lastTimestamp=0,n.prototype._lastDataFromServerTimestamp=0,n.prototype._lastCounter=null,n.prototype._hasCounter=!1,n.prototype._inReplay=!1,n.prototype._needsReplayFrom=null,n.prototype.pingFrequency=3e4,n.prototype.client=null,n.prototype._socket=null,n.prototype._closing=!1,n.prototype._lostConnectionCount=0,n._supportedEvents=["message","connected","disconnected","syncing","synced"].concat(i._supportedEvents),i.initClass.apply(n,[n,"SocketManager"]),b.exports=n},{"../client-utils":10,"../const":12,"../logger":18,"../root":24,websocket:3}],35:[function(a,b,c){"use strict";function d(a){if(!a)return{};var b=a.split(","),c={};return b.forEach(function(a){var b=a.split(";");if(2===b.length){var d=b[0].replace(/<(.*)>/,"$1").trim(),e=b[1].replace(/rel='?(.*)'?/,"$1").trim();c[e]=d}}),c}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},f="undefined"==typeof window?a("xhr2"):null;b.exports=function(a,c){var g=f?new f:new XMLHttpRequest,h=(a.method||"GET").toUpperCase(),i=function(){var f={"content-type":this.getResponseHeader("content-type")},g={status:this.status,success:this.status&&this.status<300,xhr:this},h=String(f["content-type"]).split(/;/)[0].match(/^application\/json/)||"json"===a.format;if("blob"===this.responseType||"arraybuffer"===this.responseType)0===this.status?g.data=new Error("Connection Failed"):g.data="function"==typeof this.response?this.responseText:this.response;else{if(h&&this.responseText)try{g.data=JSON.parse(this.responseText)}catch(a){g.data={code:999,message:"Invalid JSON from server",response:this.responseText},g.status=999}else g.data=this.responseText;b.exports.trigger({target:this,status:this.responseText||this.status?"connection:success":"connection:error"}),this.responseText||this.status?404===this.status&&"object"!==e(g.data)?g.data={id:"operation_not_found",message:"Endpoint "+(a.method||"GET")+" "+a.url+" does not exist",status:this.status,httpStatus:404,code:106,url:"https://docs.layer.com/reference/client_api/errors"}:"string"==typeof g.data&&this.status>=400&&(g.data={id:"unknown_error",message:g.data,status:this.status,httpStatus:this.status,code:0,url:"https://www.google.com/search?q=doh!"}):(g.status=408,g.data={id:"request_timeout",message:"The server is not responding please try again in a few minutes",url:"https://docs.layer.com/reference/client_api/errors",code:0,status:408,httpStatus:408})}if(a.headers&&(a.headers.accept||"").match(/application\/vnd.layer\+json/)){var i=this.getResponseHeader("link");i&&(g.Links=d(i))}g.xhr=this,c&&c(g)};g.onload=i,g.onerror=g.ontimeout=i;var j=Object.keys(a.headers||{}),k={};j.forEach(function(b){"content-type"===b.toLowerCase()?k["content-type"]=a.headers[b]:k[b.toLowerCase()]=a.headers[b]}),a.headers=k;var l="";a.data&&("undefined"!=typeof Blob&&a.data instanceof Blob?l=a.data:a.headers&&(String(a.headers["content-type"]).match(/^application\/json/)||"application/vnd.layer-patch+json"===String(a.headers["content-type"]))?l="string"==typeof a.data?a.data:JSON.stringify(a.data):a.data&&"object"===e(a.data)?Object.keys(a.data).forEach(function(b){l&&(l+="&"),l+=b+"="+a.data[b]}):l=a.data),l&&"GET"===h&&(a.url+="?"+l),g.open(h,a.url,!0),a.timeout&&(g.timeout=a.timeout),a.withCredentials&&(g.withCredentials=!0),a.responseType&&(g.responseType=a.responseType),a.headers&&Object.keys(a.headers).forEach(function(b){return g.setRequestHeader(b,a.headers[b])});try{"GET"===h?g.send():g.send(l)}catch(a){}};var g=[];b.exports.addConnectionListener=function(a){return g.push(a)},b.exports.trigger=function(a){g.forEach(function(b){b(a)})}},{xhr2:3}]},{},[1])(1)});