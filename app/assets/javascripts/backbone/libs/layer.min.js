/*! layer-websdk - v1.0.6 - 2016-06-01 */ !function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.layer=a()}}(function(){var a;return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){"use strict";b.exports={Root:a("./src/root"),Client:a("./src/client"),ClientAuthenticator:a("./src/client-authenticator"),Conversation:a("./src/conversation"),Message:a("./src/message"),MessagePart:a("./src/message-part"),Query:a("./src/query"),QueryBuilder:a("./src/query-builder"),xhr:a("./src/xhr"),User:a("./src/user"),LayerError:a("./src/layer-error"),LayerEvent:a("./src/layer-event"),Content:a("./src/content"),SyncManager:a("./src/sync-manager"),SyncEvent:a("./src/sync-event").SyncEvent,XHRSyncEvent:a("./src/sync-event").XHRSyncEvent,WebsocketSyncEvent:a("./src/sync-event").WebsocketSyncEvent,Websockets:{SocketManager:a("./src/websockets/socket-manager"),RequestManager:a("./src/websockets/request-manager"),ChangeManager:a("./src/websockets/change-manager")},OnlineStateManager:a("./src/online-state-manager"),Constants:a("./src/const"),Util:a("./src/client-utils"),TypingIndicators:a("./src/typing-indicators/typing-indicators")},b.exports.TypingIndicators.TypingListener=a("./src/typing-indicators/typing-listener"),b.exports.TypingIndicators.TypingPublisher=a("./src/typing-indicators/typing-publisher")},{"./src/client":8,"./src/client-authenticator":5,"./src/client-utils":7,"./src/const":9,"./src/content":10,"./src/conversation":11,"./src/layer-error":12,"./src/layer-event":13,"./src/message":16,"./src/message-part":15,"./src/online-state-manager":17,"./src/query":19,"./src/query-builder":18,"./src/root":20,"./src/sync-event":21,"./src/sync-manager":22,"./src/typing-indicators/typing-indicators":25,"./src/typing-indicators/typing-listener":26,"./src/typing-indicators/typing-publisher":27,"./src/user":28,"./src/websockets/change-manager":29,"./src/websockets/request-manager":30,"./src/websockets/socket-manager":31,"./src/xhr":32}],2:[function(b,c,d){!function(){function b(){return{keys:Object.keys||function(a){if("object"!=typeof a&&"function"!=typeof a||null===a)throw new TypeError("keys() called on a non-object");var b,c=[];for(b in a)a.hasOwnProperty(b)&&(c[c.length]=b);return c},uniqueId:function(a){var b=++j+"";return a?a+b:b},has:function(a,b){return h.call(a,b)},each:function(a,b,c){if(null!=a)if(g&&a.forEach===g)a.forEach(b,c);else if(a.length===+a.length)for(var d=0,e=a.length;e>d;d++)b.call(c,a[d],d,a);else for(var f in a)this.has(a,f)&&b.call(c,a[f],f,a)},once:function(a){var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}}}}var e,f=this,g=Array.prototype.forEach,h=Object.prototype.hasOwnProperty,i=Array.prototype.slice,j=0,k=b();e={on:function(a,b,c){if(!m(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!m(this,"once",a,[b,c])||!b)return this;var d=this,e=k.once(function(){d.off(a,e),b.apply(this,arguments)});return e._callback=b,this.on(a,e,c)},off:function(a,b,c){var d,e,f,g,h,i,j,l;if(!this._events||!m(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events={},this;for(g=a?[a]:k.keys(this._events),h=0,i=g.length;i>h;h++)if(a=g[h],f=this._events[a]){if(this._events[a]=d=[],b||c)for(j=0,l=f.length;l>j;j++)e=f[j],(b&&b!==e.callback&&b!==e.callback._callback||c&&c!==e.context)&&d.push(e);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=i.call(arguments,1);if(!m(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&n(c,b),d&&n(d,arguments),this},stopListening:function(a,b,c){var d=this._listeners;if(!d)return this;var e=!b&&!c;"object"==typeof b&&(c=this),a&&((d={})[a._listenerId]=a);for(var f in d)d[f].off(b,c,this),e&&delete this._listeners[f];return this}};var l=/\s+/,m=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(l.test(c)){for(var f=c.split(l),g=0,h=f.length;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},n=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},o={listenTo:"on",listenToOnce:"once"};k.each(o,function(a,b){e[b]=function(b,c,d){var e=this._listeners||(this._listeners={}),f=b._listenerId||(b._listenerId=k.uniqueId("l"));return e[f]=b,"object"==typeof c&&(d=this),b[a](c,d,this),this}}),e.bind=e.on,e.unbind=e.off,e.mixin=function(a){var b=["on","once","off","trigger","stopListening","listenTo","listenToOnce","bind","unbind"];return k.each(b,function(b){a[b]=this[b]},this),a},"undefined"!=typeof d?("undefined"!=typeof c&&c.exports&&(d=c.exports=e),d.BackboneEvents=e):"function"==typeof a&&"object"==typeof a.amd?a(function(){return e}):f.BackboneEvents=e}(this)},{}],3:[function(a,b,c){},{}],4:[function(a,b,c){!function(){function a(a){return this.camelCase=a.camelCase,this.propertyNameMap=a.propertyNameMap,this.changeCallbacks=a.changeCallbacks,this.abortCallbacks=a.abortCallbacks,this.getObjectCallback=a.getObjectCallback,this.doesObjectMatchIdCallback=a.doesObjectMatchIdCallback||function(a,b){return b.id==a},this.returnIds=a.returnIds,this}function c(a,b,c){this.changeCallbacks&&c&&this.changeCallbacks[c]&&Object.keys(a).forEach(function(d){this.changeCallbacks[c].all?this.changeCallbacks[c].all(b,b[d],a[d].before,a[d].paths):this.changeCallbacks[c][d]&&this.changeCallbacks[c][d](b,b[d],a[d].before,a[d].paths)},this)}function d(a,b,c,d){var e=b.object,g=String.fromCharCode(145);a=a.replace(/\\\./g,g),a=a.replace(/\\(.)/g,"$1");var h=a.split(/\./),i=new RegExp(g,"g");if(h=h.map(function(a){return a.replace(i,".")}),this.camelCase&&(h[0]=h[0].replace(/[-_]./g,function(a){return a[1].toUpperCase()})),this.propertyNameMap){var j=this.propertyNameMap[b.type];h[0]=j&&j[h[0]]||h[0]}f.apply(this,[{baseName:h[0],fullPath:a,object:b.object,options:b,changes:c,operation:d}]);for(var k=e,l=0;l<h.length-1;l++){var m=h[l];if(m in k){if(k=k[m],null===k||"object"!=typeof k)throw new Error("Can not access property '"+a+"'")}else k[m]={},k=k[m]}return{pointer:k,lastName:h[h.length-1],baseName:h[0],fullPath:a,abortHandler:this.abortCallbacks&&this.abortCallbacks[b.type]&&(this.abortCallbacks[b.type].all||this.abortCallbacks[b.type][h[0]])}}function e(a,b){if(a.id){if(!this.getObjectCallback)throw new Error("Must provide getObjectCallback in constructor to use ids");var c=this.getObjectCallback(a.id);return c?c:this.returnIds?a.id:null}return a.value}function f(a){if(!a.changes[a.baseName]){var b=a.object[a.baseName];"id"in a.operation&&b&&(b=b.id);var c=a.changes[a.baseName]={paths:[]};c.before=b&&"object"==typeof b?JSON.parse(JSON.stringify(b)):b}var d=a.changes[a.baseName].paths;-1===d.indexOf(a.fullPath)&&d.push(a.fullPath)}function g(a,b,c,d,e){a.abortHandler&&a.abortHandler(a.fullPath,"set",b)||(a.pointer[a.lastName]=b)}function h(a,b,c,d,e){a.abortHandler&&a.abortHandler(a.fullPath,"delete",b)||delete a.pointer[a.lastName]}function i(a,b,c,d,e){if(!a.abortHandler||!a.abortHandler(a.fullPath,"add",b)){var f;if(f=a.lastName in a.pointer?a.pointer[a.lastName]:a.pointer[a.lastName]=[],!Array.isArray(f))throw new Error("The add operation requires an array or new structure to add to.");if(!c.id){if(Array.isArray(b))throw new Error("The add operation will not add arrays to sets.");if(b&&"object"==typeof b)throw new Error("The add operation will not add objects to sets.")}-1===f.indexOf(b)&&f.push(b)}}function j(a,b,c,d,e){if(!a.abortHandler||!a.abortHandler(a.fullPath,"remove",b)){var f;if(f=a.lastName in a.pointer?a.pointer[a.lastName]:a.pointer[a.lastName]=[],!Array.isArray(f))throw new Error("The remove operation requires an array or new structure to remove from.");if(c.id){for(var g=0;g<f.length;g++)if(this.doesObjectMatchIdCallback(c.id,f[g])){f.splice(g,1);break}}else{if(Array.isArray(b))throw new Error("The remove operation will not remove arrays from sets.");if(b&&"object"==typeof b)throw new Error("The remove operation will not remove objects from sets.");var h=f.indexOf(b);-1!==h&&f.splice(h,1)}}}var k={set:g,delete:h,add:i,remove:j};"undefined"!=typeof b?b.exports=a:window.LayerPatchParser=a,a.prototype.parse=function(a){var b={};a.operations.forEach(function(c){var f=d.apply(this,[c.property,a,b,c]);k[c.operation].call(this,f,e.apply(this,[c,a]),c,a,b)},this),c.apply(this,[b,a.object,a.type])}}()},{}],5:[function(a,b,c){(function(c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=a("./xhr"),j=a("./root"),k=a("./websockets/socket-manager"),l=a("./websockets/change-manager"),m=a("./websockets/request-manager"),LayerError=a("./layer-error"),n=a("./online-state-manager"),SyncManager=a("./sync-manager"),o=a("./sync-event"),p=o.XHRSyncEvent,q=o.WebsocketSyncEvent,r=a("./const"),s=r.ACCEPT,t=r.LOCALSTORAGE_KEYS,u=a("./client-utils"),v=a("./logger"),w=3,x=function(a){function b(a){if(d(this,b),!a.appId)throw new Error(LayerError.dictionary.appIdMissing);var f=a.userId,g="",h="";try{g=c.localStorage?c.localStorage[t.SESSIONDATA+a.appId]:null,h=g?JSON.parse(g).userId:""}catch(a){}delete a.userId;var i=e(this,Object.getPrototypeOf(b).call(this,a));return i.url=i.url.replace(/\/$/,""),!i.sessionToken&&f&&i.isTrustedDevice?i._restoreLastSession(a,f,h):c.localStorage&&(localStorage.removeItem(t.SESSIONDATA+i.appId),i.sessionToken&&f&&(i.userId=f)),i}return f(b,a),h(b,[{key:"_restoreLastSession",value:function(a,b,c){var d=a.sessionToken||this._getSessionToken();a.sessionToken?this.userId=b:d&&c===b?(this.sessionToken=d,this.userId=b):(this.sessionToken="",this.userId="")}},{key:"_initComponents",value:function(){this.socketManager=new k({client:this}),this.socketChangeManager=new l({client:this,socketManager:this.socketManager}),this.socketRequestManager=new m({client:this,socketManager:this.socketManager}),this.onlineManager=new n({socketManager:this.socketManager,testUrl:this.url+"/nonces?connection-test",connected:this._handleOnlineChange.bind(this),disconnected:this._handleOnlineChange.bind(this)}),this.syncManager=new SyncManager({onlineManager:this.onlineManager,socketManager:this.socketManager,requestManager:this.socketRequestManager,client:this}),this._connect()}},{key:"_destroyComponents",value:function(){this.syncManager.destroy(),this.onlineManager.destroy(),this.socketManager.destroy(),this.socketChangeManager.destroy(),this.socketRequestManager.destroy()}},{key:"_getSessionToken",value:function(){if(this.sessionToken)return this.sessionToken;var a=c.localStorage?c.localStorage[t.SESSIONDATA+this.appId]:"{}";try{return JSON.parse(a).sessionToken}catch(a){return""}}},{key:"_connect",value:function(){var a=this;this.sessionToken?this.xhr({url:"/messages/ffffffff-ffff-ffff-ffff-ffffffffffff",method:"GET",sync:!1,headers:{"content-type":"application/json"}},function(b){return a._connectionWithSessionResponse(b)}):this.xhr({url:"/nonces",method:"POST",sync:!1},function(b){return a._connectionResponse(b)})}},{key:"_connectionWithSessionResponse",value:function(a){!a.success&&a.data.getNonce()?this._sessionTokenExpired(a.data.getNonce()):this._sessionTokenRestored(a.data)}},{key:"_connectionResponse",value:function(a){a.success?this._connectionComplete(a.data):this._connectionError(a.data)}},{key:"_connectionComplete",value:function(a){this.isConnected=!0,this.trigger("connected"),this._authenticate(a.nonce)}},{key:"_connectionError",value:function(a){this.trigger("connected-error",{error:a})}},{key:"_authenticate",value:function(a){a&&this.trigger("challenge",{nonce:a,callback:this.answerAuthenticationChallenge.bind(this)})}},{key:"answerAuthenticationChallenge",value:function(a){var b=this;if(!a)throw new Error(LayerError.dictionary.identityTokenMissing);var c=u.decode(a.split(".")[1]);this.__userId=JSON.parse(c).prn,this.xhr({url:"/sessions",method:"POST",sync:!1,data:{identity_token:a,app_id:this.appId}},function(c){return b._authResponse(c,a)})}},{key:"_authResponse",value:function(a,b){a.success?this._authComplete(a.data):this._authError(a.data,b)}},{key:"_authComplete",value:function(a){if(!a||!a.session_token)throw new Error(LayerError.dictionary.sessionTokenMissing);if(this.sessionToken=a.session_token,c.localStorage&&this.isTrustedDevice)try{c.localStorage[t.SESSIONDATA+this.appId]=JSON.stringify({sessionToken:this.sessionToken||"",userId:this.userId||""})}catch(a){}this.isAuthenticated=!0,this.trigger("authenticated"),this._clientReady()}},{key:"_authError",value:function(a,b){this.trigger("authenticated-error",{error:a})}},{key:"_sessionTokenRestored",value:function(a){this.isConnected=!0,this.trigger("connected"),this.isAuthenticated=!0,this.trigger("authenticated"),this._clientReady()}},{key:"_sessionTokenExpired",value:function(a){this.sessionToken="",c.localStorage&&localStorage.removeItem(t.SESSIONDATA+this.appId),this._authenticate(a)}},{key:"_clientReady",value:function(){this.isReady||(this.isReady=!0,this.trigger("ready"),this.onlineManager.start())}},{key:"logout",value:function(){return this.isAuthenticated&&this.xhr({method:"DELETE",url:"/sessions/"+escape(this.sessionToken)}),this._resetSession(),this}},{key:"login",value:function(){return this._connect(),this}},{key:"_resetSession",value:function(){this.isReady=!1,this.sessionToken&&(this.sessionToken="",c.localStorage&&localStorage.removeItem(t.SESSIONDATA+this.appId)),this.isConnected=!1,this.isAuthenticated=!1,this.trigger("deauthenticated"),this.onlineManager.stop()}},{key:"registerIOSPushToken",value:function(a,b){this.xhr({url:"push_tokens",method:"POST",sync:!1,data:{token:a.token,type:"apns",device_id:a.deviceId,ios_version:a.iosVersion,apns_bundle_id:a.bundleId}},function(a){return b(a.data)})}},{key:"registerAndroidPushToken",value:function(a,b){this.xhr({url:"push_tokens",method:"POST",sync:!1,data:{token:a.token,type:"gcm",device_id:a.deviceId,gcm_sender_id:a.senderId}},function(a){return b(a.data)})}},{key:"unregisterPushToken",value:function(a,b){this.xhr({url:"push_tokens/"+a,method:"DELETE"},function(a){return b(a.data)})}},{key:"__adjustAppId",value:function(a){if(this.isConnected)throw new Error(LayerError.dictionary.cantChangeIfConnected)}},{key:"__adjustUserId",value:function(a){if(this.isConnected)throw new Error(LayerError.dictionary.cantChangeIfConnected)}},{key:"sendSocketRequest",value:function(a,b){if(a.sync){var c=a.sync.target,d=a.sync.depends;c&&!d&&(d=[c]),this.syncManager.request(new q({data:a.body,operation:a.method,target:c,depends:d,callback:b}))}else"function"==typeof a.data&&(a.data=a.data()),this.socketRequestManager.sendRequest(a,b)}},{key:"_handleOnlineChange",value:function(a){if(this.isAuthenticated){var c=a.offlineDuration,d="connected"===a.eventName,e={isOnline:d};d&&(e.reset=c>b.ResetAfterOfflineDuration),this.trigger("online",e)}}},{key:"xhr",value:function(a,b){return"string"==typeof a.url&&(a.url=this._xhrFixRelativeUrls(a.url)),a.withCredentials=!0,a.method||(a.method="GET"),a.headers||(a.headers={}),this._xhrFixHeaders(a.headers),this._xhrFixAuth(a.headers),a.sync===!1?this._nonsyncXhr(a,b,0):this._syncXhr(a,b),this}},{key:"_syncXhr",value:function(a,b){var c=this;a.sync||(a.sync={});var d=function(a){c._xhrResult(a,b)},e=a.sync.target,f=a.sync.depends;e&&!f&&(f=[e]),this.syncManager.request(new p({url:a.url,data:a.data,method:a.method,operation:a.sync.operation||a.method,headers:a.headers,callback:d,target:e,depends:f}))}},{key:"_nonsyncXhr",value:function(a,b,c){var d=this;i(a,function(e){-1!==[502,503,504].indexOf(e.status)&&w>c?setTimeout(function(){return d._nonsyncXhr(a,b,c+1)},1e3):d._xhrResult(e,b)})}},{key:"_xhrFixAuth",value:function(a){this.sessionToken&&!a.Authorization&&(a.authorization='Layer session-token="'+this.sessionToken+'"')}},{key:"_xhrFixRelativeUrls",value:function(a){var b=a;return-1===a.indexOf("https://")&&(b="/"===a[0]?this.url+a:this.url+"/"+a),b}},{key:"_xhrFixHeaders",value:function(a){var b=Object.keys(a);b.forEach(function(b){b!==b.toLowerCase()&&(a[b.toLowerCase()]=a[b],delete a[b])}),a.accept||(a.accept=s),a["content-type"]||(a["content-type"]="application/json")}},{key:"_xhrResult",value:function(a,b){this.isDestroyed||(a.success||(a.data&&"object"===g(a.data)&&this._generateError(a),401===a.status&&this.isAuthenticated&&(v.warn("SESSION EXPIRED!"),this.isAuthenticated=!1,this.trigger("deauthenticated"),this._authenticate(a.data.getNonce()))),b&&b(a))}},{key:"_generateError",value:function(a){a.data=new LayerError(a.data),a.data.httpStatus||(a.data.httpStatus=a.status),a.data.log()}}]),b}(j);x.prototype.isAuthenticated=!1,x.prototype.isConnected=!1,x.prototype.isReady=!1,x.prototype.appId="",x.prototype.userId="",x.prototype.sessionToken="",x.prototype.url="https://api.layer.com",x.prototype.socketManager=null,x.prototype.socketRequestManager=null,x.prototype.socketChangeManager=null,x.prototype.syncManager=null,x.prototype.onlineManager=null,Object.defineProperty(x.prototype,"isOnline",{enumerable:!0,get:function(){return this.onlineManager&&this.onlineManager.isOnline}}),Object.defineProperty(x.prototype,"logLevel",{enumerable:!1,get:function(){return v.level},set:function(a){v.level=a}}),x.prototype.isTrustedDevice=!1,x.ResetAfterOfflineDuration=108e6,x._supportedEvents=["ready","connected","connected-error","authenticated","authenticated-error","deauthenticated","challenge","session-terminated","online"].concat(j._supportedEvents),j.initClass.apply(x,[x,"ClientAuthenticator"]),b.exports=x}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./client-utils":7,"./const":9,"./layer-error":12,"./logger":14,"./online-state-manager":17,"./root":20,"./sync-event":21,"./sync-manager":22,"./websockets/change-manager":29,"./websockets/request-manager":30,"./websockets/socket-manager":31,"./xhr":32}],6:[function(a,b,c){"use strict";function d(a){var b=a.appId;h[b]&&!h[b].isDestroyed&&h[b].destroy(),h[b]=a}function e(a){h[a.appId]&&delete h[a.appId]}function f(a){return h[a]}function g(){return Object.keys(h).map(function(a){return h[a]})}var h={};b.exports={get:f,getAll:g,register:d,unregister:e}},{}],7:[function(a,b,c){"use strict";function d(){var a=new Uint16Array(8);k(a);var b=function(a){for(var b=a.toString(16);b.length<4;)b="0"+b;return b};return b(a[0])+b(a[1])+"-"+b(a[2])+"-"+b(a[3])+"-"+b(a[4])+"-"+b(a[5])+b(a[6])+b(a[7])}function e(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function f(a){a.client.once("destroy",function(){return l=null}),l=new h({camelCase:!0,getObjectCallback:function(b){return a.client._getObject(b)},propertyNameMap:{Conversation:{unreadMessageCount:"unreadCount"}},changeCallbacks:{Message:{all:function(a,b,c,d){a._handlePatchEvent(b,c,d)}},Conversation:{all:function(a,b,c,d){a._handlePatchEvent(b,c,d)}}}})}var g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},h=a("layer-patch"),i="undefined"!=typeof window?window.crypto||window.msCrypto:null,j="undefined"==typeof window?a("atob"):window.atob,k=void 0;"undefined"==typeof window?k=a("get-random-values"):i&&(k=i.getRandomValues.bind(i)),c.generateUUID=k?d:e,c.typeFromID=function(a){var b=a.match(/layer\:\/\/\/(.*?)\//);return b?b[1]:""},c.isEmpty=function(a){return"[object Object]"===Object.prototype.toString.apply(a)&&0===Object.keys(a).length},c.sortBy=function(a,b,c){c=c?-1:1,a.sort(function(a,d){var e=b(a),f=b(d);return void 0===e&&void 0===f?0:void 0===e&&void 0!==f?1:void 0!==e&&void 0===f?-1:e>f?1*c:f>e?-1*c:0})},c.clone=function(a){return JSON.parse(JSON.stringify(a))},c.defer=function(a){return setTimeout(a,0)},c.decode=function(a){var b=a.replace("-","+").replace("_","/");switch(b.length%4){case 0:break;case 2:b+="==";break;case 3:b+="=";break;default:throw new Error("Illegal base64url string!")}return j(b)},c.getExponentialBackoffSeconds=function(a,b){var c=Math.pow(2,b)/10,d=Math.random();return 2>b?d/=4:6>b&&(d/=2),c>=a&&(c=a),c+d};var l=void 0;c.layerParse=function(a){l||f(a),l.parse(a)},c.doesObjectMatch=function(a,b){if(!a&&b||a&&!b)return!1;var d=Object.keys(a).sort(),e=Object.keys(b).sort();if(d.length!==e.length)return!1;for(var f=0;f<d.length;f++){var h=d[f],i=e[f],j=a[h],k=b[i];if(h!==i)return!1;if(j&&"object"===("undefined"==typeof j?"undefined":g(j))){if(Array.isArray(j))throw new Error("Array comparison not handled yet");if(!c.doesObjectMatch(j,k))return!1}else if(j!==k)return!1}return!0},c.includes=function(a,b){return-1!==a.indexOf(b)}},{atob:3,"get-random-values":3,"layer-patch":4}],8:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./client-authenticator"),Conversation=a("./conversation"),Query=a("./query"),LayerError=a("./layer-error"),Message=a("./message"),User=a("./user"),j=a("./typing-indicators/typing-indicator-listener"),k=a("./client-utils"),l=a("./root"),m=a("./client-registry"),n=a("./logger"),Client=function(b){function Client(a){d(this,Client);var b=e(this,Object.getPrototypeOf(Client).call(this,a));return m.register(b),b._conversationsHash={},b._messagesHash={},b._tempConversationsHash={},b._tempMessagesHash={},b._queriesHash={},a.users?b.__updateUsers(b.users):b.users=[],b._initComponents(),b.on("online",b._connectionRestored.bind(b)),b}return f(Client,b),g(Client,[{key:"_initComponents",value:function(){var a=this;h(Object.getPrototypeOf(Client.prototype),"_initComponents",this).call(this),this._typingIndicators=new j({clientId:this.appId}),Object.keys(Client.plugins).forEach(function(b){a[b]=new Client.plugins[b](a)})}},{key:"_cleanup",value:function(){var a=this;this.isDestroyed||(this._inCleanup=!0,Object.keys(this._conversationsHash).forEach(function(b){var c=a._conversationsHash[b];c&&!c.isDestroyed&&c.destroy()}),this._conversationsHash=null,Object.keys(this._messagesHash).forEach(function(b){var c=a._messagesHash[b];c&&!c.isDestroyed&&c.destroy()}),this._messagesHash=null,Object.keys(this._queriesHash).forEach(function(b){a._queriesHash[b].destroy()}),this._queriesHash=null,this.users&&[].concat(this.users).forEach(function(a){return a.destroy?a.destroy():null}),this.users=[],this.socketManager&&this.socketManager.close())}},{key:"destroy",value:function(){var a=this;Object.keys(Client.plugins).forEach(function(b){a[b]&&(a[b].destroy(),delete a[b])}),this._cleanup(),this._destroyComponents(),m.unregister(this),h(Object.getPrototypeOf(Client.prototype),"destroy",this).call(this),this._inCleanup=!1}},{key:"getConversation",value:function(a,b){if("string"!=typeof a)throw new Error(LayerError.dictionary.idParamRequired);return this._conversationsHash[a]?this._conversationsHash[a]:this._tempConversationsHash[a]&&this._conversationsHash[this._tempConversationsHash[a]]?this._conversationsHash[this._tempConversationsHash[a]]:b?Conversation.load(a,this):void 0}},{key:"_addConversation",value:function(a){var b=a.id;return this._conversationsHash[b]||(this._conversationsHash[b]=a,a.clientId!==this.appId&&(a.clientId=this.appId),this._triggerAsync("conversations:add",{conversations:[a]})),this}},{key:"_removeConversation",value:function(a){var b=this;return a.off(null,null,this),this._conversationsHash[a.id]&&(delete this._conversationsHash[a.id],this._triggerAsync("conversations:remove",{conversations:[a]})),delete this._tempConversationsHash[a._tempId],Object.keys(this._messagesHash).forEach(function(c){b._messagesHash[c].conversationId===a.id&&b._messagesHash[c].destroy()}),this}},{key:"_updateConversationId",value:function(a,b){var c=this;this._conversationsHash[b]&&(this._conversationsHash[a.id]=a,delete this._conversationsHash[b],this._tempConversationsHash[b]=a.id,Object.keys(this._messagesHash).filter(function(a){return c._messagesHash[a].conversationId===b}).forEach(function(b){return c._messagesHash[b].conversationId=a.id}))}},{key:"getMessage",value:function(a,b){if("string"!=typeof a)throw new Error(LayerError.dictionary.idParamRequired);return this._messagesHash[a]?this._messagesHash[a]:this._tempMessagesHash[a]&&this._messagesHash[this._tempMessagesHash[a]]?this._messagesHash[this._tempMessagesHash[a]]:b?Message.load(a,this):void 0}},{key:"getMessagePart",value:function(a){if("string"!=typeof a)throw new Error(LayerError.dictionary.idParamRequired);var b=a.replace(/\/parts.*$/,""),c=this.getMessage(b);return c?c.getPartById(a):void 0}},{key:"_addMessage",value:function(a){if(!this._messagesHash[a.id]){this._messagesHash[a.id]=a,this._triggerAsync("messages:add",{messages:[a]}),a._notify&&(this._triggerAsync("messages:notify",{message:a}),a._notify=!1);var b=a.getConversation();b&&(!b.lastMessage||b.lastMessage.position<a.position)&&(b.lastMessage=a)}}},{key:"_removeMessage",value:function(a){var b="string"==typeof a?a:a.id;if(a=this._messagesHash[b],a&&(delete this._messagesHash[b],delete this._tempMessagesHash[a._tempId],!this._inCleanup)){this._triggerAsync("messages:remove",{messages:[a]});var c=a.getConversation();c&&c.lastMessage===a&&(c.lastMessage=null)}}},{key:"_updateMessageId",value:function(a,b){this._messagesHash[a.id]=a,delete this._messagesHash[b],this._tempMessagesHash[b]=a.id}},{key:"_getObject",value:function(a){switch(k.typeFromID(a)){case"messages":return this.getMessage(a);case"conversations":return this.getConversation(a);case"queries":return this.getQuery(a)}}},{key:"_createObject",value:function(a){switch(k.typeFromID(a.id)){case"messages":var b=this.getConversation(a.conversation.id,!0);return Message._createFromServer(a,b);case"conversations":return Conversation._createFromServer(a,this)}}},{key:"_processDelayedTriggers",value:function(){if(!this.isDestroyed){var a=this._delayedTriggers.filter(function(a){return"conversations:add"===a[0]}),b=this._delayedTriggers.filter(function(a){return"conversations:remove"===a[0]});this._foldEvents(a,"conversations",this),this._foldEvents(b,"conversations",this);var c=this._delayedTriggers.filter(function(a){return"messages:add"===a[0]}),d=this._delayedTriggers.filter(function(a){return"messages:remove"===a[0]});this._foldEvents(c,"messages",this),this._foldEvents(d,"messages",this),h(Object.getPrototypeOf(Client.prototype),"_processDelayedTriggers",this).call(this)}}},{key:"trigger",value:function(a,b){this._triggerLogger(a,b),h(Object.getPrototypeOf(Client.prototype),"trigger",this).call(this,a,b)}},{key:"_triggerLogger",value:function(a,b){var c=["conversations:add","conversations:remove","conversations:change","messages:add","messages:remove","messages:change","challenge","ready"];if(-1!==c.indexOf(a)){if(b&&b.isChange)n.info("Client Event: "+a+" "+b.changes.map(function(a){return a.property}).join(", "));else{var d="";b&&(b.message&&(d=b.message.id),b.messages&&(d=b.messages.length+" messages"),b.conversation&&(d=b.conversation.id),b.conversations&&(d=b.conversations.length+" conversations")),n.info("Client Event: "+a+" "+d)}b&&n.debug(b)}else n.debug(a,b)}},{key:"findCachedConversation",value:function(a,b){for(var c=b?a.bind(b):a,d=Object.keys(this._conversationsHash),e=d.length,f=0;e>f;f++){var g=d[f],h=this._conversationsHash[g];if(c(h,f))return h}}},{key:"_resetSession",value:function(){return this._cleanup(),this.users=[],this._conversationsHash={},this._messagesHash={},this._queriesHash={},h(Object.getPrototypeOf(Client.prototype),"_resetSession",this).call(this)}},{key:"addUser",value:function(a){return this.users.push(a),a.setClient(this),this.trigger("users:change"),this}},{key:"findUser",value:function(a){for(var b=this.users.length,c=0;b>c;c++){var d=this.users[c];if(d.id===a)return d}}},{key:"__adjustUsers",value:function(a){return a?Array.isArray(a)?void 0:[a]:[]}},{key:"__updateUsers",value:function(a){var b=this;a.forEach(function(a){a instanceof User&&a.setClient(b)}),this.trigger("users:change")}},{key:"createConversation",value:function(a){var b=void 0;return b=Array.isArray(a)?{participants:a}:a,"distinct"in b||(b.distinct=!0),b.client=this,Conversation.create(b)}},{key:"getQuery",value:function(a){if("string"!=typeof a)throw new Error(LayerError.dictionary.idParamRequired);return this._queriesHash[a]?this._queriesHash[a]:void 0}},{key:"createQuery",value:function(a){var b=void 0;return"function"==typeof a.build?b=new Query(this,a):(a.client=this,b=new Query(a)),this._addQuery(b),b}},{key:"_addQuery",value:function(a){this._queriesHash[a.id]=a}},{key:"_removeQuery",value:function(a){var b=this;if(a){if(!this._inCleanup){var c=a.data.map(function(a){return b._getObject(a.id)}).filter(function(a){return a});this._checkCache(c)}this.off(null,null,a),delete this._queriesHash[a.id]}}},{key:"_checkCache",value:function(a){var b=this;a.forEach(function(a){b._isCachedObject(a)||(a instanceof l==!1&&(a=b._getObject(a.id)),a.destroy())})}},{key:"_isCachedObject",value:function(a){for(var b=Object.keys(this._queriesHash),c=0;c<b.length;c++){var d=this._queriesHash[b[c]];if(d._getItem(a.id))return!0}}},{key:"_connectionRestored",value:function(a){var b=this;a.reset&&(n.debug("Client Connection Restored; Resetting all Queries"),Object.keys(this._queriesHash).forEach(function(a){
var c=b._queriesHash[a];c&&c.reset()}))}},{key:"_removeObject",value:function(a){a&&a.destroy()}},{key:"createTypingListener",value:function(b){var c=a("./typing-indicators/typing-listener");return new c({clientId:this.appId,input:b})}},{key:"createTypingPublisher",value:function(){var b=a("./typing-indicators/typing-publisher");return new b({clientId:this.appId})}}],[{key:"getClient",value:function(a){return m.get(a)}},{key:"destroyAllClients",value:function(){m.getAll().forEach(function(a){return a.destroy()})}},{key:"registerPlugin",value:function(a,b){Client.plugins[a]=b}}]),Client}(i);Client.prototype._conversationsHash=null,Client.prototype._messagesHash=null,Client.prototype._tempConversationsHash=null,Client.prototype._tempMessagesHash=null,Client.prototype._queriesHash=null,Client.prototype.users=null,Client._ignoredEvents=["conversations:loaded","conversations:loaded-error"],Client._supportedEvents=["conversations:add","conversations:remove","conversations:sent","conversations:sent-error","conversations:change","messages:notify","messages:add","messages:remove","messages:sent","messages:sending","messages:sent-error","messages:change","messages:read","conversations:delete","messages:delete","users:change","typing-indicator-change"].concat(i._supportedEvents),Client.plugins={},l.initClass.apply(Client,[Client,"Client"]),b.exports=Client},{"./client-authenticator":5,"./client-registry":6,"./client-utils":7,"./conversation":11,"./layer-error":12,"./logger":14,"./message":16,"./query":19,"./root":20,"./typing-indicators/typing-indicator-listener":24,"./typing-indicators/typing-listener":26,"./typing-indicators/typing-publisher":27,"./user":28}],9:[function(a,b,c){"use strict";b.exports={SYNC_STATE:{NEW:"NEW",SAVING:"SAVING",SYNCING:"SYNCING",SYNCED:"SYNCED",LOADING:"LOADING"},RECIPIENT_STATE:{NONE:"NONE",SOME:"SOME",ALL:"ALL"},RECEIPT_STATE:{SENT:"sent",DELIVERED:"delivered",READ:"read",PENDING:"pending"},LOCALSTORAGE_KEYS:{SESSIONDATA:"layer-session-data-"},ACCEPT:"application/vnd.layer+json; version=1.0",LOG:{DEBUG:4,INFO:3,WARN:2,ERROR:1,NONE:0},DELETION_MODE:{ALL:1}}},{}],10:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./root"),i=a("./xhr"),Content=function(a){function Content(a){return d(this,Content),"string"==typeof a&&(a={id:a}),e(this,Object.getPrototypeOf(Content).call(this,a))}return f(Content,a),g(Content,[{key:"loadContent",value:function(a,b){i({url:this.downloadUrl,responseType:"arraybuffer"},function(c){if(c.success)if("undefined"!=typeof Blob){var d=new Blob([c.data],{type:a});b(null,d)}else b(null,c.data);else b(c.data,null)})}},{key:"refreshContent",value:function(a,b){var c=this;a.xhr({url:this.refreshUrl,method:"GET"},function(a){var d=a.data;c.expiration=new Date(d.expiration),c.downloadUrl=d.download_url,b&&b(c.downloadUrl)})}},{key:"isExpired",value:function(){var a=6e5;return this.expiration.getTime()-a<Date.now()}}],[{key:"_createFromServer",value:function(a){return new Content({id:a.id,downloadUrl:a.download_url,expiration:new Date(a.expiration),refreshUrl:a.refresh_url})}}]),Content}(h);Content.prototype.id="",Content.prototype.blob=null,Content.prototype.downloadUrl="",Content.prototype.refreshUrl="",Content.prototype.size=0,Content.prototype.expiration=null,h.initClass.apply(Content,[Content,"Content"]),b.exports=Content},{"./root":20,"./xhr":32}],11:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},j=a("./syncable"),Message=a("./message"),LayerError=a("./layer-error"),k=a("./client-utils"),l=a("./const"),m=a("./root"),LayerEvent=a("./layer-event"),n=a("./client-registry"),o=a("./logger"),Conversation=function(a){function Conversation(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];d(this,Conversation),a.participants||(a.participants=[]),a.metadata||(a.metadata={}),a.fromServer&&(a.id=a.fromServer.id),a.client&&(a.clientId=a.client.appId);var b=e(this,Object.getPrototypeOf(Conversation).call(this,a));b.isInitializing=!0;var c=b.getClient();return a&&a.fromServer?b._populateFromServer(a.fromServer):c&&-1===b.participants.indexOf(c.userId)&&b.participants.push(c.userId),b.localCreatedAt=new Date,c&&c._addConversation(b),b.isInitializing=!1,b}return f(Conversation,a),h(Conversation,[{key:"destroy",value:function(){this.lastMessage=null,this.clientId&&this.getClient()._removeConversation(this),i(Object.getPrototypeOf(Conversation.prototype),"destroy",this).call(this),this.participants=null,this.metadata=null}},{key:"getClient",value:function(){return n.get(this.clientId)}},{key:"send",value:function(a){var b=this,c=this.getClient();if(!c)throw new Error(LayerError.dictionary.clientMissing);if(this._sendDistinctEvent)return this._handleLocalDistinctConversation();if(a&&(a.position=this.lastMessage?this.lastMessage.position+1:0,this.lastMessage=a),this.syncState!==l.SYNC_STATE.NEW)return this;if(-1===this.participants.indexOf(c.userId)&&this.participants.push(c.userId),1===this.participants.length)throw new Error(LayerError.dictionary.moreParticipantsRequired);return this._setSyncing(),c.sendSocketRequest({method:"POST",body:function(){return{method:"Conversation.create",data:this._getPostData()}}.bind(this),sync:{depends:this.id,target:this.id}},function(a){return b._createResult(a)}),this}},{key:"_handleLocalDistinctConversation",value:function(){var a=this._sendDistinctEvent;return this._sendDistinctEvent=null,this._triggerAsync("conversations:sent",a),this}},{key:"_getPostData",value:function(){var a=k.isEmpty(this.metadata);return{participants:this.participants,distinct:this.distinct,metadata:a?null:this.metadata}}},{key:"_createResult",value:function(a){var b=a.success,c=a.data;this.isDestroyed||(b?this._createSuccess(c):"conflict"===c.id?(this._populateFromServer(c.data),this._triggerAsync("conversations:sent",{result:Conversation.FOUND_WITHOUT_REQUESTED_METADATA})):(this.trigger("conversations:sent-error",{error:c}),this.destroy()))}},{key:"_createSuccess",value:function(a){this._populateFromServer(a),this.distinct?this._triggerAsync("conversations:sent",{result:this.lastMessage?Conversation.FOUND:Conversation.CREATED}):this._triggerAsync("conversations:sent",{result:Conversation.CREATED})}},{key:"_populateFromServer",value:function(a){var b=this.getClient();this._disableEvents=this.syncState===l.SYNC_STATE.NEW,this._setSynced();var c=this.id;this.id=a.id,c!==this.id&&(this._tempId=c,b._updateConversationId(this,c),this._triggerAsync("conversations:change",{oldValue:c,newValue:this.id,property:"id"})),this.url=a.url,this.participants=a.participants,this.distinct=a.distinct,this.createdAt=new Date(a.created_at),this.metadata=a.metadata,this.unreadCount=a.unread_message_count,this.isCurrentParticipant=-1!==this.participants.indexOf(b.userId),b._addConversation(this),a.last_message?this.lastMessage=Message._createFromServer(a.last_message,this).message:this.lastMessage=null,this._disableEvents=!1}},{key:"addParticipants",value:function(a){var b=this,c=a.filter(function(a){return-1===b.participants.indexOf(a)});return this._patchParticipants({add:c,remove:[]}),this}},{key:"removeParticipants",value:function(a){var b=this,c=this.participants.concat([]).sort(),d=a.filter(function(a){return-1!==b.participants.indexOf(a)}).sort();if(JSON.stringify(c)===JSON.stringify(d))throw new Error(LayerError.dictionary.moreParticipantsRequired);return this._patchParticipants({add:[],remove:d}),this}},{key:"replaceParticipants",value:function(a){if(!a||!a.length)throw new Error(LayerError.dictionary.moreParticipantsRequired);var b=this._getParticipantChange(a,this.participants);return this._patchParticipants(b),this}},{key:"_patchParticipants",value:function(a){var b=this;this._applyParticipantChange(a),this.isCurrentParticipant=-1!==this.participants.indexOf(this.getClient().userId);var c=[];a.remove.forEach(function(a){c.push({operation:"remove",property:"participants",value:a})}),a.add.forEach(function(a){c.push({operation:"add",property:"participants",value:a})}),this._xhr({url:"",method:"PATCH",data:JSON.stringify(c),headers:{"content-type":"application/vnd.layer-patch+json"}},function(a){a.success||b._load()})}},{key:"_applyParticipantChange",value:function(a){var b=[].concat(this.participants);a.add.forEach(function(a){-1===b.indexOf(a)&&b.push(a)}),a.remove.forEach(function(a){var c=b.indexOf(a);-1!==c&&b.splice(c,1)}),this.participants=b}},{key:"delete",value:function(a){var b=this.id,c="true";if(a===!0&&(o.warn("Calling Message.delete without a mode is deprecated"),a=l.DELETION_MODE.ALL),!a||a!==l.DELETION_MODE.ALL)throw new Error(LayerError.dictionary.deletionModeUnsupported);var d=this.getClient();this._xhr({method:"DELETE",url:"?destroy="+c},function(a){a.success||Conversation.load(b,d)}),this._deleted(),this.destroy()}},{key:"_deleted",value:function(){this.trigger("conversations:delete")}},{key:"createMessage",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b="string"==typeof a?{parts:[{body:a,mimeType:"text/plain"}]}:a;return b.clientId=this.clientId,b.conversationId=this.id,new Message(b)}},{key:"_handlePatchEvent",value:function(a,b,c){this._inLayerParser=!1;try{var d=this._disableEvents;this._disableEvents=!1,0===c[0].indexOf("metadata")?this.__updateMetadata(a,b,c):"participants"===c[0]&&this.__updateParticipants(a,b),this._disableEvents=d}catch(a){}this._inLayerParser=!0}},{key:"_getParticipantChange",value:function(a,b){var c={};return c.add=a.filter(function(a){return-1===b.indexOf(a)}),c.remove=b.filter(function(b){return-1===a.indexOf(b)}),c}},{key:"setMetadataProperties",value:function(a){var b=this,c=[];return Object.keys(a).forEach(function(b){var d=b;b&&("metadata"!==b&&0!==b.indexOf("metadata.")&&(d="metadata."+b),c.push({operation:"set",property:d,value:a[b]}))}),this._inLayerParser=!0,k.layerParse({object:this,type:"Conversation",operations:c,client:this.getClient()}),this._inLayerParser=!1,this._xhr({url:"",method:"PATCH",data:JSON.stringify(c),headers:{"content-type":"application/vnd.layer-patch+json"}},function(a){a.success||b._load()}),this}},{key:"deleteMetadataProperties",value:function(a){var b=this,c=[];return a.forEach(function(a){"metadata"!==a&&0!==a.indexOf("metadata.")&&(a="metadata."+a),c.push({operation:"delete",property:a})},this),this._inLayerParser=!0,k.layerParse({object:this,type:"Conversation",operations:c,client:this.getClient()}),this._inLayerParser=!1,this._xhr({url:"",method:"PATCH",data:JSON.stringify(c),headers:{"content-type":"application/vnd.layer-patch+json"}},function(a){a.success||b._load()}),this}},{key:"_xhr",value:function(a,b){var c=this,d=a.url,e=this.getClient();if(this.isDestroyed)throw new Error(LayerError.dictionary.isDestroyed);if(!e)throw new Error(LayerError.dictionary.clientMissing);if(!("url"in a))throw new Error(LayerError.dictionary.urlRequired);if("POST"!==a.method&&this.syncState===l.SYNC_STATE.NEW)return this;a.url&&!a.url.match(/^(\/|\?)/)&&(a.url="/"+a.url),a.sync!==!1&&(a.sync||(a.sync={}),a.sync.target||(a.sync.target=this.id)),d=a.url;var f=function(){return c.url+(d||"")};return this.url?a.url=f():a.url=f,a.method&&"GET"!==a.method&&this._setSyncing(),e.xhr(a,function(d){a.method&&"GET"!==a.method&&!c.isDestroyed&&c._setSynced(),b&&b(d)}),this}},{key:"_load",value:function(){var a=this;this.syncState=l.SYNC_STATE.LOADING,this._xhr({url:"",method:"GET",sync:!1},function(b){return a._loadResult(b)})}},{key:"_loadResult",value:function(a){a.success?(this._populateFromServer(a.data),this.getClient()._addConversation(this),this.trigger("conversations:loaded")):(this.syncState=l.SYNC_STATE.NEW,this.trigger("conversations:loaded-error",{error:a.data}),this.destroy())}},{key:"on",value:function(a,b,c){var d="conversations:loaded"===a||a&&"object"===("undefined"==typeof a?"undefined":g(a))&&a["conversations:loaded"];return d&&!this.isLoading&&!function(){var d="conversations:loaded"===a?b:a["conversations:loaded"];k.defer(function(){return d.apply(c)})}(),i(Object.getPrototypeOf(Conversation.prototype),"on",this).call(this,a,b,c),this}},{key:"__adjustUnreadCount",value:function(a){return 0>a?0:void 0}},{key:"__updateUnreadCount",value:function(a,b){var c=this;this._inLayerParser?(void 0===this._oldUnreadCount&&(this._oldUnreadCount=b),this._updateUnreadCountTimeout&&clearTimeout(this._updateUnreadCountTimeout),this._updateUnreadCountTimeout=setTimeout(function(){return c._updateUnreadCountEvent()},1e3)):this._updateUnreadCountEvent()}},{key:"_updateUnreadCountEvent",value:function(){if(!this.isDestroyed){var a=this._oldUnreadCount,b=this.__unreadCount;this._oldUnreadCount=void 0,b!==a&&this._triggerAsync("conversations:change",{newValue:b,oldValue:a,property:"unreadCount"})}}},{key:"__updateLastMessage",value:function(a,b){a&&b&&a.id===b.id||this._triggerAsync("conversations:change",{property:"lastMessage",newValue:a,oldValue:b})}},{key:"__updateParticipants",value:function(a,b){if(!this._inLayerParser){var c=this._getParticipantChange(a,b);(c.add.length||c.remove.length)&&(c.property="participants",c.oldValue=b,c.newValue=a,this._triggerAsync("conversations:change",c))}}},{key:"__updateMetadata",value:function(a,b,c){this._inLayerParser||JSON.stringify(a)!==JSON.stringify(b)&&this._triggerAsync("conversations:change",{property:"metadata",newValue:a,oldValue:b,paths:c})}},{key:"toObject",value:function(){return this._toObject||(this._toObject=i(Object.getPrototypeOf(Conversation.prototype),"toObject",this).call(this),this._toObject.metadata=k.clone(this.metadata),this._toObject.isNew=this.isNew(),this._toObject.isSaving=this.isSaving(),this._toObject.isSaved=this.isSaved(),this._toObject.isSynced=this.isSynced()),this._toObject}},{key:"_triggerAsync",value:function(a,b){this._clearObject(),i(Object.getPrototypeOf(Conversation.prototype),"_triggerAsync",this).call(this,a,b)}},{key:"trigger",value:function(a,b){this._clearObject(),i(Object.getPrototypeOf(Conversation.prototype),"trigger",this).call(this,a,b)}}],[{key:"_createFromServer",value:function(a,b){var c=void 0;if(!(b instanceof m))throw new Error(LayerError.dictionary.clientMissing);var d=b.getConversation(a.id);return d?(c=d,c._populateFromServer(a)):c=new Conversation({client:b,fromServer:a}),{conversation:c,new:!d}}},{key:"load",value:function(a,b){if(!b)throw new Error(LayerError.dictionary.clientMissing);var c=new Conversation({url:b.url+a.substring(8),id:a,client:b});return c._load(),c}},{key:"create",value:function(a){if(!a.client)throw new Error(LayerError.dictionary.clientMissing);if(a.distinct){var b=this._createDistinct(a);if(b)return b}return new Conversation(a)}},{key:"_createDistinct",value:function(a){-1===a.participants.indexOf(a.client.userId)&&a.participants.push(a.client.userId);var b=a.participants.sort(),c=b.join(","),d=a.client.findCachedConversation(function(a){if(a.distinct&&a.participants.length===b.length){var d=a.participants.sort();return d.join(",")===c}});return d?(d._sendDistinctEvent=new LayerEvent({target:d,result:!a.metadata||k.doesObjectMatch(a.metadata,d.metadata)?Conversation.FOUND:Conversation.FOUND_WITHOUT_REQUESTED_METADATA},"conversations:sent"),d):void 0}},{key:"_loadResourceForPatch",value:function(a){return!0}}]),Conversation}(j);Conversation.prototype.participants=null,Conversation.prototype.clientId="",Conversation.prototype.createdAt=null,Conversation.prototype.id="",Conversation.prototype.url="",Conversation.prototype.unreadCount=0,Conversation.prototype.distinct=!0,Conversation.prototype.metadata=null,Conversation.prototype.localCreatedAt=null,Conversation.prototype.isCurrentParticipant=!0,Conversation.prototype.lastMessage=null,Conversation.prototype._toObject=null,Conversation.prototype._sendDistinctEvent=null,Conversation.prototype._tempId="",Conversation.prefixUUID="layer:///conversations/",Conversation.bubbleEventParent="getClient",Conversation.CREATED="Created",Conversation.FOUND="Found",Conversation.FOUND_WITHOUT_REQUESTED_METADATA="FoundMismatch",Conversation._supportedEvents=["conversations:sent","conversations:sent-error","conversations:loaded","conversations:loaded-error","conversations:delete","conversations:change"].concat(j._supportedEvents),m.initClass.apply(Conversation,[Conversation,"Conversation"]),b.exports=Conversation},{"./client-registry":6,"./client-utils":7,"./const":9,"./layer-error":12,"./layer-event":13,"./logger":14,"./message":16,"./root":20,"./syncable":23}],12:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},f=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),g=a("./logger"),LayerError=function(){function LayerError(a){var b=this;d(this,LayerError),a instanceof LayerError?a={errType:a.errType,httpStatus:a.httpStatus,message:a.message,code:a.code,url:a.url,data:a.data}:a&&"object"===("undefined"==typeof a?"undefined":e(a))?a.errType=a.id:a={message:a},Object.keys(a).forEach(function(c){return b[c]=a[c]}),this.data||(this.data={})}return f(LayerError,[{key:"getNonce",value:function(){return this.data&&this.data.nonce?this.data.nonce:""}},{key:"toString",value:function(){return this.code+" ("+this.id+"): "+this.message+"; (see "+this.url+")"}},{key:"log",value:function(){g.error("Layer-Error: "+this.toString())}}]),LayerError}();LayerError.prototype.errType="",LayerError.prototype.code=0,LayerError.prototype.url="",LayerError.prototype.message="",LayerError.prototype.httpStatus=0,LayerError.prototype.request=null,LayerError.prototype.data=null,LayerError.prototype.xhr=null,LayerError.dictionary={appIdMissing:"Property missing: appId is required",identityTokenMissing:"Identity Token missing: answerAuthenticationChallenge requires an identity token",sessionTokenMissing:"Session Token missing: _authComplete requires a {session_token: value} input",clientMissing:"Property missing: client is required",conversationMissing:"Property missing: conversation is required",partsMissing:"Property missing: parts is required",moreParticipantsRequired:"Conversation needs participants other than the current user",isDestroyed:"Object is destroyed",urlRequired:"Object needs a url property",invalidUrl:"URL is invalid",invalidId:"Identifier is invalid",idParamRequired:"The ID Parameter is required",wrongClass:"Parameter class error; should be: ",inProgress:"Operation already in progress",cantChangeIfConnected:"You can not change value after connecting",alreadySent:"Already sent or sending",contentRequired:"MessagePart requires rich content for this call",alreadyDestroyed:"This object has already been destroyed",deletionModeUnsupported:"Call to deletion was made with an unsupported deletion mode"},b.exports=LayerError},{"./logger":14}],13:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),LayerEvent=function(){function LayerEvent(a,b){var c=this;d(this,LayerEvent);var e=this;b.match(/:change$/)?(this.changes=[{}],e=this.changes[0],this.isChange=!0):this.isChange=!1,Object.keys(a).forEach(function(b){e!==c&&"target"===b?c.target=a.target:e[b]=a[b]}),this.eventName=b}return e(LayerEvent,[{key:"hasProperty",value:function(a){return this.isChange?Boolean(this.changes.filter(function(b){return b.property===a}).length):!1}},{key:"getChangesFor",value:function(a){return this.isChange?this.changes.filter(function(b){return b.property===a}):[]}},{key:"_mergeChanges",value:function(a){this.changes=this.changes.concat(a.changes)}}]),LayerEvent}();LayerEvent.prototype.isChange=!1,LayerEvent.prototype.changes=null,LayerEvent.prototype.target=null,LayerEvent.prototype.eventName="",b.exports=LayerEvent},{}],14:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("./const").LOG,g=f.DEBUG,h=f.INFO,i=f.WARN,j=f.ERROR,k=f.NONE,l=a("./client-utils"),m=l.isEmpty,n=Boolean(console.assert&&console.assert.toString().match(/assert/)),o="color: #888; font-weight: bold;",p="color: black",q=function(){function a(){d(this,a)}return e(a,[{key:"log",value:function(a,b,c,d){if("string"==typeof a){var e=(new Date).toLocaleTimeString();n?console.log("%cLayer%c "+c+"%c ["+e+"]: "+a,o,"color: "+d,p):console.log("Layer "+c+" ["+e+"]: "+a)}else this._logObj(a,c,d);b&&this._logObj(b,c,d)}},{key:"_logObj",value:function(a,b,c){a&&!m(a)&&("Object"===a.constructor.name?n?console.log("%cLayer%c "+b+"%c: "+JSON.stringify(a,null,4),o,"color: "+c,p):console.log("Layer "+b+": "+JSON.stringify(a,null,4)):n?console.log("%cLayer%c "+b+"%c: %O",o,"color: "+c,p,a):console.log("Layer "+b+":",a))}},{key:"debug",value:function(a,b){this.level>=g&&this.log(a,b,"DEBUG","#888")}},{key:"info",value:function(a,b){this.level>=h&&this.log(a,b,"INFO","black")}},{key:"warn",value:function(a,b){this.level>=i&&this.log(a,b,"WARN","orange")}},{key:"error",value:function(a,b){this.level>=j&&this.log(a,b,"ERROR","red")}}]),a}();q.prototype.level="undefined"==typeof jasmine?j:k;var r=new q;b.exports=r},{"./client-utils":7,"./const":9}],15:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./root"),Content=a("./content"),j=a("./xhr"),k=a("./client-registry"),LayerError=a("./layer-error"),l="undefined"!=typeof Blob,m="undefined"==typeof window?a("filereader"):FileReader,MessagePart=function(a){function MessagePart(a){d(this,MessagePart);var b=a;if("string"==typeof a)b={body:a},arguments.length-1>0?b.mimeType=arguments.length<=1?void 0:arguments[1]:b.mimeType="text/plain";else if(l&&(a instanceof Blob||a.body instanceof Blob)){var c=a instanceof Blob?a:a.body;b={mimeType:c.type,body:c,size:c.size,hasContent:!0}}var f=e(this,Object.getPrototypeOf(MessagePart).call(this,b));return!f.size&&f.body&&(f.size=f.body.length),l&&f.body instanceof Blob&&(f.url=URL.createObjectURL(f.body)),f}return f(MessagePart,a),g(MessagePart,[{key:"destroy",value:function(){this.__url&&(URL.revokeObjectURL(this.__url),this.__url=null),this.body=null,h(Object.getPrototypeOf(MessagePart.prototype),"destroy",this).call(this)}},{key:"_getClient",value:function(){return k.get(this.clientId)}},{key:"_getMessage",value:function(){return this._getClient().getMessage(this.id.replace(/\/parts.*$/,""))}},{key:"fetchContent",value:function(a){var b=this;if(this._content&&!this.isFiring){this.isFiring=!0;var c="image/jpeg+preview"===this.mimeType?"image/jpeg":this.mimeType;this._content.loadContent(c,function(c,d){return b._fetchContentCallback(c,d,a)})}return this}},{key:"_fetchContentCallback",value:function(a,b,c){var d=this;a?this.trigger("content-loaded-error",a):(this.url=URL.createObjectURL(b),this.isFiring=!1,"text/plain"===this.mimeType?!function(){var a=new m;a.addEventListener("loadend",function(){d._fetchContentComplete(a.result,c)}),a.readAsText(b)}():this._fetchContentComplete(b,c))}},{key:"_fetchContentComplete",value:function(a,b){var c=this._getMessage();this.body=a,this.trigger("content-loaded"),c._triggerAsync("messages:change",{oldValue:c.parts,newValue:c.parts,property:"parts"}),b&&b(this.body)}},{key:"fetchStream",value:function(a){var b=this;if(!this._content)throw new Error(LayerError.dictionary.contentRequired);this._content.isExpired()?this._content.refreshContent(this._getClient(),function(c){return b._fetchStreamComplete(c,a)}):this._fetchStreamComplete(this._content.downloadUrl,a)}},{key:"_fetchStreamComplete",value:function(a,b){var c=this._getMessage();this.trigger("url-loaded"),c._triggerAsync("messages:change",{oldValue:c.parts,newValue:c.parts,property:"parts"}),b&&b(a)}},{key:"_send",value:function(a){this._content&&this._sendWithContent(),this.size>2048?this._generateContentAndSend(a):"undefined"!=typeof Blob&&this.body instanceof Blob?this._sendBlob(a):this._sendBody()}},{key:"_sendBody",value:function(){var a={mime_type:this.mimeType,body:this.body};this.encoding&&(a.encoding=this.encoding),this.trigger("parts:send",a)}},{key:"_sendWithContent",value:function(){this.trigger("parts:send",{mime_type:this.mimeType,content:{size:this.size,id:this._content.id}})}},{key:"_sendBlob",value:function(a){var b=this,c=new m;c.onloadend=function(){var d=c.result;d.length<2048?(b.body=d,b.body=b.body.substring(b.body.indexOf(",")+1),b.encoding="base64",b._sendBody(a)):b._generateContentAndSend(a)},c.readAsDataURL(this.body)}},{key:"_generateContentAndSend",value:function(a){var b=this;this.hasContent=!0,a.xhr({url:"/content",method:"POST",headers:{"Upload-Content-Type":this.mimeType,"Upload-Content-Length":this.size,"Upload-Origin":"undefined"!=typeof location?location.origin:""},sync:{}},function(c){b._processContentResponse(c.data,a)})}},{key:"_processContentResponse",value:function(a,b){var c=this;this._content=new Content(a.id),this.hasContent=!0,j({url:a.upload_url,method:"PUT",data:this.body,headers:{"Upload-Content-Length":this.size,"Upload-Content-Type":this.mimeType}},function(d){return c._processContentUploadResponse(d,a,b)})}},{key:"_processContentUploadResponse",value:function(a,b,c){a.success?this.trigger("parts:send",{mime_type:this.mimeType,content:{size:this.size,id:this._content.id}}):c.onlineManager.isOnline?console.error("We don't yet handle this!"):c.onlineManager.once("connected",this._processContentResponse.bind(this,b,c),this)}},{key:"getText",value:function(){return"text/plain"===this.mimeType?this.body:""}},{key:"_populateFromServer",value:function(a){a.content&&this._content&&(this._content.downloadUrl=a.content.download_url,this._content.expiration=new Date(a.content.expiration))}}],[{key:"_createFromServer",value:function(a){var b=a.content?Content._createFromServer(a.content):null;return new MessagePart({id:a.id,mimeType:a.mime_type,body:a.body||"",_content:b,hasContent:Boolean(b),size:a.size||0,encoding:a.encoding||""})}}]),MessagePart}(i);MessagePart.prototype.clientId="",MessagePart.prototype.id="",MessagePart.prototype.body=null,MessagePart.prototype._content=null,MessagePart.prototype.hasContent=!1,Object.defineProperty(MessagePart.prototype,"url",{enumerable:!0,get:function(){return this.__url?this.__url:this._content?this._content.isExpired()?"":this._content.downloadUrl:""},set:function(a){this.__url=a}}),MessagePart.prototype.mimeType="text/plain",MessagePart.prototype.encoding="",MessagePart.prototype.size=0,MessagePart._supportedEvents=["parts:send","content-loaded","url-loaded","content-loaded-error"].concat(i._supportedEvents),i.initClass.apply(MessagePart,[MessagePart,"MessagePart"]),b.exports=MessagePart},{"./client-registry":6,"./content":10,"./layer-error":12,"./root":20,"./xhr":32,filereader:3}],16:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},j=a("./root"),k=a("./syncable"),MessagePart=a("./message-part"),LayerError=a("./layer-error"),l=a("./const"),m=a("./client-utils"),n=a("./client-registry"),o=a("./logger"),Message=function(a){function Message(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(d(this,Message),a.fromServer?a.id=a.fromServer.id:"isUnread"in a?a.isRead=!a.isUnread&&!a.is_unread:a.isRead=!0,
a.client&&(a.clientId=a.client.appId),!a.clientId)throw new Error("clientId property required to create a Message");a.conversation&&(a.conversationId=a.conversation.id);var b=a.parts;a.parts=null;var c=e(this,Object.getPrototypeOf(Message).call(this,a));c.parts=b;var f=c.getClient();return c.isInitializing=!0,a&&a.fromServer?c._populateFromServer(a.fromServer):(c.sender={userId:"",name:""},c.sentAt=new Date),c.parts||(c.parts=[]),c.localCreatedAt=new Date,c._disableEvents=!0,a.fromServer?c.__updateRecipientStatus(c.recipientStatus):c.recipientStatus={},c._disableEvents=!1,c.isInitializing=!1,a&&a.fromServer&&f._addMessage(c),c}return f(Message,a),h(Message,[{key:"getClient",value:function(){return n.get(this.clientId)}},{key:"getConversation",value:function(){return this.conversationId?n.get(this.clientId).getConversation(this.conversationId):void 0}},{key:"__adjustParts",value:function(a){var b=this;return"string"==typeof a?[new MessagePart({body:a,mimeType:"text/plain",clientId:this.clientId})]:Array.isArray(a)?a.map(function(a){var c=void 0;return c=a instanceof MessagePart?a:new MessagePart(a),c.clientId=b.clientId,c}):a&&"object"===("undefined"==typeof a?"undefined":g(a))?(a.clientId=this.clientId,[new MessagePart(a)]):void 0}},{key:"addPart",value:function(a){return a&&(a.clientId=this.clientId,"object"===("undefined"==typeof a?"undefined":g(a))?this.parts.push(new MessagePart(a)):a instanceof MessagePart&&this.parts.push(a)),this}},{key:"__getRecipientStatus",value:function(a){var b=this,c=this[a]||{},d=this.getClient();return d&&!function(){var a=d.userId,e=b.getConversation();e&&e.participants.forEach(function(b){c[b]||(c[b]=b===a?l.RECEIPT_STATE.READ:l.RECEIPT_STATE.PENDING)})}(),c}},{key:"__updateRecipientStatus",value:function(a,b){var c=this.getConversation(),d=this.getClient();if(c&&!m.doesObjectMatch(a,b)){var e=d.userId,f=this.sender.userId===e,g=a[e]===l.RECEIPT_STATE.READ;try{var h=c.participants.length-1;this.__isRead||!f&&!g||(this.__isRead=!0);var i=this._getReceiptStatus(a,e),j=i.readCount,k=i.deliveredCount;this._setReceiptStatus(j,k,h)}catch(a){}if(!this.isInitializing&&b){var n=g&&b[e]!==l.RECEIPT_STATE.READ;(n||f)&&this._triggerAsync("messages:change",{oldValue:b,newValue:a,property:"recipientStatus"})}}}},{key:"_getReceiptStatus",value:function(a,b){var c=0,d=0;return Object.keys(a).filter(function(a){return a!==b}).forEach(function(b){a[b]===l.RECEIPT_STATE.READ?(c++,d++):a[b]===l.RECEIPT_STATE.DELIVERED&&d++}),{readCount:c,deliveredCount:d}}},{key:"_setReceiptStatus",value:function(a,b,c){a===c?this.readStatus=l.RECIPIENT_STATE.ALL:a>0?this.readStatus=l.RECIPIENT_STATE.SOME:this.readStatus=l.RECIPIENT_STATE.NONE,b===c?this.deliveryStatus=l.RECIPIENT_STATE.ALL:b>0?this.deliveryStatus=l.RECIPIENT_STATE.SOME:this.deliveryStatus=l.RECIPIENT_STATE.NONE}},{key:"__updateIsRead",value:function(a){if(a){this._sendReceipt(l.RECEIPT_STATE.READ),this._triggerAsync("messages:read");var b=this.getConversation();b&&b.unreadCount--}}},{key:"sendReceipt",value:function(){var a=arguments.length<=0||void 0===arguments[0]?l.RECEIPT_STATE.READ:arguments[0];if(a===l.RECEIPT_STATE.READ){if(this.isRead)return this;this.__isRead=!0,this._triggerAsync("messages:read");var b=this.getConversation();b&&b.unreadCount--}return this._sendReceipt(a),this}},{key:"_sendReceipt",value:function(a){var b=this;0!==this.getConversation().participants.length&&(this._setSyncing(),this._xhr({url:"/receipts",method:"POST",data:{type:a},sync:{operation:"RECEIPT"}},function(){return b._setSynced()}))}},{key:"send",value:function(a){var b=this.getClient(),c=this.getConversation();if(this.syncState!==l.SYNC_STATE.NEW)throw new Error(LayerError.dictionary.alreadySent);if(!c)throw new Error(LayerError.dictionary.conversationMissing);if(!this.parts||!this.parts.length)throw new Error(LayerError.dictionary.partsMissing);this.sender.userId=b.userId,this._setSyncing(),b._addMessage(this),c.send(this),this.trigger("messages:sending");var d={parts:new Array(this.parts.length)};return a&&(d.notification=a),this._preparePartsForSending(d),this}},{key:"_preparePartsForSending",value:function(a){var b=this,c=this.getClient(),d=0;this.parts.forEach(function(e,f){e.once("parts:send",function(c){a.parts[f]={mime_type:c.mime_type},c.content&&(a.parts[f].content=c.content),c.body&&(a.parts[f].body=c.body),c.encoding&&(a.parts[f].encoding=c.encoding),d++,d===b.parts.length&&b._send(a)},b),e._send(c)})}},{key:"_send",value:function(a){var b=this,c=this.getClient(),d=this.getConversation();this.sentAt=new Date,c.sendSocketRequest({method:"POST",body:function(){return{method:"Message.create",object_id:d.id,data:a}},sync:{depends:[this.conversationId,this.id],target:this.id}},function(a,c){return b._sendResult(a,c)})}},{key:"_sendResult",value:function(a){var b=a.success,c=a.data;this.isDestroyed||(b?(this._populateFromServer(c),this._triggerAsync("messages:sent")):(this.trigger("messages:sent-error",{error:c}),this.destroy()),this._setSynced())}},{key:"on",value:function(a,b,c){var d="messages:loaded"===a||a&&"object"===("undefined"==typeof a?"undefined":g(a))&&a["messages:loaded"];return d&&!this.isLoading&&!function(){var d="messages:loaded"===a?b:a["messages:loaded"];m.defer(function(){return d.apply(c)})}(),i(Object.getPrototypeOf(Message.prototype),"on",this).call(this,a,b,c),this}},{key:"delete",value:function(a){var b=this;if(this.isDestroyed)throw new Error(LayerError.dictionary.isDestroyed);var c="true";if(a===!0&&(o.warn("Calling Message.delete without a mode is deprecated"),a=l.DELETION_MODE.ALL),!a||a!==l.DELETION_MODE.ALL)throw new Error(LayerError.dictionary.deletionModeUnsupported);return this.syncState!==l.SYNC_STATE.NEW&&!function(){var a=b.id,d=b.getClient();b._xhr({url:"?destroy="+c,method:"DELETE"},function(b){b.success||Message.load(a,d)})}(),this._deleted(),this.destroy(),this}},{key:"_deleted",value:function(){this.trigger("messages:delete")}},{key:"destroy",value:function(){this.getClient()._removeMessage(this),this.parts.forEach(function(a){return a.destroy()}),this.__parts=null,i(Object.getPrototypeOf(Message.prototype),"destroy",this).call(this)}},{key:"_populateFromServer",value:function(a){var b=this,c=this.id;this.id=a.id,this.url=a.url,this.position=a.position,this.parts&&this.parts.forEach(function(a,c){a.id||(a.id=b.id+"/parts/"+c)}),this.parts=a.parts.map(function(a){var c=b.getPartById(a.id);return c?(c._populateFromServer(a),c):MessagePart._createFromServer(a)}),this.recipientStatus=a.recipient_status||{},this.isRead=!a.is_unread,this.sentAt=new Date(a.sent_at),this.receivedAt=a.received_at?new Date(a.received_at):void 0,this.sender={userId:a.sender.user_id||"",name:a.sender.name||""},this._setSynced(),c&&c!==this.id&&(this._tempId=c,this.getClient()._updateMessageId(this,c),this._triggerAsync("messages:change",{oldValue:c,newValue:this.id,property:"id"}))}},{key:"getPartById",value:function(a){return this.parts?this.parts.filter(function(b){return b.id===a})[0]:null}},{key:"_handlePatchEvent",value:function(a,b,c){this._inLayerParser=!1,0===c[0].indexOf("recipient_status")&&this.__updateRecipientStatus(this.recipientStatus,b),this._inLayerParser=!0}},{key:"_xhr",value:function(a,b){var c=a.url,d=this.getClient(),e=this.getConversation();if(this.isDestroyed)throw new Error(LayerError.dictionary.isDestroyed);if(!("url"in a))throw new Error(LayerError.dictionary.urlRequired);if(!e)throw new Error(LayerError.dictionary.conversationMissing);c&&!c.match(/^(\/|\?)/)&&(a.url=c="/"+a.url),a.sync=this._setupSyncObject(a.sync);var f=function(){return this.url+(c||"")}.bind(this);return this.url?a.url=f():a.url=f,d.xhr(a,b),this}},{key:"_setupSyncObject",value:function(a){return a!==!1&&(a||(a={}),a.target||(a.target=this.id),a.depends?-1===a.depends.indexOf(this.id)&&a.depends.push(this.conversationId):a.depends=[this.conversationId]),a}},{key:"getText",value:function(){var a=arguments.length<=0||void 0===arguments[0]?". ":arguments[0],b=this.parts.filter(function(a){return"text/plain"===a.mimeType}).map(function(a){return a.body});return b=b.filter(function(a){return a}),b.join(a)}},{key:"toObject",value:function(){return this._toObject||(this._toObject=i(Object.getPrototypeOf(Message.prototype),"toObject",this).call(this),this._toObject.recipientStatus=m.clone(this.recipientStatus),this._toObject.isNew=this.isNew(),this._toObject.isSaving=this.isSaving(),this._toObject.isSaved=this.isSaved(),this._toObject.isSynced=this.isSynced()),this._toObject}},{key:"_triggerAsync",value:function(a,b){this._clearObject(),i(Object.getPrototypeOf(Message.prototype),"_triggerAsync",this).call(this,a,b)}},{key:"trigger",value:function(a,b){this._clearObject(),i(Object.getPrototypeOf(Message.prototype),"trigger",this).call(this,a,b)}}],[{key:"_createFromServer",value:function(a,b){if(!(b instanceof j))throw new Error(LayerError.dictionary.conversationMissing);var c=b.getClient(),d=c.getMessage(a.id),e=void 0;if(d)e=d,e._populateFromServer(a);else{var f=a.fromWebsocket;e=new Message({fromServer:a,conversationId:b.id,clientId:c.appId,_notify:f&&a.is_unread&&a.sender.user_id!==c.userId})}var g=e.recipientStatus[c.userId];return g!==l.RECEIPT_STATE.READ&&g!==l.RECEIPT_STATE.DELIVERED&&e._sendReceipt("delivery"),{message:e,new:!d}}},{key:"load",value:function(a,b){var c=this;if(!(b&&b instanceof j))throw new Error(LayerError.dictionary.clientMissing);if(0!==a.indexOf("layer:///messages/"))throw new Error(LayerError.dictionary.invalidId);var d=new Message({id:a,url:b.url+a.substring(8),clientId:b.appId});return d.syncState=l.SYNC_STATE.LOADING,b.xhr({url:d.url,method:"GET",sync:!1},function(a){return c._loadResult(d,b,a)}),d}},{key:"_loadResult",value:function(a,b,c){c.success?this._loadSuccess(a,b,c.data):(a.syncState=l.SYNC_STATE.NEW,a._triggerAsync("messages:loaded-error",{error:c.data}),setTimeout(function(){return a.destroy()},100))}},{key:"_loadSuccess",value:function(a,b,c){a._populateFromServer(c),a.conversationId=c.conversation.id,a._triggerAsync("messages:loaded")}},{key:"_loadResourceForPatch",value:function(a){return!1}}]),Message}(k);Message.prototype.clientId="",Message.prototype.conversationId="",Message.prototype.parts=null,Message.prototype.id="",Message.prototype.url="",Message.prototype.sentAt=null,Message.prototype.receivedAt=null,Message.prototype.sender=null,Message.prototype.position=0,Message.prototype._notify=!1,Message.prototype.recipientStatus=null,Message.prototype.isRead=!1,Object.defineProperty(Message.prototype,"isUnread",{enumerable:!0,get:function(){return!this.isRead}}),Message.prototype.readStatus=l.RECIPIENT_STATE.NONE,Message.prototype.deliveryStatus=l.RECIPIENT_STATE.NONE,Message.prototype._tempId="",Message.prototype.localCreatedAt=null,Message.prototype._toObject=null,Message.prefixUUID="layer:///messages/",Message.inObjectIgnore=k.inObjectIgnore,Message.bubbleEventParent="getClient",Message.imageTypes=["image/gif","image/png","image/jpeg","image/jpg"],Message._supportedEvents=["messages:loaded","messages:loaded-error","messages:delete","messages:sending","messages:sent","messages:sent-error","messages:read","messages:change"].concat(k._supportedEvents),j.initClass.apply(Message,[Message,"Message"]),b.exports=Message},{"./client-registry":6,"./client-utils":7,"./const":9,"./layer-error":12,"./logger":14,"./message-part":15,"./root":20,"./syncable":23}],17:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./root"),j=a("./xhr"),k=a("./logger"),l=a("./client-utils"),OnlineStateManager=function(a){function OnlineStateManager(a){d(this,OnlineStateManager);var b=e(this,Object.getPrototypeOf(OnlineStateManager).call(this,a));return j.addConnectionListener(function(a){return b._connectionListener(a)}),b.socketManager.on("message",function(){return b._connectionListener({status:"connection:success"})},b),"undefined"!=typeof window&&(window.addEventListener("online",b._handleOnlineEvent.bind(b)),window.addEventListener("offline",b._handleOnlineEvent.bind(b))),b}return f(OnlineStateManager,a),g(OnlineStateManager,[{key:"start",value:function(){k.info("OnlineStateManager: start"),this.isClientReady=!0,this.isOnline=!0,this._firstStart||this.trigger("connected",{offlineDuration:0}),this._firstStart=!1,this._scheduleNextOnlineCheck()}},{key:"stop",value:function(){k.info("OnlineStateManager: stop"),this.isClientReady=!1,this._clearCheck(),this._changeToOffline()}},{key:"_scheduleNextOnlineCheck",value:function(){if(k.debug("OnlineStateManager: skip schedule"),!this.isDestroyed&&this.isClientReady)if(this._clearCheck(),this.isOnline)k.debug("OnlineStateManager: Scheduled onlineExpired"),this.onlineCheckId=setTimeout(this._onlineExpired.bind(this),this.pingFrequency);else{k.info("OnlineStateManager: Scheduled checkOnlineStatus");var a=l.getExponentialBackoffSeconds(this.maxOfflineWait,Math.min(10,this.offlineCounter++));this.onlineCheckId=setTimeout(this.checkOnlineStatus.bind(this),Math.floor(1e3*a))}}},{key:"_clearCheck",value:function(){this.onlineCheckId&&(clearTimeout(this.onlineCheckId),this.onlineCheckId=0)}},{key:"_handleOnlineEvent",value:function(a){this.offlineCounter=0,this.checkOnlineStatus()}},{key:"_onlineExpired",value:function(){this._clearCheck(),this._changeToOffline(),this._scheduleNextOnlineCheck()}},{key:"checkOnlineStatus",value:function(a){var b=this;this._clearCheck(),k.info("OnlineStateManager: Firing XHR for online check"),this._lastCheckOnlineStatus=new Date,j({url:this.testUrl,method:"POST",headers:{accept:"application/vnd.layer+json; version=1.0"}},function(){a&&a(b.isOnline)})}},{key:"_changeToOffline",value:function(){this.isOnline&&(this.isOnline=!1,this.trigger("disconnected"),k.info("OnlineStateManager: Connection lost"))}},{key:"_connectionListener",value:function(a){if("connection:success"===a.status){var b=this.lastMessageTime;this.lastMessageTime=new Date,this.isOnline||(this.isOnline=!0,this.offlineCounter=0,this.trigger("connected",{offlineDuration:b?Date.now()-b:0}),void 0===this.connectedCounter&&(this.connectedCounter=0),this.connectedCounter++,k.info("OnlineStateManager: Connected restored"))}else this._changeToOffline();this._scheduleNextOnlineCheck()}},{key:"destroy",value:function(){this._clearCheck(),this.socketManager=null,h(Object.getPrototypeOf(OnlineStateManager.prototype),"destroy",this).call(this)}}]),OnlineStateManager}(i);OnlineStateManager.prototype.isClientReady=!1,OnlineStateManager.prototype.testUrl="",OnlineStateManager.prototype.socketManager=null,OnlineStateManager.prototype.offlineCounter=0,OnlineStateManager.prototype.maxOfflineWait=300,OnlineStateManager.prototype.minBackoffWait=100,OnlineStateManager.prototype.lastMessageTime=null,OnlineStateManager.prototype._lastCheckOnlineStatus=null,OnlineStateManager.prototype.isOnline=!1,OnlineStateManager.prototype.onlineCheckId=0,OnlineStateManager.prototype._firstStart=!0,OnlineStateManager.prototype.pingFrequency=1e5,OnlineStateManager._supportedEvents=["connected","disconnected"].concat(i._supportedEvents),i.initClass.apply(OnlineStateManager,[OnlineStateManager,"OnlineStateManager"]),b.exports=OnlineStateManager},{"./client-utils":7,"./logger":14,"./root":20,"./xhr":32}],18:[function(a,b,c){"use strict";function d(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var f=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),Query=a("./query"),LayerError=a("./layer-error"),g=function(){function a(b){e(this,a),b?this._query={model:b.model,returnType:b.returnType,dataType:b.dataType,paginationWindow:b.paginationWindow}:this._query={model:Query.Message,returnType:"object",dataType:"object",paginationWindow:Query.prototype.paginationWindow},this._conversationIdSet=!1}return f(a,[{key:"forConversation",value:function(a){return a?(this._query.predicate="conversation.id = '"+a+"'",this._conversationIdSet=!0):(delete this._query.predicate,this._conversationIdSet=!1),this}},{key:"paginationWindow",value:function(a){return this._query.paginationWindow=a,this}},{key:"build",value:function(){if(!this._conversationIdSet)throw new Error(LayerError.dictionary.conversationMissing);return this._query}}]),a}(),h=function(){function a(b){e(this,a),b?this._query={model:b.model,returnType:b.returnType,dataType:b.dataType,paginationWindow:b.paginationWindow,sortBy:b.sortBy}:this._query={model:Query.Conversation,returnType:"object",dataType:"object",paginationWindow:Query.prototype.paginationWindow,sortBy:null}}return f(a,[{key:"paginationWindow",value:function(a){return this._query.paginationWindow=a,this}},{key:"sortBy",value:function(a){var b=arguments.length<=1||void 0===arguments[1]?!1:arguments[1];return this._query.sortBy=[d({},a,b?"asc":"desc")],this}},{key:"build",value:function(){return this._query}}]),a}(),i={messages:function(){return new g},conversations:function(){return new h},fromQueryObject:function(a){switch(a.model){case Query.Message:return new g(a);case Query.Conversation:return new h(a);default:return null}}};b.exports=i},{"./layer-error":12,"./query":19}],19:[function(a,b,c){"use strict";function d(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function g(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},j=a("./root"),LayerError=a("./layer-error"),k=a("./client-utils"),l=a("./logger"),m="Conversation",n="Message",o=new RegExp(/^conversation.id\s*=\s*['"]((temp_)?layer:\/\/\/conversations\/.{8}-.{4}-.{4}-.{4}-.{12})['"]$/),Query=function(a){function Query(){e(this,Query);var a=void 0;if(2===arguments.length?(a=(arguments.length<=1?void 0:arguments[1]).build(),a.client=arguments.length<=0?void 0:arguments[0]):a=arguments.length<=0?void 0:arguments[0],"paginationWindow"in a){var b=a.paginationWindow;a.paginationWindow=Math.min(Query.MaxPageSize,a.paginationWindow),a.paginationWindow!==b&&l.warn("paginationWindow value "+b+" in Query constructor excedes Query.MaxPageSize of "+Query.MaxPageSize)}var c=f(this,Object.getPrototypeOf(Query).call(this,a));if(c.data=[],c._initialPaginationWindow=c.paginationWindow,!c.client)throw new Error(LayerError.dictionary.clientMissing);return c.client.on("all",c._handleChangeEvents,c),c.client.isReady?c._run():c.client.once("ready",function(){return c._run()},c),c}return g(Query,a),h(Query,[{key:"destroy",value:function(){this.client.off(null,null,this),this.client._removeQuery(this),this.data=null,i(Object.getPrototypeOf(Query.prototype),"destroy",this).call(this)}},{key:"update",value:function(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],b=void 0,c=void 0,d="function"==typeof a.build?a.build():a;return"paginationWindow"in d&&this.paginationWindow!==d.paginationWindow&&(this.paginationWindow=Math.min(Query.MaxPageSize+this.size,d.paginationWindow),this.paginationWindow<d.paginationWindow&&l.warn("paginationWindow value "+d.paginationWindow+" in Query.update() increases size greater than Query.MaxPageSize of "+Query.MaxPageSize),b=!0),"predicate"in d&&this.predicate!==d.predicate&&(this.predicate=d.predicate||"",c=!0),"model"in d&&this.model!==d.model&&(this.model=d.model,c=!0),"sortBy"in d&&JSON.stringify(this.sortBy)!==JSON.stringify(d.sortBy)&&(this.sortBy=d.sortBy,c=!0),c&&this._reset(),(c||b)&&this._run(),this}},{key:"_reset",value:function(){this.totalSize=0;var a=this.data;this.data=[],this.client._checkCache(a),this.isFiring=!1,this._predicate=null,this.paginationWindow=this._initialPaginationWindow,this._triggerChange({data:[],type:"reset"})}},{key:"reset",value:function(){this._reset(),this._run()}},{key:"_run",value:function(){var a=Math.min(this.paginationWindow-this.size,Query.MaxPageSize);if(0>a){var b=this.data.slice(this.paginationWindow);this.data=this.data.slice(0,this.paginationWindow),this.client._checkCache(b),this._triggerAsync("change",{data:[]})}else 0===a||(this.model===m?this._runConversation(a):this.model===n&&this.predicate&&this._runMessage(a))}},{key:"_runConversation",value:function(a){var b=this,c=this.data[this.data.length-1],d=c?this._getInstance(c):null,e=d&&d.isSaved()?"&from_id="+d.id:"",f=this._getSortField();this.isFiring=!0;var g=this._firingRequest="conversations?sort_by="+f+"&page_size="+a+e;this.client.xhr({url:g,method:"GET",sync:!1},function(a){return b._processRunResults(a,g)})}},{key:"_getSortField",value:function(){return this.model===n?"position":this.sortBy&&this.sortBy[0]&&this.sortBy[0]["lastMessage.sentAt"]?"last_message":"created_at"}},{key:"_getConversationPredicateIds",value:function(){if(this.predicate.match(o)){var a=this.predicate.replace(o,"$1"),b=(this._predicate||a).replace(/^(temp_)?layer\:\/\/\/conversations\//,"");if(b)return{uuid:b,id:a}}}},{key:"_runMessage",value:function(a){var b=this,c=this.data[this.data.length-1],d=c?this._getInstance(c):null,e=d&&d.isSaved()?"&from_id="+d.id:"",f=this._getConversationPredicateIds();f?!function(){var d="layer:///conversations/"+f.uuid;b._predicate||(b._predicate=f.id);var g=b.client.getConversation(d);g&&g.lastMessage&&c&&c.id===g.lastMessage.id&&(e="");var h="conversations/"+f.uuid+"/messages?page_size="+a+e;b._predicate.match(/temp_/)||h===b._firingRequest||(b.isFiring=!0,b._firingRequest=h,b.client.xhr({url:h,method:"GET",sync:!1},function(a){return b._processRunResults(a,h)})),0===b.data.length&&g&&g.lastMessage&&(b.data=[b._getData(g.lastMessage)],b._triggerChange({type:"data",data:b._getData(g.lastMessage),query:b,target:b.client}))}():this.predicate.match(/['"]/)||l.error("This query may need to quote its value")}},{key:"_processRunResults",value:function(a,b){var c=this;b!==this._firingRequest||this.isDestroyed||(this.isFiring=!1,this._firingRequest="",a.success?a.data.length?(this._retryCount=0,this._appendResults(a),this.totalSize=a.xhr.getResponseHeader("Layer-Count")):0===this.size&&(this._retryCount<Query.MaxRetryCount?setTimeout(function(){c._retryCount++,c._run()},1500):(this._retryCount=0,this._triggerChange({type:"data",data:[],query:this,target:this.client}))):this.trigger("error",{error:a.data}))}},{key:"_appendResults",value:function(a){var b=this;a.data.forEach(function(a){return b.client._createObject(a)});var c=a.data.filter(function(a){return-1===b._getIndex(a.id)});this.dataType===Query.ObjectDataType&&(this.data=[].concat(this.data));var d=this.data;c.forEach(function(a){var c=void 0,e=b.client._getObject(a.id);c=b.model===n?b._getInsertMessageIndex(e,d):b._getInsertConversationIndex(e,d),d.splice(c,0,b._getData(e))}),this._triggerChange({type:"data",data:a.data.map(function(a){return b._getData(b.client._getObject(a.id))}),query:this,target:this.client})}},{key:"_getData",value:function(a){return this.dataType===Query.ObjectDataType?a.toObject():a}},{key:"_getInstance",value:function(a){return a instanceof j?a:this.client._getObject(a.id)}},{key:"_getItem",value:function(a){switch(k.typeFromID(a)){case"messages":if(this.model===n){var b=this._getIndex(a);return-1===b?null:this.data[b]}if(this.model===m){for(var b=0;b<this.data.length;b++){var c=this.data[b];if(c.lastMessage&&c.lastMessage.id===a)return c.lastMessage}return null}break;case"conversations":if(this.model===m){var b=this._getIndex(a);return-1===b?null:this.data[b]}}}},{key:"_getIndex",value:function(a){for(var b=0;b<this.data.length;b++)if(this.data[b].id===a)return b;return-1}},{key:"_handleChangeEvents",value:function(a,b){this.model===m?this._handleConversationEvents(b):this._handleMessageEvents(b)}},{key:"_handleConversationEvents",value:function(a){switch(a.eventName){case"conversations:change":this._handleConversationChangeEvent(a);break;case"conversations:add":this._handleConversationAddEvent(a);break;case"conversations:remove":this._handleConversationRemoveEvent(a)}}},{key:"_handleConversationChangeEvent",value:function(a){var b=this._getIndex(a.target.id);if(this.dataType===Query.ObjectDataType){var c=a.getChangesFor("id");c.length&&(b=this._getIndex(c[0].oldValue))}if(-1!==b){var e=this._getSortField(),f=a.hasProperty("lastMessage")&&"last_message"===e;this.dataType===Query.ObjectDataType?f?(this.data.splice(b,1),this.data=[a.target.toObject()].concat(d(this.data))):this.data=[].concat(d(this.data.slice(0,b)),[a.target.toObject()],d(this.data.slice(b+1))):f&&(this.data.splice(b,1),this.data.unshift(a.target)),this._triggerChange({type:"property",target:this._getData(a.target),query:this,isChange:!0,changes:a.changes})}}},{key:"_getInsertConversationIndex",value:function(a,b){var c=this._getSortField(),d=void 0;if("created_at"===c){for(d=0;d<b.length&&!(a.createdAt>=b[d].createdAt);d++);return d}var e=a.lastMessage?a.lastMessage.sentAt:a.createdAt;for(d=0;d<b.length;d++){var f=b[d].lastMessage?b[d].lastMessage.sentAt:b[d].createdAt;if(e>=f)break}return d}},{key:"_getInsertMessageIndex",value:function(a,b){var c=void 0;for(c=0;c<b.length&&!(a.position>b[c].position);c++);return c}},{key:"_handleConversationAddEvent",value:function(a){var b=this,c=a.conversations.filter(function(a){return-1===b._getIndex(a.id)});c.length&&!function(){var a=b.data;c.forEach(function(c){var d=b._getInsertConversationIndex(c,a);a.splice(d,0,b._getData(c))}),b.dataType===Query.ObjectDataType&&(b.data=[].concat(a)),b.totalSize+=c.length,c.forEach(function(a){var c=b._getData(a);b._triggerChange({type:"insert",index:b.data.indexOf(c),target:c,query:b})})}()}},{key:"_handleConversationRemoveEvent",value:function(a){var b=this,c=[];a.conversations.forEach(function(a){var e=b._getIndex(a.id);-1!==e&&(c.push({data:a,index:e}),b.dataType===Query.ObjectDataType?b.data=[].concat(d(b.data.slice(0,e)),d(b.data.slice(e+1))):b.data.splice(e,1))}),this.totalSize-=c.length,c.forEach(function(a){b._triggerChange({type:"remove",index:a.index,target:b._getData(a.data),query:b})})}},{key:"_handleMessageEvents",value:function(a){switch(a.eventName){case"conversations:change":this._handleMessageConvIdChangeEvent(a);break;case"messages:change":case"messages:read":this._handleMessageChangeEvent(a);break;case"messages:add":this._handleMessageAddEvent(a);break;case"messages:remove":this._handleMessageRemoveEvent(a)}}},{key:"_handleMessageConvIdChangeEvent",value:function(a){var b=a.getChangesFor("id");b.length&&this._predicate===b[0].oldValue&&(this._predicate=b[0].newValue,this.predicate="conversation.id = '"+this._predicate+"'",this._run())}},{key:"_handleMessagePositionChange",value:function(a,b){if(-1===b)return!1;var c=[].concat(d(this.data.slice(0,b)),d(this.data.slice(b+1))),e=this._getInsertMessageIndex(a.target,c);return e!==b?(c.splice(e,0,this._getData(a.target)),this.data=c,this._triggerChange({type:"property",target:this._getData(a.target),query:this,isChange:!0,changes:a.changes}),!0):void 0}},{key:"_handleMessageChangeEvent",value:function(a){var b=this._getIndex(a.target.id),c=a.getChangesFor("id");c.length&&(this.dataType===Query.ObjectDataType&&(b=this._getIndex(c[0].oldValue)),this._handleMessagePositionChange(a,b))||a.target.conversationId===this._predicate&&-1!==b&&(this.dataType===Query.ObjectDataType&&(this.data=[].concat(d(this.data.slice(0,b)),[a.target.toObject()],d(this.data.slice(b+1)))),this._triggerChange({type:"property",target:this._getData(a.target),query:this,isChange:!0,changes:a.changes}))}},{key:"_handleMessageAddEvent",value:function(a){var b=this,c=a.messages.filter(function(a){return a.conversationId===b._predicate}).filter(function(a){return-1===b._getIndex(a.id)}).map(function(a){return b._getData(a)});c.length&&!function(){var a=b.data=b.dataType===Query.ObjectDataType?[].concat(b.data):b.data;c.forEach(function(c){var d=b._getInsertMessageIndex(c,a);a.splice(d,0,c)}),b.totalSize+=c.length,c.forEach(function(a){b._triggerChange({type:"insert",index:b.data.indexOf(a),target:a,query:b})})}()}},{key:"_handleMessageRemoveEvent",value:function(a){var b=this,c=[];a.messages.forEach(function(a){var e=b._getIndex(a.id);-1!==e&&(c.push({data:a,index:e}),b.dataType===Query.ObjectDataType?b.data=[].concat(d(b.data.slice(0,e)),d(b.data.slice(e+1))):b.data.splice(e,1))}),this.totalSize-=c.length,c.forEach(function(a){b._triggerChange({type:"remove",target:b._getData(a.data),index:a.index,query:b})})}},{key:"_triggerChange",value:function(a){this.trigger("change",a),this.trigger("change:"+a.type,a)}}]),Query}(j);Query.prefixUUID="layer:///queries/",Query.Conversation=m,Query.Message=n,Query.ObjectDataType="object",Query.InstanceDataType="instance",Query.MaxPageSize=100,Object.defineProperty(Query.prototype,"size",{enumerable:!0,get:function(){return this.data?this.data.length:0}}),Query.prototype.totalSize=0,Query.prototype.client=null,Query.prototype.data=null,Query.prototype.model=m,Query.prototype.returnType="object",Query.prototype.dataType=Query.InstanceDataType,Query.prototype.paginationWindow=100,Query.prototype.sortBy=null,Query.prototype._initialPaginationWindow=100,Query.prototype.predicate=null,Query.prototype.isFiring=!1,Query.prototype._firingRequest="",Query.prototype._retryCount=0,Query.MaxRetryCount=20,Query._supportedEvents=["change","change:data","change:reset","change:property","change:insert","change:remove","error"].concat(j._supportedEvents),j.initClass.apply(Query,[Query,"Query"]),b.exports=Query},{"./client-utils":7,"./layer-error":12,"./logger":14,"./root":20}],20:[function(a,b,c){"use strict";function d(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function g(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);
a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function h(){}function i(a,b){var c="__"+b,d=b.substring(0,1).toUpperCase()+b.substring(1),e=a.prototype["__adjust"+d]||a.prototype["__update"+d]||a.prototype["__get"+d];e&&(a.prototype[c]=a.prototype[b],Object.defineProperty(a.prototype,b,{enumerable:!0,get:function(){return this["__get"+d]?this["__get"+d](c):this[c]},set:function(a){if(!this.isDestroyed){var b=this[c];if(a!==b){if(this["__adjust"+d]){var e=this["__adjust"+d](a);void 0!==e&&(a=e)}this[c]=a}a!==b&&!this.isInitializing&&this["__update"+d]&&this["__update"+d](a,b)}}}))}function j(a,b){a.name||(a.name=b),a._supportedEvents||(a._supportedEvents=s._supportedEvents),a._ignoredEvents||(a._ignoredEvents=s._ignoredEvents);var c=Object.keys(a.prototype).filter(function(b){return a.prototype.hasOwnProperty(b)&&!s.prototype.hasOwnProperty(b)&&"function"!=typeof a.prototype[b]});c.forEach(function(b){return i(a,b)})}var k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},l=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),m=a("./client-utils"),LayerEvent=a("./layer-event"),LayerError=a("./layer-error"),n=a("backbone-events-standalone/backbone-events-standalone"),o=a("./logger");h.prototype=n;var p=new h;"function"==typeof postMessage&&addEventListener("message",function(a){"layer-delayed-event"===a.data.type&&p.trigger(a.data.internalId+"-delayed-event")});var q={},r=/\s+/,s=function(a){function b(){var a=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];e(this,b);var c=f(this,Object.getPrototypeOf(b).call(this));c._subscriptions=[],c._delayedTriggers=[],c._lastDelayedTrigger=Date.now(),c._events={};var d=c.constructor.name;q[d]||(q[d]=0),c.internalId=d+q[d]++,p.on(c.internalId+"-delayed-event",c._processDelayedTriggers,c),c.id||a.id||!c.constructor.prefixUUID||(c.id="temp_"+c.constructor.prefixUUID+m.generateUUID());var g=void 0;for(g in a)-1!==c.constructor._supportedEvents.indexOf(g)?c.on(g,a[g]):g in c&&"function"!=typeof c[g]&&(c[g]=a[g]);return c.isInitializing=!1,c}return g(b,a),l(b,[{key:"_validateId",value:function(){var a=String(this.id),b=this.constructor.prefixUUID;return 0!==a.indexOf(b)&&0!==a.indexOf("temp_"+b)?!1:a.substring(b.length).match(/.{8}-.{4}-.{4}-.{4}-.{12}$/)?!0:!1}},{key:"destroy",value:function(){var a=this;if(this.isDestroyed)throw new Error(LayerError.dictionary.alreadyDestroyed);this.trigger("destroy"),p.off(this.internalId+"-delayed-event",null,this),this.off(),this._subscriptions.forEach(function(b){return b.off(null,null,a)}),this._subscriptions=null,this._delayedTriggers=null,this.isDestroyed=!0}},{key:"toObject",value:function(){var a=this,c=arguments.length<=0||void 0===arguments[0]?!1:arguments[0];this.__inToObject=!0;var d={};try{var e=Object.keys(this.constructor.prototype);e.forEach(function(e){var f=a[e];0!==e.indexOf("_")&&"function"!=typeof f&&(Array.isArray(f)?(d[e]=[],f.forEach(function(a){a instanceof b?c?delete d[e]:a.__inToObject||d[e].push(a.toObject()):d[e].push(a)})):f instanceof b?f.__inToObject||c||(d[e]=f.toObject()):f instanceof Date?d[e]=new Date(f):d[e]=f)})}catch(a){}return this.__inToObject=!1,d}},{key:"_warnForEvent",value:function(a){if(!m.includes(this.constructor._supportedEvents,a))throw new Error("Event "+a+" not defined for "+this.toString())}},{key:"_prepareOn",value:function(a,c,d){var e=this;if(d instanceof b){if(d.isDestroyed)throw new Error(LayerError.dictionary.isDestroyed);d._subscriptions.push(this)}if("string"==typeof a&&"all"!==a)if(r.test(a)){var f=a.split(r);f.forEach(function(a){return e._warnForEvent(a)})}else this._warnForEvent(a);else a&&"object"===("undefined"==typeof a?"undefined":k(a))&&Object.keys(a).forEach(function(a){return e._warnForEvent(a)})}},{key:"on",value:function(a,b,c){return this._prepareOn(a,b,c),n.on.apply(this,[a,b,c]),this}},{key:"once",value:function(a,b,c){return this._prepareOn(a,b,c),n.once.apply(this,[a,b,c]),this}},{key:"trigger",value:function(){return this._disableEvents?this:this._trigger.apply(this,arguments)}},{key:"_trigger",value:function(){if(!m.includes(this.constructor._supportedEvents,arguments.length<=0?void 0:arguments[0]))return void(m.includes(this.constructor._ignoredEvents,arguments.length<=0?void 0:arguments[0])||o.error(this.toString()+" ignored "+(arguments.length<=0?void 0:arguments[0])));var a=this._getTriggerArgs.apply(this,arguments);n.trigger.apply(this,a);var b=this.constructor.bubbleEventParent;if(b){var c,e=this[b];e="function"==typeof e?e.apply(this):e,e&&(c=e).trigger.apply(c,d(a))}}},{key:"_getTriggerArgs",value:function(){for(var a=this,b=arguments.length,c=Array(b),d=0;b>d;d++)c[d]=arguments[d];var e=Array.prototype.slice.call(c);return c[1]?!function(){var b={target:a};e[1]instanceof LayerEvent||("object"===k(e[1])?Object.keys(e[1]).forEach(function(a){b[a]=e[1][a]}):b.data=e[1],e[1]=new LayerEvent(b,e[0]))}():e[1]=new LayerEvent({target:this},e[0]),e}},{key:"_triggerAsync",value:function(){var a=this,b=this._getTriggerArgs.apply(this,arguments);this._delayedTriggers.push(b);var c=1===this._delayedTriggers.length||this._delayedTriggers.length&&this._lastDelayedTrigger+500<Date.now();c&&(this._lastDelayedTrigger=Date.now(),"function"==typeof postMessage&&"undefined"==typeof jasmine?window.postMessage({type:"layer-delayed-event",internalId:this.internalId},"*"):setTimeout(function(){return a._processDelayedTriggers()},0))}},{key:"_foldEvents",value:function(a,b,c){var d=a.length?a[0][1]:null,e=d?d[b]:null;a.forEach(function(a,c){c>0&&(e.push(a[1][b][0]),this._delayedTriggers.splice(this._delayedTriggers.indexOf(a),1))},this),a.length&&c&&(a[0][1].target=c)}},{key:"_foldChangeEvents",value:function(){var a=this,b=this._delayedTriggers.filter(function(a){return a[1].isChange});b.forEach(function(c,d){d>0&&(b[0][1]._mergeChanges(c[1]),a._delayedTriggers.splice(a._delayedTriggers.indexOf(c),1))})}},{key:"_processDelayedTriggers",value:function(){this.isDestroyed||(this._foldChangeEvents(),this._delayedTriggers.forEach(function(a){this.trigger.apply(this,d(a))},this),this._delayedTriggers=[])}},{key:"toString",value:function(){return this.internalId}}]),b}(h);s.prototype.isDestroyed=!1,s.prototype.internalId="",s.prototype.isInitializing=!0,s.prototype._subscriptions=null,s.prototype._disableEvents=!1,s._supportedEvents=["destroy","all"],s._ignoredEvents=[],b.exports=s,b.exports.initClass=j},{"./client-utils":7,"./layer-error":12,"./layer-event":13,"./logger":14,"backbone-events-standalone/backbone-events-standalone":2}],21:[function(a,b,c){"use strict";function d(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function e(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function f(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),SyncEvent=function(){function SyncEvent(a){f(this,SyncEvent);var b=void 0;for(b in a)b in this&&(this[b]=a[b]);this.depends||(this.depends=[])}return g(SyncEvent,[{key:"destroy",value:function(){this.target=null,this.depends=null,this.callback=null,this.data=null}},{key:"_updateData",value:function(){"function"==typeof this.data&&(this.data=this.data())}},{key:"toObject",value:function(){return{data:this.data}}}]),SyncEvent}();SyncEvent.prototype.operation="",Object.defineProperty(SyncEvent.prototype,"isFiring",{enumerable:!0,set:function(a){this.__isFiring=a,a&&(this.__firedAt=Date.now())},get:function(){return Boolean(this.__isFiring&&Date.now()-this.__firedAt<SyncEvent.FIRING_EXPIRIATION)}}),SyncEvent.prototype.success=null,SyncEvent.prototype.callback=null,SyncEvent.prototype.retryCount=0,SyncEvent.prototype.target=null,SyncEvent.prototype.depends=null,SyncEvent.prototype.data=null,SyncEvent.FIRING_EXPIRIATION=12e4;var h=function(a){function b(){return f(this,b),d(this,Object.getPrototypeOf(b).apply(this,arguments))}return e(b,a),g(b,[{key:"_getRequestData",value:function(){return this._updateUrl(),this._updateData(),{url:this.url,method:this.method,headers:this.headers,data:this.data}}},{key:"_updateUrl",value:function(){"function"==typeof this.url&&(this.url=this.url())}},{key:"toObject",value:function(){return{data:this.data,url:this.url,method:this.method}}}]),b}(SyncEvent);h.prototype.timeout=15e3,h.prototype.url="",h.prototype.returnToOnlineCount=0,h.prototype.headers=null,h.prototype.method="GET";var i=function(a){function b(){return f(this,b),d(this,Object.getPrototypeOf(b).apply(this,arguments))}return e(b,a),g(b,[{key:"_getRequestData",value:function(){return this._updateData(),this.data}},{key:"toObject",value:function(){return this.data}}]),b}(SyncEvent);b.exports={SyncEvent:SyncEvent,XHRSyncEvent:h,WebsocketSyncEvent:i}},{}],22:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./root"),j=a("./sync-event"),k=j.WebsocketSyncEvent,l=a("./xhr"),m=a("./logger"),n=a("./client-utils"),SyncManager=function(a){function SyncManager(a){d(this,SyncManager);var b=e(this,Object.getPrototypeOf(SyncManager).call(this,a));return a.client&&a.client.on("authenticated",b._processNextRequest,b),b.queue=[],b.onlineManager.on("disconnected",b._onlineStateChange,b),b.socketManager.on("connected disconnected",b._onlineStateChange,b),b}return f(SyncManager,a),g(SyncManager,[{key:"isOnline",value:function(){return this.onlineManager.isOnline}},{key:"_onlineStateChange",value:function(a){var b=this;"connected"===a.eventName?(this.queue.length&&this.queue[0].returnToOnlineCount++,setTimeout(function(){return b._processNextRequest()},100)):"disconnected"===a.eventName&&this.queue.length&&(this.queue[0].isFiring=!1)}},{key:"request",value:function(a){"PATCH"===a.operation&&this._findUnfiredCreate(a)?(m.info("Sync Manager Request PATCH "+a.target+" request ignored; create request still enqueued"),m.debug(a.toObject())):(m.info("Sync Manager Request "+a.operation+" on target "+a.target),m.debug(a.toObject()),this.queue.push(a),this.trigger("sync:add",{request:a,target:a.target})),"DELETE"===a.operation&&this._purgeOnDelete(a),1===this.queue.length&&this._processNextRequest()}},{key:"_findUnfiredCreate",value:function(a){return Boolean(this.queue.filter(function(b){return b.target===a.target&&"POST"===b.operation&&!b.isFiring}).length)}},{key:"_processNextRequest",value:function(){var a=this;if(!this.isDestroyed){var b=this.queue[0];this.isOnline()&&b&&!b.isFiring?b instanceof k?this.socketManager&&this.socketManager._isOpen()?(m.debug("Sync Manager Websocket Request Firing "+b.operation+" on target "+b.target,b.toObject()),this.requestManager.sendRequest(b._getRequestData(),function(c){return a._xhrResult(c,b)}),b.isFiring=!0):m.debug("Sync Manager Websocket Request skipped; socket closed"):(m.debug("Sync Manager XHR Request Firing "+b.operation+" "+b.target,b.toObject()),l(b._getRequestData(),function(c){return a._xhrResult(c,b)}),b.isFiring=!0):b&&b.isFiring&&m.debug("Sync Manager processNext skipped; request still firing "+b.operation+" on target "+b.target,b.toObject())}}},{key:"_xhrResult",value:function(a,b){a.request=b,b.isFiring=!1,a.success?this._xhrSuccess(a):this._xhrError(a)}},{key:"_getErrorState",value:function(a,b,c){return c?404===a.status&&a.data&&102===a.data.code?"notFound":408===a.status?b.retryCount>=SyncManager.MAX_RETRIES?"tooManyFailuresWhileOnline":"validateOnlineAndRetry":-1!==[502,503,504].indexOf(a.status)?b.retryCount>=SyncManager.MAX_RETRIES?"tooManyFailuresWhileOnline":"serverUnavailable":401===a.status&&a.data.data&&a.data.data.nonce?"reauthorize":"serverRejectedRequest":b.returnToOnlineCount>=SyncManager.MAX_RETRIES_BEFORE_CORS_ERROR?"CORS":"offline"}},{key:"_xhrError",value:function(a){var b=a.request;m.warn("Sync Manager "+(b instanceof k?"Websocket":"XHR")+" "+(b.operation+" Request on target "+b.target+" has Failed"),b.toObject());var c=this._getErrorState(a,b,this.isOnline());switch(m.warn("Sync Manager Error State: "+c),c){case"tooManyFailuresWhileOnline":this._xhrHandleServerError(a,"Sync Manager Server Unavailable Too Long; removing request");break;case"notFound":this._xhrHandleServerError(a,"Resource not found; presumably deleted");break;case"validateOnlineAndRetry":this._xhrValidateIsOnline();break;case"serverUnavailable":this._xhrHandleServerUnavailableError(b);break;case"reauthorize":b.callback(a);break;case"serverRejectedRequest":this._xhrHandleServerError(a,"Sync Manager Server Rejects Request; removing request");break;case"CORS":this._xhrHandleServerError(a,"Sync Manager Server detects CORS-like errors; removing request");break;case"offline":this._xhrHandleConnectionError()}}},{key:"_xhrHandleServerUnavailableError",value:function(a){var b=SyncManager.MAX_UNAVAILABLE_RETRY_WAIT,c=n.getExponentialBackoffSeconds(b,Math.min(15,a.retryCount++));m.warn("Sync Manager Server Unavailable; retry count "+a.retryCount+"; retrying in "+c+" seconds"),setTimeout(this._processNextRequest.bind(this),1e3*c)}},{key:"_xhrHandleServerError",value:function(a,b){a.request.callback(a),m.error(b,a.request),this.trigger("sync:error",{target:a.request.target,request:a.request,error:a.data}),a.request.success=!1,"POST"===a.request.operation&&this._purgeDependentRequests(a.request),this._removeRequest(a.request),this._processNextRequest()}},{key:"_xhrHandleConnectionError",value:function(){}},{key:"_xhrValidateIsOnline",value:function(){var a=this;m.debug("Sync Manager verifying online state"),this.onlineManager.checkOnlineStatus(function(b){return a._xhrValidateIsOnlineCallback(b)})}},{key:"_xhrValidateIsOnlineCallback",value:function(a){m.debug("Sync Manager online check result is "+a),a?(this.queue[0].retryCount++,this._processNextRequest()):this._xhrHandleConnectionError()}},{key:"_xhrSuccess",value:function(a){var b=a.request;m.debug("Sync Manager "+(b instanceof k?"Websocket":"XHR")+" "+(b.operation+" Request on target "+b.target+" has Succeeded"),b.toObject()),a.data&&m.debug(a.data),b.success=!0,this._removeRequest(b),b.callback&&b.callback(a),this._processNextRequest(),this.trigger("sync:success",{target:b.target,request:b,response:a.data})}},{key:"_removeRequest",value:function(a){var b=this.queue.indexOf(a);-1!==b&&this.queue.splice(b,1)}},{key:"_purgeDependentRequests",value:function(a){this.queue=this.queue.filter(function(b){return-1===b.depends.indexOf(a.target)||b===a})}},{key:"_purgeOnDelete",value:function(a){this.queue=this.queue.filter(function(b){return-1===b.depends.indexOf(a.target)||a===b})}},{key:"destroy",value:function(){this.queue.forEach(function(a){return a.destroy()}),this.queue=null,h(Object.getPrototypeOf(SyncManager.prototype),"destroy",this).call(this)}}]),SyncManager}(i);SyncManager.prototype.socketManager=null,SyncManager.prototype.requestManager=null,SyncManager.prototype.onlineManager=null,SyncManager.prototype.queue=null,SyncManager.MAX_UNAVAILABLE_RETRY_WAIT=900,SyncManager.MAX_RETRIES_BEFORE_CORS_ERROR=3,SyncManager.MAX_RETRIES=20,SyncManager._supportedEvents=["sync:error","sync:success","sync:add"].concat(i._supportedEvents),i.initClass(SyncManager),b.exports=SyncManager},{"./client-utils":7,"./logger":14,"./root":20,"./sync-event":21,"./xhr":32}],23:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=a("./root"),i=a("./const"),j=function(a){function b(){return d(this,b),e(this,Object.getPrototypeOf(b).apply(this,arguments))}return f(b,a),g(b,[{key:"_setSyncing",value:function(){switch(this._clearObject(),this.syncState){case i.SYNC_STATE.SYNCED:this.syncState=i.SYNC_STATE.SYNCING;break;case i.SYNC_STATE.NEW:this.syncState=i.SYNC_STATE.SAVING}this._syncCounter++}},{key:"_setSynced",value:function(){this._clearObject(),this._syncCounter>0&&this._syncCounter--,this.syncState=0===this._syncCounter?i.SYNC_STATE.SYNCED:i.SYNC_STATE.SYNCING,this.isSending=!1}},{key:"_clearObject",value:function(){this._toObject=null}},{key:"isNew",value:function(){return this.syncState===i.SYNC_STATE.NEW}},{key:"isSaving",value:function(){return this.syncState===i.SYNC_STATE.SAVING}},{key:"isSaved",value:function(){return!(this.isNew()||this.isSaving())}},{key:"isSynced",value:function(){return this.syncState===i.SYNC_STATE.SYNCED}}]),b}(h);j.prototype.syncState=i.SYNC_STATE.NEW,j.prototype._syncCounter=0,Object.defineProperty(j.prototype,"isLoading",{enumerable:!0,get:function(){return this.syncState===i.SYNC_STATE.LOADING}}),j._supportedEvents=[].concat(h._supportedEvents),j.inObjectIgnore=h.inObjectIgnore,b.exports=j},{"./const":9,"./root":20}],24:[function(a,b,c){"use strict";function d(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function g(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var h=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),i=a("../root"),j=a("../client-registry"),k=a("./typing-indicators"),l=k.STARTED,m=k.PAUSED,n=k.FINISHED,o=function(a){function b(a){e(this,b);var c=f(this,Object.getPrototypeOf(b).call(this,a));c.state={},c._pollId=0;var d=c._getClient();return d.on("ready",function(){return c._clientReady()}),c}return g(b,a),h(b,[{key:"_clientReady",value:function(){var a=this._getClient();this.userId=a.userId;var b=a.socketManager;b.on("message",this._handleSocketEvent,this),this._startPolling()}},{key:"_isRelevantEvent",value:function(a){return"signal"===a.type&&"typing_indicator"===a.body.type&&a.body.data.user_id!==this.userId}},{key:"_handleSocketEvent",value:function(a){var b=a.data;if(this._isRelevantEvent(b)){var c=b.body.data.user_id,d=b.body.data.action,e=b.body.object.id,f=this.state[e];f||(f=this.state[e]={users:{},typing:[],paused:[]}),f.users[c]={startTime:Date.now(),state:d},f.users[c].state===n&&delete f.users[c],this._updateState(f,d,c),this.trigger("typing-indicator-change",{conversationId:e,typing:f.typing,paused:f.paused})}}},{key:"_updateState",value:function(a,b,c){var e=a.typing.indexOf(c);b!==l&&-1!==e&&(a.typing=[].concat(d(a.typing.slice(0,e)),d(a.typing.slice(e+1))));var f=a.paused.indexOf(c);b!==m&&-1!==f&&(a.paused=[].concat(d(a.paused.slice(0,f)),d(a.paused.slice(f+1)))),b===l&&-1===e?a.typing=[].concat(d(a.typing),[c]):b===m&&-1===f&&(a.paused=[].concat(d(a.paused),[c]))}},{key:"_startPolling",value:function(){var a=this;this._pollId||(this._pollId=setInterval(function(){return a._poll()},5e3))}},{key:"_poll",value:function(){var a=this,b=Object.keys(this.state);b.forEach(function(b){var c=a.state[b];Object.keys(a.state[b].users).forEach(function(d){Date.now()>=c.users[d].startTime+6e3&&(a._updateState(c,n,d),delete c.users[d],a.trigger("typing-indicator-change",{conversationId:b,typing:c.typing,paused:c.paused}))})})}},{key:"_getClient",value:function(){return j.get(this.clientId)}}]),b}(i);o.prototype._pollId=0,o.prototype.clientId="",o.bubbleEventParent="_getClient",o._supportedEvents=["typing-indicator-change"].concat(i._supportedEvents),i.initClass.apply(o,[o,"TypingIndicatorListener"]),b.exports=o},{"../client-registry":6,"../root":20,"./typing-indicators":25}],25:[function(a,b,c){"use strict";b.exports={STARTED:"started",PAUSED:"paused",FINISHED:"finished"}},{}],26:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("./typing-publisher"),g=a("./typing-indicators"),h=g.STARTED,i=(g.PAUSED,g.FINISHED),j=function(){function a(b){d(this,a),this.clientId=b.clientId,this.conversation=b.conversation,this.publisher=new f({clientId:this.clientId,conversation:this.conversation}),this.intervalId=0,this.lastKeyId=0,this._handleKeyPress=this._handleKeyPress.bind(this),this._handleKeyDown=this._handleKeyDown.bind(this),this.setInput(b.input)}return e(a,[{key:"destroy",value:function(){this._removeInput(this.input),this.publisher.destroy()}},{key:"setInput",value:function(a){a!==this.input&&(this._removeInput(this.input),this.input=a,this.input.addEventListener("keypress",this._handleKeyPress),this.input.addEventListener("keydown",this._handleKeyDown))}},{key:"_removeInput",value:function(a){a&&(a.removeEventListener("keypress",this._handleKeyPress),a.removeEventListener("keydown",this._handleKeyDown),this.input=null)}},{key:"setConversation",value:function(a){a!==this.conversation&&(this.conversation=a,this.publisher.setConversation(a))}},{key:"_handleKeyPress",value:function(a){var b=this;this.lastKeyId&&window.clearTimeout(this.lastKeyId),this.lastKeyId=window.setTimeout(function(){b.lastKeyId=0;var a=!Boolean(b.input.value);b.send(a?i:h)},50)}},{key:"_handleKeyDown",value:function(a){-1!==[8,46,13].indexOf(a.keyCode)&&this._handleKeyPress()}},{key:"send",value:function(a){this.publisher.setState(a)}}]),a}();b.exports=j},{"./typing-indicators":25,"./typing-publisher":27}],27:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=2500,g=a("./typing-indicators"),h=g.STARTED,i=g.PAUSED,j=g.FINISHED,k=a("../client-registry"),l=function(){function a(b){d(this,a),this.clientId=b.clientId,b.conversation&&(this.conversation=this._getClient().getConversation(b.conversation.id)),this.state=j,this._lastMessageTime=0}return e(a,[{key:"setConversation",value:function(a){this.setState(j),this.conversation=a?this._getClient().getConversation(a.id):null,this.state=j}},{key:"setState",value:function(a){if(this._pauseLoopId&&(clearInterval(this._pauseLoopId),this._pauseLoopId=0),this.conversation){if(this.state!==a)this.state=a,this._send(a);else{if(a===j)return;Date.now()>this._lastMessageTime+f?this._send(a):this._scheduleNextMessage(a)}this.state!==j&&this._startPauseLoop()}}},{key:"_startPauseLoop",value:function(){var a=this;this._pauseLoopId||(this._pauseLoopId=window.setInterval(function(){a.state===i?a.setState(j):a.state===h&&a.setState(i)},f))}},{key:"_scheduleNextMessage",value:function(a){var b=this;this._scheduleId&&clearTimeout(this._scheduleId);var c=f-Math.min(Date.now()-this._lastMessageTime,f);this._scheduleId=setTimeout(function(){b._scheduleId=0,b.state===a&&b._send(a)},c)}},{key:"_send",value:function(a){if(this.conversation.isSaved()){this._lastMessageTime=Date.now();var b=this._getClient().socketManager;b.sendSignal({type:"typing_indicator",object:{id:this.conversation.id},data:{action:a}})}}},{key:"_getClient",value:function(){return k.get(this.clientId)}},{key:"destroy",value:function(){delete this.conversation,clearTimeout(this._scheduleId),clearInterval(this._pauseLoopId)}}]),a}();b.exports=l},{"../client-registry":6,"./typing-indicators":25}],28:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("./root"),j=a("./client-utils"),User=function(a){function User(a){d(this,User);var b=e(this,Object.getPrototypeOf(User).call(this,a));return b.on("all",b._clearObject,b),b}return f(User,a),g(User,[{key:"setClient",value:function(a){if(a){var b=Object.keys(a._conversationsHash).map(function(b){return a.getConversation(b)}).filter(function(a){return 2==a.participants.length&&-1!=a.participants.indexOf(this.id)},this);j.sortBy(b,function(a){return a.lastMessage?a.lastMessage.sentAt:null},!0),b.length?this.conversation=b[0]:a.on("conversations:add",this._checkNewConversation,this)}}},{key:"_checkNewConversation",value:function(a){var b=this,c=a.conversations;c.forEach(function(a){2==a.participants.length&&-1!=a.participants.indexOf(b.id)&&(b.conversation=a,a.client.off(null,null,b))})}},{key:"__updateConversation",value:function(a,b){b&&b.off(null,null,this),a&&a.on("destroy",this._destroyConversation,this),this.trigger("conversations:change")}},{key:"_destroyConversation",value:function(a){this.conversation=null}},{key:"toObject",value:function(){return this._toObject||(this._toObject=h(Object.getPrototypeOf(User.prototype),"toObject",this).call(this)),this._toObject}},{key:"_clearObject",value:function(){delete this._toObject}}]),User}(i);User.prototype.data=null,User.prototype.id="",User.prototype.displayName="",User.prototype.iconClass="",User.prototype.conversation=null,User.prototype._toObject=null,User._supportedEvents=["conversations:change"].concat(i._supportedEvents),i.initClass.apply(User,[User,"User"]),b.exports=User},{"./client-utils":7,"./root":20}],29:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("../client-utils"),g=a("../logger"),Message=a("../message"),Conversation=a("../conversation"),h=function(){function a(b){d(this,a),this.client=b.client,b.socketManager.on("message",this._handleChange,this)}return e(a,[{key:"_handleChange",value:function(a){if("change"===a.data.type){var b=a.data.body;switch(b.operation){case"create":g.info("Websocket Change Event: Create "+b.object.type+" "+b.object.id),g.debug(b.data),this._handleCreate(b);break;case"delete":g.info("Websocket Change Event: Delete "+b.object.type+" "+b.object.id),g.debug(b.data),this._handleDelete(b);break;case"patch":g.info("Websocket Change Event: Patch "+b.object.type+" "+b.object.id+": "+b.data.map(function(a){return a.property}).join(", ")),g.debug(b.data),this._handlePatch(b)}}}},{key:"_handleCreate",value:function(a){a.data.fromWebsocket=!0,this.client._createObject(a.data)}},{key:"_handleDelete",value:function(a){var b=this._getObject(a);b&&(b._deleted(),b.destroy())}},{key:"_handlePatch",value:function(a){var b=this._getObject(a);if(b)try{b._inLayerParser=!0,f.layerParse({object:b,type:a.object.type,operations:a.data,client:this.client}),b._inLayerParser=!1}catch(b){g.error("websocket-manager: Failed to handle event",a.data)}else"conversations"===f.typeFromID(a.object.id)?Conversation._loadResourceForPatch(a.data)&&this.client.getConversation(a.object.id,!0):"messages"===f.typeFromID(a.object.id)&&Message._loadResourceForPatch(a.data)&&this.client.getMessage(a.object.id,!0)}},{key:"_getObject",value:function(a){return this.client._getObject(a.object.id)}},{key:"destroy",value:function(){this.client=null}}]),a}();h.prototype.client=null,b.exports=h},{"../client-utils":7,"../conversation":11,"../logger":14,"../message":16}],30:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var e=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),f=a("../client-utils"),g=a("../logger"),LayerError=a("../layer-error"),h=15e3,i=function(){function a(b){d(this,a),this.client=b.client,this.socketManager=b.socketManager,this.socketManager.on({message:this._handleResponse,disconnected:this._reset},this),this._requestCallbacks={}}return e(a,[{key:"_reset",value:function(){this._requestCallbacks={}}},{key:"_handleResponse",value:function(a){if("response"===a.data.type){var b=a.data.body,c=b.request_id,d=b.success?b.data:new LayerError(b.data);
g.debug("Websocket response "+c+" "+(b.success?"Successful":"Failed")),c&&this._requestCallbacks[c]&&(this._requestCallbacks[c].callback({success:b.success,fullData:a.data,data:d}),delete this._requestCallbacks[c])}}},{key:"sendRequest",value:function(a,b){if(!this._isOpen())return b?b(new LayerError({success:!1,data:{id:"not_connected",code:0,message:"WebSocket not connected"}})):void 0;var c=f.clone(a);c.request_id="r"+this._nextRequestId++,g.debug("Request "+c.request_id+" is sending"),b&&(this._requestCallbacks[c.request_id]={date:Date.now(),callback:b}),this.socketManager.send({type:"request",body:c}),this._scheduleCallbackCleanup()}},{key:"_scheduleCallbackCleanup",value:function(){this._callbackCleanupId||(this._callbackCleanupId=setTimeout(this._runCallbackCleanup.bind(this),h+50))}},{key:"_runCallbackCleanup",value:function(){var a=this;if(this._callbackCleanupId=0,!this.isDestroyed&&this._isOpen()){var b=0,c=Date.now();Object.keys(this._requestCallbacks).forEach(function(d){var e=a._requestCallbacks[d];if(e&&c<e.date+h)b++;else{if(c>a.socketManager._lastDataFromServerTimestamp+h)return a.socketManager._reconnect(!1),void a._scheduleCallbackCleanup();a._timeoutRequest(d)}}),b&&this._scheduleCallbackCleanup()}}},{key:"_timeoutRequest",value:function(a){try{g.warn("Websocket request timeout"),this._requestCallbacks[a].callback({success:!1,data:new LayerError({id:"request_timeout",message:"The server is not responding. We know how much that sucks.",url:"https:/developer.layer.com/docs/websdk",code:0,status:408,httpStatus:408})})}catch(a){}delete this._requestCallbacks[a]}},{key:"_isOpen",value:function(){return this.socketManager._isOpen()}},{key:"destroy",value:function(){this.isDestroyed=!0,this._callbackCleanupId&&clearTimeout(this._callbackCleanupId),this._requestCallbacks=null}}]),a}();i.prototype._nextRequestId=1,i.prototype.client=null,i.prototype._requestCallbacks=null,i.prototype._callbackCleanupId=0,i.prototype.socketManager=null,b.exports=i},{"../client-utils":7,"../layer-error":12,"../logger":14}],31:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!b||"object"!=typeof b&&"function"!=typeof b?a:b}function f(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}var g=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),h=function a(b,c,d){null===b&&(b=Function.prototype);var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;if(void 0!==g)return g.call(d)},i=a("../root"),j=a("../client-utils"),k=a("../logger"),l=function(b){function c(a){d(this,c);var b=e(this,Object.getPrototypeOf(c).call(this,a));if(!b.client)throw new Error("SocketManager requires a client");return b._onMessage=b._onMessage.bind(b),b._onOpen=b._onOpen.bind(b),b._onSocketClose=b._onSocketClose.bind(b),b._onError=b._onError.bind(b),b.client.isAuthenticated&&b.client.onlineManager.isOnline&&b.connect(),b.client.on("online",b._onlineStateChange,b),b.client.on("authenticated",b.connect,b),b._lastTimestamp=Date.now(),b}return f(c,b),g(c,[{key:"_reset",value:function(){this._lastTimestamp=0,this._lastDataFromServerTimestamp=0,this._lastCounter=null,this._hasCounter=!1,this._inReplay=!1,this._needsReplayFrom=null}},{key:"_onlineStateChange",value:function(a){this.client.isAuthenticated&&(a.isOnline?this._reconnect(a.reset):this.close())}},{key:"_reconnect",value:function(a){this.close(),a&&this._reset(),this.connect()}},{key:"connect",value:function(b){if(!this.client.isDestroyed&&this.client.isOnline){this._closing=!1,this._lastCounter=-1;var c="undefined"==typeof WebSocket?a("websocket").w3cwebsocket:WebSocket,d=this.client.url.replace(/^http/,"ws")+"/websocket?session_token="+this.client.sessionToken;this._socket=new c(d,"layer-1.0"),"undefined"==typeof WebSocket?(this._socket.onmessage=this._onMessage,this._socket.onclose=this._onSocketClose,this._socket.onopen=this._onOpen,this._socket.onerror=this._onError):(this._socket.addEventListener("message",this._onMessage),this._socket.addEventListener("close",this._onSocketClose),this._socket.addEventListener("open",this._onOpen),this._socket.addEventListener("error",this._onError)),this._connectionFailedId=setTimeout(this._connectionFailed.bind(this),5e3)}}},{key:"_clearConnectionFailed",value:function(){this._connectionFailedId&&(clearTimeout(this._connectionFailedId),this._connectionFailedId=0)}},{key:"_connectionFailed",value:function(){this._connectionFailedId=0;var a="Websocket failed to connect to server";k.warn(a);try{this.isOpen=!1,this._removeSocketEvents(),this._socket.close(),this._socket=null}catch(a){}this._onError(new Error(a))}},{key:"_onOpen",value:function(){this._clearConnectionFailed(),this._isOpen()&&(this._lostConnectionCount=0,this.isOpen=!0,this.trigger("connected"),k.debug("Websocket Connected"),this._hasCounter?this.replayEvents(this._lastTimestamp,!0):this._reschedulePing())}},{key:"_isOpen",value:function(){return this._socket?"undefined"==typeof WebSocket?!0:this._socket&&this._socket.readyState===WebSocket.OPEN:!1}},{key:"_onError",value:function(a){this._closing||(this._clearConnectionFailed(),k.debug("Websocket Error causing websocket to close",a),this.isOpen?(this._onSocketClose(),this._socket.close(),this._socket=null):(this._removeSocketEvents(),this._lostConnectionCount++,this._scheduleReconnect()))}},{key:"sendSignal",value:function(a){this._socket.send(JSON.stringify({type:"signal",body:a}))}},{key:"getCounter",value:function(a){k.debug("Websocket request: getCounter"),this.client.socketRequestManager.sendRequest({method:"Counter.read"},function(b){k.debug("Websocket response: getCounter "+b.data.counter),a&&(b.success?a(!0,b.data.counter,b.fullData.counter):a(!1))})}},{key:"replayEvents",value:function(a,b,c){var d=this;a&&(b&&(this._inReplay=!1),"number"==typeof a&&(a=new Date(a).toISOString()),this._inReplay||!this._isOpen()?this._needsReplayFrom||(k.debug("Websocket request: replayEvents updating _needsReplayFrom"),this._needsReplayFrom=a):(this._inReplay=!0,k.info("Websocket request: replayEvents"),this.client.socketRequestManager.sendRequest({method:"Event.replay",data:{from_timestamp:a}},function(b){return d._replayEventsComplete(a,c,b.success)})))}},{key:"_replayEventsComplete",value:function(a,b,c){if(this._inReplay=!1,c&&!this._needsReplayFrom)k.info("Websocket replay complete"),this.trigger("synced"),b&&b();else if(c&&this._needsReplayFrom){k.info("Websocket replay partially complete");var d=this._needsReplayFrom;this._needsReplayFrom=null,this.replayEvents(d)}else k.info("Websocket replay retry"),this.replayEvents(a)}},{key:"_onMessage",value:function(a){this._lostConnectionCount=0;try{var b=JSON.parse(a.data),c=this._lastCounter+1!==b.counter;this._hasCounter=!0,this._lastCounter=b.counter,this._lastDataFromServerTimestamp=Date.now(),c?this.replayEvents(this._lastTimestamp):this._lastTimestamp=new Date(b.timestamp).getTime(),this.trigger("message",{data:b}),this._reschedulePing()}catch(b){k.error("Layer-Websocket: Failed to handle websocket message: "+b+"\n",a.data)}}},{key:"_reschedulePing",value:function(){this._nextPingId&&clearTimeout(this._nextPingId),this._nextPingId=setTimeout(this._ping.bind(this),this.pingFrequency)}},{key:"_ping",value:function(){k.debug("Websocket ping"),this._nextPingId=0,this._isOpen()&&this.getCounter(this._reschedulePing.bind(this))}},{key:"close",value:function(){k.debug("Websocket close requested"),this._closing=!0,this.isOpen=!1,this._socket&&(this._onSocketClose(),this._socket.close(),this._socket=null)}},{key:"send",value:function(a){this._socket.send(JSON.stringify(a))}},{key:"destroy",value:function(){this.close(),this._nextPingId&&clearTimeout(this._nextPingId),h(Object.getPrototypeOf(c.prototype),"destroy",this).call(this)}},{key:"_onSocketClose",value:function(){k.debug("Websocket closed"),this.isOpen=!1,this._closing||this._scheduleReconnect(),this._removeSocketEvents(),this.trigger("disconnected")}},{key:"_removeSocketEvents",value:function(){"undefined"!=typeof WebSocket&&this._socket?(this._socket.removeEventListener("message",this._onMessage),this._socket.removeEventListener("close",this._onSocketClose),this._socket.removeEventListener("open",this._onOpen),this._socket.removeEventListener("error",this._onError)):this._socket&&(this._socket.onmessage=null,this._socket.onclose=null,this._socket.onopen=null,this._socket.onerror=null)}},{key:"_scheduleReconnect",value:function(){if(!this.isDestroyed&&this.client.isOnline){var a=(this.client.onlineManager.pingFrequency-1e3)/1e3,b=j.getExponentialBackoffSeconds(a,Math.min(15,this._lostConnectionCount));k.debug("Websocket Reconnect in "+b+" seconds"),this._reconnectId=setTimeout(this.connect.bind(this),1e3*b)}}}]),c}(i);l.prototype.isOpen=!1,l.prototype._reconnectId=0,l.prototype._connectionFailedId=0,l.prototype._lastTimestamp=0,l.prototype._lastDataFromServerTimestamp=0,l.prototype._lastCounter=null,l.prototype._hasCounter=!1,l.prototype._inReplay=!1,l.prototype._needsReplayFrom=null,l.prototype.pingFrequency=3e4,l.prototype.client=null,l.prototype._socket=null,l.prototype._closing=!1,l.prototype._lostConnectionCount=0,l._supportedEvents=["message","connected","disconnected","syncing","synced"].concat(i._supportedEvents),i.initClass.apply(l,[l,"SocketManager"]),b.exports=l},{"../client-utils":7,"../logger":14,"../root":20,websocket:3}],32:[function(a,b,c){"use strict";function d(a){if(!a)return{};var b=a.split(","),c={};return b.forEach(function(a){var b=a.split(";");if(2===b.length){var d=b[0].replace(/<(.*)>/,"$1").trim(),e=b[1].replace(/rel='?(.*)'?/,"$1").trim();c[e]=d}}),c}var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol?"symbol":typeof a},f="undefined"==typeof window?a("xhr2"):null;b.exports=function(a,c){var g=f?new f:new XMLHttpRequest,h=(a.method||"GET").toUpperCase(),i=function(){var f={"content-type":this.getResponseHeader("content-type")},g={status:this.status,success:this.status&&this.status<300,xhr:this},h=String(f["content-type"]).split(/;/)[0].match(/^application\/json/)||"json"===a.format;if("blob"===this.responseType||"arraybuffer"===this.responseType)g.data="function"==typeof this.response?this.responseText:this.response;else{if(h&&this.responseText)try{g.data=JSON.parse(this.responseText)}catch(a){g.data={code:999,message:"Invalid JSON from server",response:this.responseText},g.status=999}else g.data=this.responseText;b.exports.trigger({target:this,status:this.responseText||this.status?"connection:success":"connection:error"}),this.responseText||this.status?404===this.status&&"object"!==e(g.data)?g.data={id:"operation_not_found",message:"Endpoint "+(a.method||"GET")+" "+a.url+" does not exist",status:this.status,httpStatus:404,code:106,url:"https://developer.layer.com/docs/websdk"}:"string"==typeof g.data&&this.status>=400&&(g.data={id:"unknown_error",message:g.data,status:this.status,httpStatus:this.status,code:0,url:"https://developer.layer.com/docs/websdk"}):(g.status=408,g.data={id:"request_timeout",message:"The server is not responding please try again in a few minutes",url:"https://developer.layer.com/docs/websdk",code:0,status:408,httpStatus:408})}if(a.headers&&(a.headers.accept||"").match(/application\/vnd.layer\+json/)){var i=this.getResponseHeader("link");i&&(g.Links=d(i))}g.xhr=this,c&&c(g)};g.onload=i,g.onerror=g.ontimeout=i;var j=Object.keys(a.headers||{}),k={};j.forEach(function(b){"content-type"===b.toLowerCase()?k["content-type"]=a.headers[b]:k[b.toLowerCase()]=a.headers[b]}),a.headers=k;var l="";a.data&&("undefined"!=typeof Blob&&a.data instanceof Blob?l=a.data:a.headers&&(String(a.headers["content-type"]).match(/^application\/json/)||"application/vnd.layer-patch+json"===String(a.headers["content-type"]))?l="string"==typeof a.data?a.data:JSON.stringify(a.data):a.data&&"object"===e(a.data)?Object.keys(a.data).forEach(function(b){l&&(l+="&"),l+=b+"="+a.data[b]}):l=a.data),l&&"GET"===h&&(a.url+="?"+l),g.open(h,a.url,!0),a.timeout&&(g.timeout=a.timeout),a.withCredentials&&(g.withCredentials=!0),a.responseType&&(g.responseType=a.responseType),a.headers&&Object.keys(a.headers).forEach(function(b){return g.setRequestHeader(b,a.headers[b])});try{"GET"===h?g.send():g.send(l)}catch(a){}};var g=[];b.exports.addConnectionListener=function(a){return g.push(a)},b.exports.trigger=function(a){g.forEach(function(b){b(a)})}},{xhr2:3}]},{},[1])(1)});